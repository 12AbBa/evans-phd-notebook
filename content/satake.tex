\chapter{Transfer}
\section{Reminders}
\subsection{Hecke algebra}
In general, if $G$ is a unimodular locally compact topological group,
and $K$ is a closed subgroup, then we can define the \emph{Hecke algebra} by
\[ \HH(G, K) \coloneqq \QQ[K \backslash G \slash K] \]
i.e.\ as the space of compactly supported $K$-binvariant locally constant functions on $G$.
Given two such functions $\phi_1$ and $\phi_2$, one can consider define the convolution
\[ (\phi_1 \ast \phi_2)(g) \coloneqq \int_G \phi_1(g\inv x) \phi_2(x) \; \odif x \]
which makes $\HH(G, K)$ into a $\QQ$-algebra,
whose identity element is $\mathbf{1}_K$.
In the case where $G$ is a reductive Lie group and
$K$ is the maximal compact subgroup
(or more generally whenever $(G,K)$ is a Gelfand pair),
this Hecke algebra is actually commutative.

\subsection{Satake transform}
We state a general form of the Satake transformation, which will be used later.

For this section, $G$ will denote an arbitrary connected reductive group
over some non-Archimedean local field $F$.
We will not distinguish between $G$ and $G(F)$ when there is no confusion.

To simplify things, we will assume $G$ is unramified;
but we do \emph{not} assume $G$ is split.
Introduce the following notation:
\begin{itemize}
  \ii Let $K$ be a hyperspecial maximal compact subgroup of $G$
  (it exists because $G$ is unramified).
  \ii Let $A$ denote a maximal $F$-split torus in $G$.
  All the maximal $F$-split tori in $G$ are conjugate; let $A$ denote one of them.
  \ii Let $M$ be the centralizer of $A$; this is itself a maximal torus in $G$.
  \ii Let $\prescript{\circ}{} M \coloneqq M(F) \cap K$
  be the maximal compact subgroup of $M$.
  \ii Let $P$ denote a minimal $F$-parabolic containing $A$.
  \ii Let $\delta$ denotes the modulus character of $P$.
  \ii Let $N$ denote the unipotent radical of $P$.
  \ii Let $W$ be the relative Weyl group for the pair $(G,A)$,
  which acts on $\HH(M, \prescript{\circ}{} M)$.
\end{itemize}
We can now state the Satake isomorphism.
\begin{definition}
  The \emph{Satake transform} is a canonical isomorphism of Hecke algebras
  \[ \Sat \colon \HH(G, K) \to \HH(M, \prescript{\circ}{} M)^W \]
  which is given by defining
  \[ (\Sat(f))(t) \coloneqq \delta(t)^\half \int_N f(nt) \odif n  \]
  for each $t \in M$.
\end{definition}
We are going to apply this momentarily in two situations:
once when $G$ is the general linear group (which is split),
and once when $G$ is a unitary group.

\subsection{Modulus character}
Let $\varpi$ denote a uniformizer for $F$ and $q$ the residue characteristic.
In general, if $\rho$ is the Weyl vector and $\mu$ is a positive cocharacter, then
\[ \delta(\mu(\varpi)) = q^{- \left< \mu, \rho\right>}. \]
\todo{does this help for unitary group}

\section{Setup}
Although our paper is primarily interested in the case $n=3$,
we provide the notes for this section for general $n$.

\subsection{Notation}
Retain all the notation of \Cref{sec:orbital_background}.
Moving forward we also fix the following notation:
\begin{itemize}
  \ii Set $G' \coloneqq \GL_n(E)$.
  \ii Set $K' \coloneqq \GL_n(\OO_E) \subseteq G$ as the hyperspecial maximal compact subgroup of $G$.
  \ii $V_0$ denotes a split $E/F$-Hermitian space of dimension $n$.
  \ii Let $\beta$ denote the $n \times n$ antidiagonal matrix
  \[ \beta \coloneqq \begin{bmatrix} && 1 \\ & \iddots \\ 1 \end{bmatrix} \]
  and pick the basis of $V_0$ such that the Hermitian form on $V_0$ is given by
  \[ V_0 \times V_0 \to E \qquad (x,y) \mapsto x^\ast \beta y. \]
  \ii Set $G \coloneqq \U(V_0) = \{ g \in \GL_n(\OO_E) \mid g^\ast \beta g = \beta\}$
  the unitary group over $V_0$.
  (Note that $\beta$ is \emph{antidiagonal},
  in contrast to the convention $\beta = \id_n$
  that is often used for unitary matrices with entries in $\CC$.)
  \ii Set $K \coloneqq G \cap \GL_n(\OO_E)$ is the natural hyperspecial maximal compact subgroup.
  \ii The symmetric space
  \[ S_n(F) \coloneqq \left\{ g \in \GL_n(E) \mid g \bar g = \id_n \right\}. \]
  is the obvious generalization of $S_3(F)$ defined in \Cref{sec:orbital_background}.
  \ii Denote by $\rproj \colon G' \surjto S_n(F)$ the projection defined by
  \[ \rproj(g) \coloneqq g \bar{g}\inv. \]
  \ii $K'_S \coloneqq S_n(F) \cap \GL_n(\OO_F)$ is as before.
  \ii $\Sym(n)$ denotes the symmetric group in $n$ variables with order $n!$
  (since $S_n$ is already reserved for the symmetric space).
\end{itemize}

\subsection{Two Hecke algebras, and a module}
We define two Hecke algebras:
\begin{align*}
  \HH(G', K') &\coloneqq \HH(\GL_n(E), \GL_n(\OO_E)) \\
  \HH(G, K) &\coloneqq \HH(\U(V_0), \U(V_0) \cap \GL_n(\OO_E))
\end{align*}
Now the symmetric space $S_n(F)$ is not a group,
so it does not make sense to define the same thing here.
Nevertheless, we introduce
\[ \HH(S_n(F), K') \coloneqq \mathcal C_{\mathrm{c}}^{\infty}(S_n(F))^{K'} \]
as the set of smooth compactly supported functions on $S_n(F)$
which are invariant under the action of $K' \subseteq G'$;
this is an $\HH(G', K')$-module.
This does \textbf{not} have a multiplication structure at the moment, \emph{a priori},
although later we will see how one could be imposed.

Our prior map $\rproj \colon G' \surjto S_n(F)$ induces a map
\begin{align*}
  \rproj_\ast \colon \HH(G', K') &\to \HH(S_n(F), K') \\
  \rproj_\ast(f')\left( g\bar{g}\inv \right) &= \int_{\GL_n(F)} f'(gh) \odif h
\end{align*}
by integration on the fibers.
%However, in our setting we actually consider a twisted version
%\begin{align*}
%  \rproj_\ast^\eta \colon \HH(G', K') &\to \HH(S_n(F), K') \\
%  \rproj_\ast^\eta(f')\left( g\bar{g}\inv \right) &= \int_{\GL_n(F)} f'(gh) \eta(gh) \odif h
%\end{align*}
%where as before $\eta(g) = (-1)^{v(\det g)}$ in a slight abuse of notation.

\subsection{Satake transformation for $\HH(G',K')$ and $\HH(G,K)$}
We introduce more notation.
To take the Satake transform of $\HH(G', K')$, we define the following abbreviations.
\begin{itemize}
  \ii Let $T$ denote the split diagonal torus of $\GL_n$.
  \ii Let
  \[ N' \coloneqq \left\{ \begin{bmatrix}
      1 & \ast & \dots & \ast \\
        & 1 & \dots & \ast \\
        &   & \ddots & \vdots \\
        &   &   & 1 \end{bmatrix}\right\} \subseteq G' \]
  denote the unipotent upper-triangular matrices.
\end{itemize}
Similarly for $\HH(G, K)$:
\begin{itemize}
  \ii Set $m \coloneqq \left\lfloor n/2 \right\rfloor$ for brevity.
  \ii Let
  \[ A \coloneqq \left\{
    \diag(x_1, \dots, x_m, 1_{n-2m}, x_m\inv, \dots, x_1\inv) \right\} \]
  so that $A(F)$ is a maximal $F$-split torus of $G$.
  \ii Let $N \coloneqq N' \cap G$ denote the unipotent upper triangular matrices
  which are also unitary.
  \ii For brevity, let $W_m \coloneqq (\ZZ/2\ZZ)^m \rtimes \Sym(m)$
  be the relative Weyl group of $(G,A)$.
\end{itemize}

We can now introduce the Satake transform for our two
\emph{bona fide} Hecke algebras, using the data in Table~\ref{tab:satakestuff}.

\begin{table}
  \centering
  \begin{tabular}{lcc}
    Group & $G' = \GL_n(E)$ & $G = \U(V_0)$ \\ \hline
    Local field & $E$ & $F$ \\
    Hyperspecial & $K' = \GL_n(\OO_E)$ & $K = G \cap \GL_n(\OO_E)$ \\
    Max'l split torus & $T(E)$ & $A(F)$ \\
    Centralizer of split torus & $T(\OO_E)$ & $A(\OO_F)$ \\
    Parabolic (Borel) & Upper tri in $G'$ & Upper tri in $G$ \\
    Unipotent rad.\ of parabolic & $N'$ (unipotent upper tri) & $N$ (unipotent upper tri)  \\
    Relative Weyl group & $\Sym(n)$ & $W_m = (\ZZ/2\ZZ)^m \rtimes \Sym(m)$ \\
    %Cocharacter group & $\ZZ^{\oplus n}$ & $\ZZ^{\oplus m}$?? \\
    %Weyl vector & $\left< \frac{n-1}{2}, \frac{n-3}{2}, \dots, -\frac{n-1}{2} \right>$
    %            & $\left< \frac{m-1}{2}, \frac{m-3}{2}, \dots, -\frac{m-1}{2} \right>$??
  \end{tabular}
  \caption{Data needed to run the Satake transformation.}
  \label{tab:satakestuff}
\end{table}
%\todo{please audit this table}

Hence, the Satake transformations obtained can be viewed as
\begin{align*}
  \Sat &\colon \HH(G', K') \xrightarrow{\sim} \QQ[T(E) / T(\OO_E)]^{\Sym(n)} \\
  \Sat &\colon \HH(G, K)\xrightarrow{\sim} \QQ[A(F) / A(\OO_F)]^{W_m}
\end{align*}
(In both cases, the modular character $\delta^{1/2}$ gives rational values,
so it is okay to work over $\QQ$.)

To make this further concrete, we remark that the cocharacter groups
involved are free abelian groups with known bases.
This identification lets us rewrite the right-hand sides above as concrete polynomials.
Specifically, we identify
\[ \QQ[T(E) / T(\OO_E)]^{\Sym(n)}
  \xrightarrow{\sim} \QQ[X_1^\pm, \dots, X_n^\pm]^{\Sym(n)} \]
by identifying $X_i$ with the
cocharacter corresponding to injection into the $i$\ts{th} factor.
Similarly, we identify
\[ \QQ[A(F) / A(\OO_F)]^{W_m}
  \xrightarrow{\sim} \QQ[Y_1^{\pm}, \dots, Y_m^{\pm}]^{W_m} \]
by identifying $Y_i + Y_i^{-1}$
with the cocharacter corresponding to
\[ x \mapsto \diag(1, \dots, x, \dots, x\inv, \dots, 1) \]
where $x$ is in the $i$\ts{th} position and $x\inv$ is in the $(n-i)$\ts{th} position,
and all other positions are $1$.
Here $\QQ[Y_1^{\pm}, \dots, Y_m^{\pm}]^{W_m}$
denotes the ring of symmetric polynomials in $Y_i + Y_i^{-1}$.

So, henceforth, we will consider
\begin{align*}
  \Sat &\colon \HH(G', K') \xrightarrow{\sim}\QQ[X_1^\pm, \dots, X_n^\pm]^{\Sym(n)} \\
  \Sat &\colon \HH(G, K)\xrightarrow{\sim} \QQ[Y_1^{\pm}, \dots, Y_m^{\pm}]^{W_m}.
\end{align*}

\subsection{Base change}
\todo{this section needs to be written}

We don't have to twist since $n$ is odd.

\subsection{Overall picture}
\begin{center}
\begin{tikzcd}
  & \HH(G',K') \ar[ld, "\rproj_\ast"'] \ar[r, "\sim"', "\Sat"] \ar[d, "\BC"]
    & \QQ[X_1^\pm, \dots, X_n^\pm]^{\Sym(n)} \ar[d, "\BC"] \\
  \HH(S_n(F), K') \ar[r, "\sim"', "\BC_S"]
    & \HH(G,K) \ar[r, "\sim"', "\Sat"]
    & \QQ[Y_1^\pm, \dots, Y_n^\pm]^{W_m}
\end{tikzcd}
\end{center}
Goal: describe $\BC_S$.

\todo{describe this}

\section{Initial calculation on the diagram}
Specialize now to $n=3$.
Throughout this section, we use the shorthand
\[ \varpi^{(n_1, n_2, n_3)} \coloneqq \diag(\varpi^{n_1}, \varpi^{n_2}, \varpi^{n_3}). \]

As a $\QQ$-module, the spaces $\HH(G,K)$ and $\HH(S_n(F), K')$
have a canonical basis of indicator functions indexed by $\ZZ$:
\begin{itemize}
  \ii $\HH(S_n(F), K')$ has $\QQ$-module basis $\mathbf{1}_{K'_{S,j}}$ for $j \ge 0$.
  \ii $\HH(G,K)$ has a $\QQ$-module basis given by the indicator functions
  \[ \mathbf{1}_{\varpi^{-r} \Mat(\OO_E) \cap G} \]
  for $r \ge 0$.
\end{itemize}
On the other hand, the natural $\QQ$-module basis for $\HH(G', K')$, namely
\[ \mathbf{1}_{K'\varpi^{(n_1, n_2, n_3)}K'} \]
is given by triples of integers $n_1 \ge n_2 \ge n_3 \ge 0$, and is much larger.
So explicit calculations for the $\rproj_\ast$ or the Satake transforms viewed in
$\CC[X_1, X_2, X_3]^{\Sym(n)}$ is nontrivial if one works with the entire basis.
Hence the overall strategy, to reduce the amount of work we have to do,
is to focus on on the only the $\ZZ$-indexed elements
\[
  \mathbf{1}_{\Mat_3(\OO_E), v\circ\det=r}
  = \sum_{\substack{n_1 \ge n_2 \ge n_3 \\ n_1 + n_2 + n_3 = r}}
  \mathbf{1}_{K'\varpi^{(n_1, n_2, n_3)}K'} \in \HH(G', K').
\]
This aggregated indicator function is easier to compute,
because given an explicit matrix it is somewhat easier
to evaluate $\mathbf{1}_{\Mat_3(\OO_E), v\circ\det=r}$
at it (one only needs to check it has $\OO_E$ entries
and that the determinant has valuation $r$,
rather than determining the exact coset $K'\varpi^{(n_1, n_2, n_3)}K'$).

\subsection{Integration over fiber}
\begin{proposition}
  For every integer $r \ge 0$, we have
  \begin{align*}
    &\rproj_\ast(\mathbf{1}_{\Mat_3(\OO_E), v\circ\det=r}) \\
    &= \sum_{j=0}^r \left(
      \sum_{i=0}^{2(r-j)} \min \left( 1 + \left\lfloor \frac i2 \right\rfloor,
        1 + \left\lfloor \frac{2(r-j)-i}{2} \right\rfloor \right) q^i \right)
        \mathbf{1}_{K'_{S,j}}.
  \end{align*}
\end{proposition}
\begin{proof}
  The coefficient of $\mathbf{1}_{K'_{S,j}}$ will be equal to
  the evaluation of the integral at any $g$ such that $g\bar{g} \in K'_{S,j}$.
  Fixing $j \ge 0$, we are going to take the choice
  \[
    g = \begin{bmatrix}
      1 &   & \varpi^{-j} \sqrt{\eps} \\
      & 1 \\
      &   & 1
    \end{bmatrix}.
  \]
  We need to check this choice of $g$ indeed satisfies $g\bar{g}\inv \in K'_{S,j}$.
  This follows as
  $\bar{g} = \left[ \begin{smallmatrix} 1 &   & -\varpi^{-j} \sqrt{\eps} \\ & 1 \\ &   & 1 \end{smallmatrix} \right]$
  implies
  $\bar{g}\inv = \left[ \begin{smallmatrix} 1 &   & \varpi^{-j} \sqrt{\eps} \\ & 1 \\ &   & 1 \end{smallmatrix} \right]$
  and therefore
  \[
    g\bar{g}\inv = \begin{bmatrix}
      1 &   & 2\varpi^{-j} \sqrt{\eps} \\
      & 1 \\
      &   & 1
    \end{bmatrix} \in K'_{S,j}
  \]
  as needed.

  Having chosen the representative $g$, we aim to calculate the right-hand side of
  \[
    \rproj_\ast(\mathbf{1}_{\Mat_3(\OO_E), v\circ\det=r})(g\bar{g})
    = \int_{h \in \GL_3(F)} \mathbf{1}_{\Mat_3(\OO_E), v\circ\det=r}(gh) \odif h.
  \]
  We take an Iwasawa decomposition of $h \in \GL_3(F)$ as
  \[
    h =
    \begin{bmatrix} x_1 \\ & x_2 \\ && x_3 \end{bmatrix}
    \begin{bmatrix} 1 & y_1 & y_2 \\ & 1 & y_3 \\ & & 1 \end{bmatrix}
    k
  \]
  for $k \in \GL_3(\OO_F) \subseteq K'$, which does not affect the indicator function.
  Here $x_1, x_2, x_3 \in F^\times$ and $y_1, y_2, y_3 \in F$.
  In that case, note that
  \begin{align*}
    gh
    &=
    \begin{bmatrix}
      1 &   & \varpi^{-j}\sqrt\eps \\
      & 1 \\
      &   & 1
    \end{bmatrix}
    \begin{bmatrix} x_1 \\ & x_2 \\ && x_3 \end{bmatrix}
    \begin{bmatrix} 1 & y_1 & y_2 \\ & 1 & y_3 \\ & & 1 \end{bmatrix} k \\
    &=
    \begin{bmatrix}
      1 &   & \varpi^{-j}\sqrt\eps \\
      & 1 \\
      &   & 1
    \end{bmatrix}
    \begin{bmatrix} x_1 & x_1 y_1 & x_1 y_2 \\ & x_2 & x_2 y_3 \\ & & x_3 \end{bmatrix} k \\
    &=
    \begin{bmatrix}
      x_1 & x_1 y_1 & x_1 y_2 + x_3 \varpi^{-j} \sqrt\eps \\
      & x_2 & x_2 y_3 \\
      & & x_3
    \end{bmatrix}
    k.
  \end{align*}
  Hence, we can rewrite the $\rproj_\ast(\mathbf{1}_{\Mat_3(\OO_E), v\circ\det=r})$
  as a six-fold integral
  \begin{align*}
    \rproj_\ast(\mathbf{1}_{\Mat_3(\OO_E), v\circ\det=r}) =
    & \int_{x_1 \in F^\times} \int_{x_2 \in F^\times} \int_{x_3 \in F^\times}
    \int_{y_1 \in F} \int_{y_2 \in F} \int_{y_3 \in F} \\
    &\quad \mathbf{1}_{\Mat_3(\OO_E), v\circ\det=r} \left(
    \begin{bmatrix}
      x_1 & x_1 y_1 & x_1 y_2 + x_3 \varpi^{-j} \sqrt\eps \\
      & x_2 & x_2 y_3 \\
      & & x_3
    \end{bmatrix}
    \right) \\
    &\quad \odif[{\times,\times,\times}]{x_1,x_2,x_3,y_1,y_2,y_3}.
  \end{align*}
  Apparently the indicator function only depends on the valuations,
  so accordingly we rewrite the six-fold integral as a discrete sum over the valuations
  $\alpha_i \coloneqq v(x_i)$.
  Then the conditions are that
  \begin{align*}
    &\alpha_1 \ge 0, \quad \alpha_2 \ge 0, \quad \alpha_3 \ge j \\
    &v(y_1) \ge - \alpha_1, \quad v(y_2) \ge - \alpha_1, \quad v(y_3) \ge -\alpha_2.
  \end{align*}
  We have $\Vol(\varpi^{\alpha_i} \OO_F^\times) = 1$
  and $\Vol(\varpi^{-\alpha_i} \OO_F) = q^{\alpha_i}$.
  Hence the integral can be rewritten as the discrete sum
  \begin{align*}
    \sum_{\substack{\alpha_1 + \alpha_2 + \alpha_3 = r \\ \alpha_1 \ge 0 \\ \alpha_2 \ge 0 \\ \alpha_3 \ge j}}
    q^{\alpha_1} \cdot q^{\alpha_1} \cdot q^{\alpha_2}
    &= \sum_{\substack{\alpha_1 + \alpha_2 \le r-j \\ \alpha_1 \ge 0 \\ \alpha_2 \ge 0}}
    q^{2\alpha_1+\alpha_2} \\
    &= \sum_{i=0}^{2(r-j)}
    \min \left( 1 + \left\lfloor \frac i2 \right\rfloor,
      1 + \left\lfloor \frac{2(r-j)-i}{2} \right\rfloor
    \right) q^i
  \end{align*}
  as desired.
\end{proof}

\subsection{Satake transform of the determinant characteristic function on the top arrow}
\begin{proposition}
  For every integer $r \ge 0$, we have
  \[ \Sat(\mathbf{1}_{\Mat_3(\OO_E), v\circ\det=r})
    = q^{2r} \sum_{n_1 + n_2 + n_3 = r} X_1^{n_1} X_2^{n_2} X_3^{n_3}. \]
\end{proposition}
\begin{proof}
  We evaluate the coefficient $X_1^{n_1} X_2^{n_2} X_3^{n_3}$.
  Choose a cocharacter $\mu$,
  and suppose $\mu(\varpi) = \varpi^{(n_1, n_2, n_3)}$ with $n_1 \ge n_2 \ge n_3$.
  Let $q_E = q^2$ be the residue characteristic of $E$.
  Take the upper triangular matrices as our Borel subgroup as usual,
  so the unipotent radical of this Borel subgroup
  are the unipotent upper triangulars $N'$ which we describe as
  \[ N' \coloneqq \left\{ \begin{bmatrix}
      1 & y_1 & y_2 \\
        & 1 & y_3 \\
        &   & 1 \end{bmatrix} \mid y_1, y_2, y_3 \in E \right\} \]
  and with additive Haar measure is $\odif{y_1,y_2,y_3}$.
  Recall also the Weyl vector for $G' = \GL_3(\OO_E)$ is just $\left< 1,0,-1\right>$.
  Compute
  \begin{align*}
    &\Sat(\mathbf{1}_{\Mat_3(\OO_E), v\circ\det=r})(\mu(\varpi)) \\
    &= \delta(\mu(\varpi))^\half \int_{n' \in N'}
      \mathbf{1}_{\Mat_3(\OO_E, v\circ \det = r)} (\mu(\varpi) n') \odif{n'} \\
    &= q_E^{-\left< \mu, \rho\right>} \int_{y_1 \in E} \int_{y_2 \in E} \int_{y_3 \in E} \\
    &\qquad
      \mathbf{1}_{\Mat_3(\OO_E), v \circ \det = r}
      \left(
        \begin{bmatrix}
          \varpi^{n_1} & \varpi^{n_1} y_1 & \varpi^{n_1} y_2 \\
          & \varpi^{n_2} & \varpi^{n_2} y_3 \\
          & & \varpi^{n_3} \\
        \end{bmatrix}
      \right) \odif{y_1,y_2,y_3} \\
    &= q_E^{-(n_1-n_3)} \mathbf{1}_{n_1+n_2+n_3=r}
    \int_{y_1 \in E} \int_{y_2 \in E} \int_{y_3 \in E} \\
    &\quad \mathbf{1}_{\OO_E}(\varpi^{n_1} y_1) \odif y_1
      \mathbf{1}_{\OO_E}(\varpi^{n_1} y_2) \odif y_2
     \mathbf{1}_{\OO_E}(\varpi^{n_2} y_3) \odif y_3 \\
    &= q_E^{-(n_1-n_3)} q_E^{n_1} q_E^{n_1} q_E^{n_2} \mathbf{1}_{n_1+n_2+n_3=r}
    = q_E^{n_1+n_2+n_3}\mathbf{1}_{n_1+n_2+n_3=r}
    = q_E^{r}\mathbf{1}_{n_1+n_2+n_3=r} \\
    &= \begin{cases}
      q^{2r} & \text{if }n_1 + n_2 + n_3 = r \\
      0 & \text{otherwise}.
    \end{cases}
  \end{align*}
  This gives the sum claimed earlier.
\end{proof}

\subsection{Satake transform of the indicator on the bottom arrow}
\begin{proposition}
  For each $r \ge 0$ we have
  \[ \Sat\left(\mathbf{1}_{\varpi^{-r} \Mat_3(\OO_E) \cap G}\right)
    = \sum_{i=0}^r q^{2r - \mathbf{1}_{r \equiv i \bmod 2}} Y_1^{\pm i} \]
  where we adopt the shorthand
  \[
    Y_1^{\pm i} \coloneqq
    \begin{cases}
      Y_1^i + Y_1^{-i} & i > 0 \\
      1 & i = 0 .
    \end{cases}
  \]
\end{proposition}
\begin{proof}
  We first need to describe \[ N = N' \cap G \] a little more carefully.
  For $n \in N'$ we have
  \[
    n^\ast \beta n
    =
    \begin{bmatrix} 1 \\ \bar{y_1} & 1 \\ \bar{y_2} & \bar{y_3} & 1 \end{bmatrix}
    \beta
    \begin{bmatrix}
      1 & y_1 & y_2 \\
        & 1 & y_3 \\
        & & 1
    \end{bmatrix}
    = \begin{bmatrix}
      & & 1 \\
      & 1 & y_3 + \bar{y_1} \\
      1 & y_1 + \bar{y_3} & y_2 + \bar{y_2} + y_3 \bar{y_3}
    \end{bmatrix}.
  \]
  So $n \in N$ if and only if the above matrix equals $\beta$, which means
  \[ 0 = y_3 + \bar{y_1} = y_2 + \bar{y_2} + y_3 \bar{y_3}. \]
  Then we can re-parametrize by $z_1, z_2, z_3 \in F$ according to
  \begin{align*}
    y_3 &= z_1 + z_2 \sqrt\eps \\
    y_2 &= -\frac{z_1^2 + z_2^2 \eps}{2} + z_3\sqrt\eps \\
    y_1 &= -z_1 + z_2\sqrt\eps.
  \end{align*}
  Back to the original task.
  For each $i \ge 0$ we can evaluate the Satake transform at the element
  $\nu(\varpi) = \diag(\varpi^i, 1, \varpi^{-i})$, for the cocharacter $\nu$
  corresponding to $Y_1^i + Y_1^{-i}$:
  \begin{align*}
    &\Sat\left( \mathbf{1}_{\varpi^{-r} \Mat_3(\OO_E) \cap G}\right)
      \left( \nu(\varpi)  \right) \\
    &= \delta(\nu(\varpi))^\half \int_{n \in N}
      \mathbf{1}_{\varpi^{-r} \Mat_3(\OO_E) \cap G}
      \left( \nu(\varpi) n' \right) \odif n \\
    &= \delta(\nu(\varpi))^\half \int_{n \in N}
      \mathbf{1}_{{\varpi^{-r}} \Mat_3(\OO_E) \cap G}
      \left( \begin{bmatrix} \varpi^i & \varpi^i y_1 & \varpi^i y_2 \\
               & 1 & y_3 \\
               & & \varpi^{-i} \end{bmatrix} \right) \odif n
  \end{align*}
  The matrix itself is always in $G$, because it's the product of two unitary matrices.
  So the indicator needs to check whether all the entries have valuation at least $-r$.
  If we switch characterization to the coordinates $z_1$, $z_2$, $z_3$ we described earlier,
  we see that the conditions are
  \[ i \le r, \; v(z_1) \ge -r, \; v(z_2) \ge -r, \; v(z_3) \ge -(r+i), \;
    v(z_1^2 + z_2^2 \eps) \ge -(r+i). \]
  Assume $i \le r$ henceforth.
  The condition for $z_1$ and $z_2$ then really says
  \[ \min(v(z_1), v(z_2)) \ge -\left\lfloor \frac{r+i}{2} \right\rfloor. \]
  So the integral factors as a triple integral
  \[
    \int_{z_1 \in F}
    \int_{z_2 \in F}
    \int_{z_3 \in F}
    \mathbf{1}_{\varpi^{-\left\lfloor \frac{r+i}{2} \right\rfloor} \OO_F}(z_1)
    \mathbf{1}_{\varpi^{-\left\lfloor \frac{r+i}{2} \right\rfloor} \OO_F}(z_2)
    \mathbf{1}_{\varpi^{-(r+i)} \OO_F}(z_3)
    \odif{z_1,z_2,z_3}
  \]
  which is equal to
  \[ q^{2\left\lfloor \frac{r+i}{2} \right\rfloor+r+i}. \]
  Meanwhile, $\delta(\nu(\varpi))^{\half} = q^{-2i}$.
  In summary,
  \[
    \Sat\left( \mathbf{1}_{\varpi^{-r} \Mat_3(\OO_E) \cap G}\right) \left( \nu(\varpi) \right)
    =
    \begin{cases}
      q^{2\left\lfloor \frac{r+i}{2} \right\rfloor - i + r} & i \le r \\
      0 & i > r
    \end{cases}
  \]
  Finally, since
  \[ 2\left\lfloor \frac{r+i}{2} \right\rfloor - i + r
    = \begin{cases}
      2r & r+i \text{ is even} \\
      2r-1 & r+i \text{ is odd}
    \end{cases}
  \]
  we get the formula claimed.
\end{proof}

\section{Base change from $\HH(G,K)$ to $\HH(S_3(F), K')$}
We first need to determine an element of $\HH(G,K)$
which is in the pre-image of $\mathbf{1}_{\varpi^{-r} \Mat_3(\OO_E) \cap G}$
under $\BC \colon \HH(G', K') \to \HH(G, K)$.

For convenience, we define the shorthand
\[
  \HH(G',K') \ni
  f'_r \coloneqq \begin{cases}
    \mathbf{1}_{\Mat_3(\OO_E), v \circ \det = r} & r \ge 0 \\
    0 & r < 0
  \end{cases}
\]
for every integer $r$.
We start with the following intermediate calculation.
\begin{align*}
  &\BC\left( \Sat \left( f'_r - q^2 f'_{r-1} \right) \right) \\
  &= \BC \left(
    q^{2r} \sum_{n_1+n_2+n_3=r} X_1^{n_1} X_2^{n_2} X_3^{n_3}
    - q^2 \cdot q^{2(r-1)} \sum_{n_1+n_2+n_3=(r-1)} X_1^{n_1} X_2^{n_2} X_3^{n_3} \right) \\
  &= q^{2r} \left( \sum_{n_1+n_2+n_3=r} Y_1^{n_1-n_3} - \sum_{n_1+n_2+n_3=(r-1)} Y_1^{n_1-n_3} \right) \\
  &= q^{2r} \left( \sum_{n_1+n_3=r} Y_1^{n_1-n_3} \right) \\
  &= q^{2r} \left( Y_1^{r} + Y_1^{r-2} + \dots + Y_1^{-r} \right).
  \intertext{Replacing $r$ with $r-1$ gives}
  &\BC\left( \Sat \left(f'_{r-1} - q^2 f'_{r-2} \right) \right) \\
  &= q^{2r-2} \left( Y_1^{r-1} + Y_1^{r-3} + \dots + Y_1^{-(r-1)} \right)
  \intertext{Adding the former equation to $q$ times the latter gives}
  &\BC\left( \Sat\left( f'_r + (q-q^2) f'_{r-1} - q^3 f'_{r-2} \right) \right) \\
  &= q^{2r} \left( Y_1^r + Y_1^{r-2} + \dots + Y_1^{-r} \right)
  + q^{2r-1} \left( Y_1^{r-1} + Y_1^{r-3} + \dots + Y_1^{-(r-1)} \right) \\
  &= \Sat(\mathbf{1}_{\varpi^{-r} \Mat_3(\OO_E) \cap G}).
\end{align*}
This shows that $f'_r + (q-q^2) f'_{r-1} - q^3 f'_{r-2}$ lies in the
pre-image of $\BC \colon \HH(G', K') \to \HH(G,K)$.

On the other hand, it is easy to check that
\begin{align*}
  &\rproj_\ast(f'_r -q^2 f'_{r-1}) \\
  &= \sum_{j=0}^r \Bigg[
      \sum_{i=0}^{2(r-j)} \min \left( 1 + \left\lfloor \frac i2 \right\rfloor,
      1 + \left\lfloor \frac{2(r-j)-i}{2} \right\rfloor \right) q^i \\
  &\qquad - \sum_{i=0}^{2(r-1-j)} \min \left( 1 + \left\lfloor \frac i2 \right\rfloor,
    1 + \left\lfloor \frac{2((r-1)-j)-i}{2} \right\rfloor \right) q^{i+2}
  \Bigg] \mathbf{1}_{K'_{S,j}} \\
  &= \sum_{j=0}^r \left[ 1+q+q^2+\dots+q^{r-j} \right] \mathbf{1}_{K'_{S,j}} \\
  \intertext{so}
  &\rproj_\ast(f'_r -q^2 f'_{r-1} + q \left( f'_{r-1} - q^2 f'_{r-3} \right)) \\
  &= \sum_{j=0}^r \left[ (1+q+q^2+\dots+q^{r-j})+(q+q^2+\dots+q^{r-j}) \right] \mathbf{1}_{K'_{S,j}} \\
  &= \sum_{j=0}^r \left[ 1 + 2q + 2q^2 + \dots + 2q^{r-j} \right] \mathbf{1}_{K'_{S,j}}.
\end{align*}
To summarize, the completed commutative diagram can be written in full as
\begin{center}
\begin{tikzcd}
  & \begin{tabular}{c} $f'_r + (q-q^2) f'_{r-1}$ \\ $- q^3 f'_{r-2} \in \HH(G',K')$ \end{tabular}
    \ar[ld, "\rproj_\ast"', mapsto] \ar[r, "\Sat", mapsto] \ar[d, "\BC", mapsto]
    & \dots \in \QQ[X_1^\pm, \dots, X_n^\pm]^{\Sym(n)} \ar[d, "\BC", mapsto] \\
  \begin{tabular}{c}
    $\sum_{j=0}^r \big[ 1 + 2q + 2q^2$ \\
    $+ \dots + 2q^{r-j} \big] \mathbf{1}_{K'_{S,j}}$ \\
    $\in \HH(S_n(F), K')$
  \end{tabular} \ar[r, "\sim", "\BC_S"', mapsto]
    & \begin{tabular}{c} $\mathbf{1}_{\varpi{^-r} \Mat_3(\OO_E) \cap G}$ \\ $\in \HH(G,K)$ \end{tabular}
    \ar[r, "\Sat", mapsto]
    & \begin{tabular}{r}
      $q^{2r} \left( Y_1^{\pm} + \dotsb \right)$ \\
      $+ q^{2r-1} \left( Y_1^{\pm(r-1)} + \dotsb \right)$ \\
      $\in \QQ[Y_1^\pm, \dots, Y_n^\pm]^{W_m}$
      \end{tabular}
\end{tikzcd}
\end{center}

Thus, we arrive at the following:
\begin{proposition}
  We have
  \begin{align*}
    \BC_S \left(
    \sum_{j=0}^r \left[ 1 + 2q + 2q^2 + \dots + 2q^{r-j} \right]
    \mathbf{1}_{K'_{S,j}} \right)
    &= \mathbf{1}_{\varpi^{-r} \Mat_3(\OO_E) \cap G} \\
    \BC_S \left(
    \mathbf{1}_{K'_{S,r}}
    + 2q \mathbf{1}_{K'_{S,r-1}}
    + 2q^2 \mathbf{1}_{K'_{S,r-2}}
    + \dots
    + 2q^r \mathbf{1}_{K'_{S,0}} \right)
    &= \mathbf{1}_{K\varpi^{(r,0,-r)}K}.
  \end{align*}
\end{proposition}
\begin{proof}
  The first equation is the one we just proved.
  The second one follows by noting that
  \[
    \mathbf{1}_{K\varpi^{(r,0,-r)}K}
    = \mathbf{1}_{\varpi^{-r} \Mat_3(\OO_E) \cap G}
    - \mathbf{1}_{\varpi^{-(r-1)} \Mat_3(\OO_E) \cap G}
  \]
  so one merely subtracts the left-hand sides evaluated at $r$ and $r-1$.
\end{proof}
