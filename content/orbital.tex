\chapter{Orbital integral}
\section{Background}
Let $F$ be a finite extension of $\QQ_p$ for $p > 2$ and
let $E/F$ be an unramified quadratic field extension.
Denote by $\varpi$ a uniformizer of $\OO_F$, such that $\bar \varpi = \varpi$,
and let $v$ be the associated valuation.
Let $\eta$ be the quadratic character attached to $E/F$ by class field theory,
so that $\eta(x) = -1^{v(x)}$.

\subsection{Symmetric space}
We define the symmetric space
\[ S_3(F) \coloneqq \left\{ s \in \GL_3(E) \mid s \bar s = \id \right\}. \]
We also pay particular attention to the subspace which have $\OO_E$ entries:
\[ K_S \coloneqq S_3(F) \cap \GL_3(\OO_E). \]
\begin{lemma}
  [Cartan decomposition]
  For each integer $m \ge 0$ let
  \[ K_{S,m} \coloneqq K_S \cdot \begin{bmatrix} 0 & 0 & \varpi^m \\ 0 & 1 & 0 \\ \varpi^{-m} & 0 & 0 \end{bmatrix}. \]
  Then we have a decomposition
  \[ S_3(F) = \coprod_{m \geq 0} K_{S,m}. \]
\end{lemma}
For $r \geq 0$, define
\[ \Omega_r \coloneqq S_3(F) \cap \varpi^{-m} \GL_3(\OO_E). \]
We can re-parametrize the problem according to the following claim.
\begin{claim}
  \[ \Omega_r = K_{S,0} \sqcup K_{S,1} \sqcup \dots \sqcup K_{S,r}. \]
\end{claim}
If this claim is true (still need to check it),
then an integral over each $\Omega_r$ lets us extract the integrals over $K_{S,m}$.

\subsection{Orbital integral}
Define
\[ H' \coloneqq
  \left\{ \begin{bmatrix} t_1 & t_2 \\ \bar t_2 & \bar t_1 \end{bmatrix} \right\}
  \cong \GL_2(F). \]
We embed $H'$ into $\GL_3(F)$ by
$h' \mapsto \left[ \begin{smallmatrix} h' & 0 \\ 0 & 1 \end{smallmatrix} \right]$,
which allows $H$ to act on $\GL_3(F)$ and hence $S_3(F)$.

Now we can define the orbital integral.
\begin{definition}
  For brevity let $\eta(h') \coloneqq \eta(\det h')$ for $h' \in H'$.
  For $\gamma \in S_3(F)$ and $s \in \CC$, we define the orbital integral by
  \[ O(\gamma, s) \coloneqq
    \int_{g \in H'} \mathbf{1}_{\Omega_r}(\bar g\inv \gamma g) \eta(g)
    \left\lvert \det(g) \right\rvert_F^{-s} \odif g \]
  where
  \[ \odif g = \kappa \cdot \frac{\odif t_1 \odif t_2}
    {\left\lvert t_1 \bar t_1 - t_2 \bar t_2 \right\rvert_F^2} \]
  for the constant $\kappa \coloneqq (1-q\inv)\inv(1-q^{-2})\inv$.
\end{definition}

Indeed, for $h' \in H$ and $\gamma \in S_3(F)$ we have $h' \gamma (\bar h')\inv \in S_3(F)$
and so the indicator function is filtering based on which part of the
Cartan decomposition that $h' \gamma (\bar h')\inv$ falls in.

Evidently $O(\gamma, s)$ only depends on the $H'$-orbit of $\gamma$.
So it makes sense to pick a canonical representative for the $H'$-orbit to compute
the orbital integral in terms of.
For so-called \emph{regular} $\gamma$, the representatives
\[ \gamma(a,b,d) =
  \begin{bmatrix}
    a & 0 & 0 \\
    b & - \bar d & 1 \\
    c & 1 - d \bar d & d
  \end{bmatrix}
  \in S_3(F); \quad \text{where $c = -a \bar b + b d$} \]
over all $a \in E^1$, $b \in E$, $d \in E$ for which $(1-d\bar d)^2 - c \bar c \neq 0$,
cover all the \emph{regular} orbits, which are the ones we care about.

For $r=0$, \cite{ref:AFL} computes $\pdv{}{s}O(\gamma,s)$ at $s=0$ in terms of $a$, $b$, $d$.
Our goal is to compute it for $r > 0$ too.

\section{Reparametrization in terms of valuations}
\subsection{Computation of value in indicator function}
We are integrating over $t_1 \in E$ and $t_2 \in E$.
Regarding $g \in H'$ as an element of $\GL_3$ as described before, we have
\[ g = \begin{bmatrix}
  t_1 & t_2 & 0  \\
  \bar t_2 & \bar t_1 & 0 \\
  0 & 0 & 1
  \end{bmatrix}. \]
We therefore have
\[ \bar g \inv = \begin{bmatrix}
  \frac{t_1}{t_1 \bar t_1 - t_2 \bar t_2} & \frac{-\bar t_2}{t_1 \bar t_1 - t_2 \bar t_2} & 0 \\
  \frac{-t_2}{t_1 \bar t_1 - t_2 \bar t_2} & \frac{\bar t_1}{t_1 \bar t_1 - t_2 \bar t_2} & 0 \\
  0 & 0 & 1 \end{bmatrix}. \]
Hence
\begin{align*}
  \bar g \inv \gamma g
  &=
  \begin{bmatrix}
  \frac{t_1}{t_1 \bar t_1 - t_2 \bar t_2} & \frac{-\bar t_2}{t_1 \bar t_1 - t_2 \bar t_2} & 0 \\
  \frac{-t_2}{t_1 \bar t_1 - t_2 \bar t_2} & \frac{\bar t_1}{t_1 \bar t_1 - t_2 \bar t_2} & 0 \\
  0 & 0 & 1 \end{bmatrix}
  \begin{bmatrix}
    a & 0 & 0 \\
    b & - \bar d & 1 \\
    c & 1 - d \bar d & d
  \end{bmatrix}
  \begin{bmatrix}
  t_1 & t_2 & 0  \\
  \bar t_2 & \bar t_1 & 0 \\
  0 & 0 & 1
  \end{bmatrix} \\
  &=
  \begin{bmatrix}
  \frac{t_1}{t_1 \bar t_1 - t_2 \bar t_2} & \frac{-\bar t_2}{t_1 \bar t_1 - t_2 \bar t_2} & 0 \\
  \frac{-t_2}{t_1 \bar t_1 - t_2 \bar t_2} & \frac{\bar t_1}{t_1 \bar t_1 - t_2 \bar t_2} & 0 \\
  0 & 0 & 1 \end{bmatrix}
  \begin{bmatrix}
    at_1 & at_2 & 0 \\
    bt_1 - \bar d \bar t_2 & b t_2 - \bar d \bar t_1 & 1 \\
    ct_1 + (1-d\bar d)\bar t_2 & ct_2 + (1-d \bar d) \bar t_1 & d
  \end{bmatrix}
  \\
  &=
  \begin{bmatrix}
    \dfrac{at_1^2 - bt_1 \bar t_2 + d \bar t_2^2}{t_1 \bar t_1 - t_2 \bar t_2}
    & \dfrac{at_1t_2 - bt_2 \bar t_2 + \bar d \bar t_1 \bar t_2}{t_1 \bar t_1 - t_2 \bar t_2}
    & \dfrac{-\bar t_2}{t_1 \bar t_1 - t_2 \bar t_2} \\[2ex]
    \dfrac{-at_1t_2+bt_1\bar t_1-\bar d \bar t_1 \bar t_2}{t_1 \bar t_1 - t_2 \bar t_2}
    & \dfrac{-at_2^2+b\bar t_1 t_2-d\bar t_1^2}{t_1 \bar t_1 - t_2 \bar t_2}
    & \dfrac{\bar t_1}{t_1 \bar t_1 - t_2 \bar t_2} \\[2ex]
    ct_1 + (1-d\bar d)\bar t_2 & ct_2 + (1-d \bar d) \bar t_1 & d
  \end{bmatrix}
\end{align*}
Let us define \[ t = t_2 \bar t_1 \inv \iff t_2 = t \bar t_1. \]
This lets us rewrite everything in terms of the ratio $t$ and $t_1 \in E$:
\[
  \bar g \inv \gamma g
  =
  \begin{bmatrix}
    \dfrac{t_1^2(a-b\bar t+\bar d \bar t^2)}{t_1 \bar t_1(1-t \bar t)}
    & \dfrac{t_1 \bar t_1(at-bt\bar t+\bar d \bar t)}{t_1 \bar t_1(1-t \bar t)}
    & \dfrac{t_1 \cdot (-\bar t)}{t_1 \bar t_1 (1-t \bar t)} \\[2ex]
    \dfrac{t_1\bar t_1(-at+b-\bar d \bar t)}{t_1 \bar t_1(1-t \bar t)}
    & \dfrac{\bar t_1^2(-at^2+bt-\bar d)}{t_1 \bar t_1(1-t \bar t)}
    & \dfrac{-\bar t_1}{t_1 \bar t_1(1-t \bar t)} \\[2ex]
    t_1(c + (1-d\bar d)\bar t) & \bar t_1(ct + (1-d \bar d)) & d
  \end{bmatrix}
\]
This new parametrization is better because $t_1$ only plays the role of
a scale factor on the outside, with ``interesting'' terms only involving $t$.
To make this further explicit, we write
\[ t_1 = \varpi^{-m} \eps \]
for $m \in \ZZ$ and $\eps \in \OO_E^\times$.
Then we actually have
\[
  \begin{bmatrix} \bar\eps \\ & \eps \\ & & 1 \end{bmatrix}
  \bar g \inv \gamma g
  \begin{bmatrix} \eps\inv \\ & \bar\eps\inv \\ & & 1 \end{bmatrix}
  =
  \begin{bmatrix}
    \dfrac{a-b\bar t+\bar d \bar t^2}{1-t \bar t}
    & \dfrac{at-bt\bar t+\bar d \bar t}{1-t \bar t}
    & \dfrac{-\varpi^m \bar t}{1-t \bar t} \\[2ex]
    \dfrac{-at+b-\bar d \bar t}{1-t \bar t}
    & \dfrac{-at^2+bt-\bar d}{1-t \bar t}
    & \dfrac{-\varpi^m}{1-t \bar t} \\[2ex]
    \dfrac{c + (1-d\bar d)\bar t}{\varpi^m} & \dfrac{ct + (1-d \bar d)}{\varpi^m} & d
  \end{bmatrix}
\]
For brevity, we will let $\Gamma(\gamma, t, m)$ denote the right-hand matrix.
The conjugation by
$\left[ \begin{smallmatrix} \eps\inv \\ & \bar\eps\inv \\ & & 1 \end{smallmatrix} \right]$
has no effect on any of the $\Omega_r$, so that we can simply use
\[ \mathbf{1}_{\Omega_r}(\bar g \inv \gamma g) = \mathbf{1}_{\Omega_r}(\Gamma(\gamma, t, m)) \]
in the work that follows.
By abuse of notation, we abbreviate
\[ \mathbf{1}(\gamma, t, m) \coloneqq \mathbf{1}_{\Omega_r}(\Gamma(\gamma, t, m)). \]

\subsection{Reparametrizing the integral in terms of $t$ and $m$}
From now on, following \cite{ref:AFL} we always fix the notation
\begin{align*}
  m &= m(t_1) \coloneqq -v(t_1) \\
  n &= n(t) \coloneqq v(1-t\bar t).
\end{align*}
We need to rewrite the integral, phrased originally via $\odif g$,
in terms of the parameters $t$ (hence $n$), $m$, and $\gamma$.
We start by observing that
\[ \det g = t_1 \bar t_1 - t_2 \bar t_2 = t_1 \bar t_1 (1 - t\bar t) \]
which means that
\[ v(\det g) = -2m + n \]
ergo
\begin{align*}
  \left\lvert \det g \right\rvert_F &= q^{-v(\det g)} = q^{2m-n} \\
  \eta(g) &= (-1)^{v(\det g)} = (-1)^n.
\end{align*}
Meanwhile, from $t_2 = t \bar t_1$ we derive
\[ \odif t_2 = \left\lvert t_1 \right\rvert_E \odif t = q^{2m} \odif t. \]

Bringing this all into the orbital integral gives
\begin{align*}
  O(\gamma, s) &= \kappa \int_{t, t_1 \in E} \mathbf{1}(\gamma, t, m)
  (-1)^n \left( q^{2m-n} \right)^{s-2} \odif t_1 \cdot (q^{2m} \odif t) \\
  &= \kappa \int_{t, t_1 \in E} \mathbf{1}(\gamma, t, m)
  (-1)^n q^{s(2m-n)} \cdot q^{2n-2m} \odif t \odif t_1.
\end{align*}

\section{Setup}
\subsection{Simplifying assumptions}
For the purposes of \cite{ref:AFL},
we will only care about the following case:
\begin{assume}
  \[ v\left( (1-d\bar d)^2 - c \bar c\right) \equiv 1 \pmod 2 \]
  \label{assume:implies_delta}
\end{assume}
We will also assume:
\begin{assume}
  $v(d) \geq -r$.
\end{assume}
This is fine because if this $v(d) < -r$ then the integral will always vanish
(because the bottom-right entry of $\Gamma(\gamma, t, m)$ is no-good).
Because of this, from \eqref{eq:b} we then get
\begin{corollary}
  $v(b) \geq -r$.
\end{corollary}

\subsection{Notations}
As we described earlier, our goal is to give an answer in terms of
\[ a \in E^1, \qquad b, d \in E, \qquad r > 0. \]
To simplify the notation in what follows,
it will be convenient to define several quantities that reappear frequently.
From \Cref{assume:implies_delta}, we may define
\begin{equation}
  \delta \coloneqq v(1-d \bar d) = v(c) \neq -\infty.
  \label{eq:delta}
\end{equation}
Following \cite{ref:AFL} we will also define
\begin{equation}
  u \coloneqq \frac{\bar c}{1-d \bar d} \in \OO_E^\times
  \label{eq:u}
\end{equation}
so that $\nu(1-u \bar u) \equiv 1 \pmod 2$ and
\begin{equation}
  b = -au - \bar{d} \bar{u}.
  \label{eq:b}
\end{equation}
Note that this gives us the following repeatedly used identity
\begin{equation}
  b^2-4a\bar d = (au-\bar d \bar u)^2 - 4a\bar d(1-u\bar u).
  \label{eq:dos}
\end{equation}
Finally, define
\begin{equation}
  \ell \coloneqq v(b^2 - 4 a \ol d).
  \label{eq:ell}
\end{equation}
We will also define one additional parameter useful when $\ell$ is even:
\begin{equation}
  \lambda \coloneqq v(1-u \bar u) \equiv 1 \pmod 2.
  \label{eq:lambda}
\end{equation}
In the case where $\ell$ is odd, we get \eqref{eq:dos} implying $\lambda = \ell$
and this definition will never be used --- the orbital will be computed
as a function of $\ell$ and $\delta$ (and $r$).
However for even $\ell$ these numbers are never equal and our orbital
integral will be stated in terms of $\ell$, $\delta$, and $\lambda$ (and $r$).

\section{Description of the nonzero regions}
\subsection{The case where $n \leq 0$}
\begin{claim}
  Whenever $n = 0$ (this requires $v(t) \geq 0$),
  \[
    \mathbf{1}(\gamma, t, m) =
    \begin{cases}
      1 & \text{if } -r \le m \le \delta+r \\
      0 & \text{otherwise.}
    \end{cases}
  \]
\end{claim}
\begin{proof}
  We have to consider the nine entries of $\Gamma(\gamma, t, m)$ in tandem.

  The upper $2 \times 2$ matrix is always in $\omega^{-r}\OO_E$,
  because $v(t) \geq 0$, $v(d) \geq -r$, $v(b) \geq -r$, and $v(a) = 0$ suffices.

  In the right column, since $v(t) \geq 0$ and $n = 0$, the condition is simply $m \ge -r$.

  In the bottom row, we need
  $v\left( c+(1-d\bar d) \bar t \right)-m \geq -r$
  and $v\left( ct +(1-d\bar d) \right)-m \geq -r$.
  If $v(t) > 0$ this is equivalent to $m-r \leq \delta$.
  In the case where $v(t) = 0$ we instead use the observation that
  \begin{equation}
    \left[ c + (1-d \bar d) \bar t \right]
    - \bar t \left[ ct + (1-d \bar d) \right] = (1-t\bar t) c
    \label{eq:ctrick}
  \end{equation}
  which forces at least one of $ct + (1-d \bar d)$ and $c + (1-d \bar d) \bar t$ to
  have valuation $\delta$. So the claim follows now.
\end{proof}

\begin{claim}
  Suppose $n = -2k < 0$, equivalently, $v(t) = -k < 0$, for some $k$.
  \[
    \mathbf{1}(\gamma, t, m) =
    \begin{cases}
      1 & \text{if } -r \le m+k \le \delta+r \\
      0 & \text{otherwise.}
    \end{cases}
  \]
\end{claim}
\begin{proof}
  The proof is similar to the previous claim, but simpler.

  Since $k > 0$, the fraction $\frac{t^2}{1-t \bar t}$ has positive valuation,
  so the upper $2 \times 2$ of $\Gamma(\gamma, t, m)$ is always in $\varpi^{-r}\OO_E$.
  Turning to the right column, the condition reads exactly $m+k \geq -r$.
  Finally, in the bottom row, from $v(t) > 0$ and $v(c) = \delta$
  the condition is simply $-k+\delta-m \geq -r$.
\end{proof}


\subsection{Setup for $n > 0$}
In this situation we evaluate over $n > 0$ only.
In this case $t$ is automatically a unit.

Consider the upper $2 \times 2$ matrix of $\Gamma(\gamma, t, m)$.
Using the identities
\begin{align*}
  \dfrac{a-b\bar t+\bar d \bar t^2}{1-t \bar t}
    - \bar t \cdot \dfrac{at-bt\bar t+\bar d \bar t}{1-t \bar t}
    &= a-b\bar t \in \varpi^{-r} \OO_E \\[2ex]
  \dfrac{a-b\bar t+\bar d \bar t^2}{1-t \bar t}
    + \bar t \cdot \dfrac{-at+b-\bar d \bar t}{1-t \bar t}
    &= a \in \varpi^{-r} \OO_E \\[2ex]
  \dfrac{-at+b-\bar d \bar t}{1-t \bar t}
    - \bar t \cdot \dfrac{-at^2+bt-\bar d}{1-t \bar t}
    &= -a+b \in \varpi^{-r} \OO_E,
\end{align*}
it follows that as soon as one entry is in $\varpi^{-r} \OO_E$, they all are.
Meanwhile, the requirements on the other entries amount to
\begin{align}
  m & \geq n - r \\
  v\left( c+(1-d \bar d) \bar t \right) &\geq m-r \label{eq:cddtop} \\
  v\left( ct+(1-d \bar d) \right) &\geq m-r \label{eq:cddbot}
\end{align}
According to the earlier identity \eqref{eq:ctrick},
if \eqref{eq:cddtop} is assumed true,
then \eqref{eq:cddbot} is equivalent to
\[ \delta + v(1-t \bar t) \ge m-r. \]
Meanwhile, since $v(c+(1-d \bar d) \bar t) = v(\bar c + (1-d \bar d)t)$,
\eqref{eq:cddtop} is itself equivalent to
\[ v(t+u) + \delta \geq m-r \]
by reading the definition of \eqref{eq:u}.

Finally, we use a tricky substitution
\[ (2at-b)^2 - (b^2-4a\bar d) = -4a(-at^2+bt-\bar d) \]
to rewrite $v(-at^2+bt-\bar d) \geq n-r$
as $v\left( (2at-b)^2 - (b^2-4a\bar d) \right) \geq n-r$.

In summary:
\begin{claim}
  Assume $t$ is such that $n = v(1-t \bar t) > 0$.
  Then $\mathbf{1}(\gamma, t, m) = 1$ if and only if
  \[ n - r \leq m \leq n + \delta + r \]
  and $t$ lies in the set specified by
  \begin{align*}
    v\left( (2at-b)^2 - (b^2-4a\bar d) \right) &\geq n-r \\
    v(t+u) &\ge m-\delta-r.
  \end{align*}
\end{claim}

\subsection{Volume lemma}
The following two lemmas will be useful.
\begin{lemma}
  Let $\xi \in \OO_E^\times$ and let $n \ge 1$.
  Then the volume of the set
  \[ \left\{ x \in E \mid v(1-x \bar x) = n, \right\} \]
  equals
  \[ q^{-n}(1-q^{-2}). \]
\end{lemma}

\begin{lemma}
  [{\cite[Lemma 4.4]{ref:AFL}}]
  Let $\xi \in \OO_E^\times$ and let $n \ge \rho \ge 1$ be integers.
  Then the volume of the set
  \[ \left\{ x \in E \mid v(1-x \bar x) = n, \; v(x-\xi) \ge \rho \right\} \]
  equals
  \[
    \begin{cases}
      0 & v(1-\xi\bar\xi) < \rho \\
      q^{-(n+\rho)}(1-q\inv) & v(1-\xi\bar\xi) \ge \rho.
    \end{cases}
  \]
  \label{lem:volume}
\end{lemma}

We will also need to intersect two disks. In an ultrametric space, this is easy to do:
\begin{lemma}
  [No MasterCard logo in an ultrametric space]
  Choose $\xi_1, \xi_2 \in E$ and $\rho_1 \geq \rho_2 \geq 0$.
  Consider the two disks:
  \begin{align*}
    D_1 &= \left\{ x \in E \mid v(x-\xi_1) \ge \rho_1 \right\} \\
    D_2 &= \left\{ x \in E \mid v(x-\xi_2) \ge \rho_2 \right\}.
  \end{align*}
  Then, if $v(\xi_1-\xi_2) \geq \rho_2$, we have $D_1 \subseteq D_2$.
  If not, instead $D_1 \cap D_2 = \varnothing$.
  \label{lem:mastercard}
\end{lemma}
\begin{proof}
  Because $E$ is an ultrametric space and $\Vol(D_1) \leq \Vol(D_2)$,
  we either have $D_1 \subseteq D_2$ or $D_1 \cap D_2 = \varnothing$.
  The latter condition checks which case we are in by testing if $\xi_1 \in D_2$,
  since $\xi_1 \in D_1$.
\end{proof}

\subsection{The case where $n > 0$, and $\ell$ is odd}
Considering $n > 0$ and $n-r \le m \le n+\delta+r$ as fixed,
we compute the volume of the set of $t$
for which $n = v(1-t\bar t)$ and $\mathbf{1}(\gamma,t,m) = 1$.

Supposing $\ell$ is odd, the condition
\[ v\left( (2at-b)^2 - (b^2-4a\bar d) \right) \geq n-r \]
is equivalent to simultaneously the two conditions
\begin{align}
  v\left( (2at-b)^2 \right) \geq n-r
  \implies v\left( t-\frac{b}{2a} \right) &\geq \left\lceil \frac{n-r}{2} \right\rceil
  \label{eq:odd_disk1} \\
  v(b^2-4a\bar d) \ge n-r \implies \ell &\ge n-r. \label{eq:odd_n_bound}
\end{align}
We also had the requirement
\begin{equation}
  v(t+u) \ge m-\delta-r.
  \label{eq:odd_disk2}
\end{equation}
Use \Cref{lem:mastercard} on \eqref{eq:odd_disk1} and \eqref{eq:odd_disk2},
noting the distance between the two centers is exactly
\[ v\left( u + \frac{b}{2a} \right) = v\left( \frac{au-\bar d \bar u}{2a} \right)
  = v(au - \bar d \bar u). \]
Considering that our disks have ``radius''
$\left\lceil \frac{n-r}{2} \right\rceil$ and $m-\delta-r$ respectively,
we obtain two possible situations:
\begin{itemize}
  \ii If $m < \left\lceil \frac{n-r}{2} \right\rceil + \delta + r$
  then \Cref{lem:volume} and \Cref{lem:mastercard} apply if and only if, respectively,
  \begin{align}
    v(4-b\bar b) &\ge \left\lceil \frac{n-r}{2} \right\rceil \label{eq:odd_ineq1} \\
    v(au - \bar d \bar u) &\ge m - \delta - r \label{eq:odd_ineq2}.
  \end{align}

  \ii If $m \geq \left\lceil \frac{n-r}{2} \right\rceil + \delta + r$
  then \Cref{lem:volume} and \Cref{lem:mastercard} apply if and only if, respectively,
  \begin{align}
    v(1-u \bar u) &\ge m-\delta-r \label{eq:odd_ineq3} \\
    v(au - \bar d \bar u) &\ge \left\lceil \frac{n-r}{2} \right\rceil \label{eq:odd_ineq4}.
  \end{align}
\end{itemize}
To proceed further, we need to prove a few properties.
We list them in turn.

\begin{fact}
  Whenever $\ell$ is odd, we must have
  \begin{equation}
    v(b) = v(d) = 0.
    \label{eq:odd_b_d_zero}
  \end{equation}
\end{fact}
\begin{proof}
  [Proof of \eqref{eq:odd_b_d_zero}]
  If $v(d) \neq 0$, then $b = -au-\bar d\bar u$ is a unit,
  and hence so is $b^2 - 4 a \bar d$, causing $\ell = 0$, contradiction.
  And if $d$ is a unit, $\ell \neq 0$ means $v(b) = 0$ too.
\end{proof}

Next, note that \eqref{eq:dos} together with \eqref{eq:odd_b_d_zero}
and the assumption $\ell$ was odd implies
\begin{equation}
  \ell = v(1-u \bar u) < 2v(au - \bar d \bar u).
  \label{eq:odd_center_distance}
\end{equation}
This implies that:
\begin{fact}
  \eqref{eq:odd_ineq2} and \eqref{eq:odd_ineq4} are redundant for odd $\ell$,
  i.e.\ they are automatically true whenever $n > 0$ and $n-r \le m \le n+\delta+r$.
\end{fact}
\begin{proof}
  Delete the ceilings.
  We have $\frac{n-r}{2} \le \frac{\ell}{2} < v(au - \bar d \bar u)$ in both cases.
  And in \eqref{eq:odd_ineq1}, we have $m-\delta-r \le \frac{n-r}{2}$ anyway.
\end{proof}

Finally, the equation $v(4-b \bar b) = -4au(1-d\bar d) - \bar b(b^2-4a\bar d)$
together with \eqref{eq:odd_b_d_zero} implies
\begin{equation}
  v(4-b\bar b) \ge \min(\ell,\delta) \text{ with equality if } \ell \neq \delta.
  \label{eq:odd_bb}
\end{equation}
Hence, a priori \eqref{eq:odd_bb} suggests that we have a condition
$n \le r + 2 \delta$ in addition to $n \le r + \ell$.
However, this condition also turns out to be redundant.
\begin{lemma}
  When $\ell$ is odd we always have $\ell < 2 \delta$.
  \label{lem:wtfell}
\end{lemma}
\begin{proof}
  To be written up.
\end{proof}

Putting all of this together,
we find that the valid pairs $(n,m)$ come in two cases.

\paragraph{First case}
The first case is
\begin{equation}
  \begin{aligned}
    1 &\leq n \leq \ell + r, \\
    n-r &\leq m \leq \left\lceil \frac{n-r}{2} \right\rceil+\delta+r - 1
  \end{aligned}
  \label{eq:odd_range1}
\end{equation}
where each $(m,n)$ gives a volume contribution of
\[
  \begin{cases}
    q^{-n - \left\lceil \frac{n-r}{2} \right\rceil} \left( 1 - q\inv \right)
      & \text{if $n > r$} \\
    q^{-n} \left( 1 - q^{-2} \right)
      & \text{if $n \leq r$}.
  \end{cases}
\]

\paragraph{Second case}
The second case is
\begin{equation}
  \begin{aligned}
    1 &\leq n \leq \ell + r, \\
    \max\left(n-r, \left\lceil \frac{n-r}{2} \right\rceil+\delta+r \right)
    &\leq m \leq \min(n,\ell)+\delta+r.
  \end{aligned}
  \label{eq:odd_range2}
\end{equation}
where each $(m,n)$ gives a volume contribution of
\[
  \begin{cases}
    q^{-n - (m-\delta-r)} \left( 1 - q\inv \right)
      & \text{if $m > \delta + r$} \\
    q^{-n} \left( 1 - q^{-2} \right)
      & \text{if $m \le \delta + r$}.
  \end{cases}
\]
Notice that $m \leq \delta + r$ could only occur when $n \leq r$.

\subsection{The case where $n > 0$, $\ell$ is even, $v(b)=v(d)=0$}
As before we consider $n > 0$ and $n-r \le m \le n+\delta+r$ as fixed,
and seek to compute the volume of the set of $t$
for which $n = v(1-t\bar t)$ and $\mathbf{1}(\gamma,t,m) = 0$.

Suppose $\ell$ is even.
Then the left-hand side of \eqref{eq:dos} is a square, which we denote $\tau^2$.
In this case, we obtain
\[ 2v(\tau) = \ell = 2v(au-\bar d\bar u) > \lambda \coloneqq v(1-u \bar u). \]
Then the condition that
\[ v\Big( (2at-b)^2 - \underbrace{(b^2-4a\bar d)}_{=\tau^2} \Big) \geq n-r \]
falls into three disjoint parts:
\begin{itemize}
  \ii Both $v\left( (2at-b)^2 \right) \geq n-r$ and $\ell = v(\tau^2) \geq n-r$ hold,
  as in the $\ell$ odd case.
  \ii We have $\ell = v(\tau^2) < n-r$ (hence $v\left( (2at-b)^2 \right) < n-r$ too) but
  \[ v(2at-b \mp \tau) \geq (n-r)-\ell/2 > 0 \]
  which in particular implies $v(2at-b \pm \tau) = \ell/2$.
  This is two parts, corresponding to the choice of $\pm$.
\end{itemize}
We analyze the second case since the first case is the same as before
(as we are assuming \eqref{eq:odd_b_d_zero} in this section;
it does not follow for $\ell$ even).
The constrains on $t$ become the two circles
\begin{align}
  v\left( t - \frac{b \pm \tau}{2a} \right) &\geq n - \ell/2 - r \\
  v(t+u) &\ge m - \delta - r.
\end{align}
Note that
\[ 1 - \frac{b \pm \tau}{2a} \cdot \frac{\bar b \pm \bar \tau}{2\bar a}
= \frac{4 - \Norm(b \pm \tau)}{4} \]

The distance between the two circles has valuation
\[
  v\left( u + \frac{b \pm \tau}{2} \right)
  = v(au - \bar d \bar u \pm \tau).
\]
Since $(au-\bar d \bar u)^2 - \tau^2 = 4a\bar d(1- u\bar u)$,
we agree now to fix the choice of the square root of $\tau$ such that
\begin{equation}
  v(au-\bar d \bar u + \tau) = \lambda - v(\tau) \quad\text{and}\quad
  v(au-\bar d \bar u - \tau) = v(\tau).
  \label{eq:tau_choice}
\end{equation}
From $v(b) = v(d) = 0$ and \eqref{eq:dos}, we have
\[ \ell = 2v(\tau) = 2v(au - \bar d \bar u) < \lambda. \]
When $v(b) = v(d) = 0$ we also automatically have $\delta, \ell \ge 0$

This lets us invoke \cite[Lemma 4.7]{ref:AFL} to evaluate $v(4-\Norm(b \pm \tau))$:
we have
\begin{align*}
  \lambda + \delta - \ell &= v\left( 4 - \Norm(b+\tau) \right) \\
  \delta &= v\left( 4 - \Norm(b-\tau) \right).
\end{align*}
So we obtain $2 \cdot 2 = 4$ total cases.

\paragraph{Case $1^+$.}
Suppose $m < n - \frac{\ell}{2} + \delta$, and we choose $\frac{b+\tau}{2a}$.
Then the contribution is nonempty if and only if
\begin{align*}
  \lambda + \delta - \ell = v(4-\Norm(b+\tau)) &\geq n - \frac{\ell}{2} - r \\
  \lambda - \ell/2 = v(au-\bar d \bar u + \tau) & \geq m - \delta - r.
\end{align*}
Compiling all seven constraints gives that the valid pairs $(m,n)$ are those for which
\begin{align*}
  \max(1, \ell+r+1) &\leq n \leq -\frac{\ell}{2} + \delta + r + \lambda, \\
  n-r &\leq m \leq \min\left( n+\delta+r, n - \frac{\ell}{2}+\delta - 1,
    \lambda-\frac{\ell}{2}+\delta+r \right)
\end{align*}
However, $n + \delta + r \ge n - \frac{\ell}{2} + r$ is clear.
So this equation can be whittled down to
\begin{equation}
  \begin{aligned}
    \max(1, \ell+r+1) &\leq n \leq  -\frac{\ell}{2} + \delta + r + \lambda, \\
    n-r &\leq m \leq \min\left( n - \frac{\ell}{2}+\delta - 1,
      \lambda-\frac{\ell}{2}+\delta+r \right).
  \end{aligned}
  \label{eq:even_case1_plus}
\end{equation}
Each $(m,n)$ gives a volume contribution of
\[ q^{-n - (n - \ell/2 - r)} \left( 1 - q\inv \right). \]

\paragraph{Case $1^-$.}
Suppose $m < n - \frac{\ell}{2} + \delta$, and we choose $\frac{b-\tau}{2a}$.
Then the disks have nonempty intersection whenever
\begin{align*}
  \delta = v(4-\Norm(b-\tau)) &\geq n - \frac{\ell}{2} - r \\
  \ell/2 = v(au-\bar d \bar u - \tau) & \geq m - \delta - r.
\end{align*}
Compiling all seven constraints gives that the valid pairs $(m,n)$ are those for which
\begin{align*}
  \max(1, \ell+r+1) &\leq n \leq \frac{\ell}{2}+\delta+r, \\
  n-r &\leq m \leq \min\left( n - \frac{\ell}{2}+\delta - 1,
    \frac{\ell}{2} + \delta + r, n + \delta + r \right)
\end{align*}
However, $n - \frac{\ell}{2}+\delta - 1 \ge \frac{\ell}{2} + \delta + r$
hold automatically once $n \ge \ell + r + 1$,
and $n + \delta + r \ge n - \frac{\ell}{2}+\delta - 1$
is true for $\ell \ge 0$.
So we can simplify this to
\begin{equation}
  \begin{aligned}
    \max(1, \ell+r+1) &\leq n \leq \frac{\ell}{2}+\delta+r, \\
    n-r &\leq m \leq \frac{\ell}{2} + \delta + r.
  \end{aligned}
  \label{eq:even_case1_minus}
\end{equation}
As in the previous case, $(m,n)$ gives a volume contribution of
\[ q^{-n - (n - \ell/2 - r)} \left( 1 - q\inv \right). \]

\paragraph{Case $2^+$.}
Suppose $m \ge n - \frac{\ell}{2} + \delta$, and we choose $\frac{b+\tau}{2a}$.
Then the contribution is nonempty if and only if
\begin{align*}
  \lambda &\geq m - \delta - r \\
  \lambda - \ell/2 = v(au-\bar d \bar u + \tau) & \geq n - \frac{\ell}{2} - r.
\end{align*}
Rearranging gives that the valid pairs $(m,n)$ are those for which
\begin{equation}
  \begin{aligned}
    \max(1, \ell+r+1) &\leq n \leq \lambda + r \\
    \max\left( n-r, n - \frac{\ell}{2} + \delta \right) &\leq m \leq \min(n, \lambda) + r + \delta.
  \end{aligned}
  \label{eq:even_case2_plus}
\end{equation}
Here, each $(m,n)$ gives a volume contribution of
\[ q^{-n - (m - \delta - r)} \left( 1 - q\inv \right). \]

\paragraph{Case $2^-$.}
Suppose $m \geq n - \frac{\ell}{2} + \delta$, and we choose $\frac{b+\tau}{2a}$.
Then the disks have nonempty intersection whenever
\begin{align*}
  \lambda &\geq m - \delta - r \\
  \ell/2 = v(au-\bar d \bar u - \tau) & \geq n - \frac{\ell}{2} - r.
\end{align*}
The latter inequality contradicts the assumption that $n > \ell + r$,
so this case can never occur.

\newpage

\section{Evaluation of the integral}
\subsection{Region where $n \leq 0$ for all values of $\ell$}
\begin{proposition}
  The contribution to the integral $O(\gamma,s)$ over $n \leq 0$ is exactly
  \[ I_{n \le 0} \coloneqq q^{2(\delta+r)s} \sum_{j=0}^{\delta+2r} q^{-2js}
    = q^{-2rs} + \dots + q^{2(\delta+r)s}. \]
\end{proposition}
\begin{proof}
  For $n = 0$ we get a contribution of
  \begin{align*}
    &\phantom= \kappa \int_{t, t_1 \in E} \mathbf{1}(n=0) \mathbf{1}(\gamma,t,m)
      q^{2s \cdot m} q^{-2m} \odif t \odif t_1 \\
    &= \kappa \Vol(t: n =0) \sum_{m=-r}^{\delta+r} \Vol(t_1: -v(t_1)=m) q^{2m(s-1)} \\
    &= \kappa \left( 1 - \frac{q+1}{q^2} \right) \sum_{m=-r}^{\delta+r}
    \left( q^{2m} \left( 1-q^{-2} \right) \right) q^{2m(s-1)} \\
    &= \kappa \left( 1 - \frac{q+1}{q^2} \right) \left( 1-q^{-2} \right)
    \sum_{m=-r}^{\delta+r} q^{2ms}.
  \end{align*}
  For the region where $v(t) = -k < 0$, for each individual $k > 0$,
  \begin{align*}
    &\phantom= \kappa \int_{t, t_1 \in E} \mathbf{1}(v(t)=-k) \mathbf{1}(\gamma,t,m)
      q^{s(2m-n)} q^{2n-2m} \odif t \odif t_1 \\
    &= \kappa \Vol(t: v(t)=-k) \sum_{m=-r-k}^{\delta+r-k}
      \Vol(t_1: -v(t_1)=m) q^{s(2m+2k)-4k-2m} \\
    &= \kappa q^{2k} \left( 1 - q^{-2} \right) \sum_{m=-r-k}^{\delta+r-k}
      \left( q^{2m} \left( 1-q^{-2} \right) \right) q^{s(2m+2k)-4k-2m} \\
    &= \kappa q^{-2k} \left( 1 - q^{-2} \right)^2
      \sum_{m=-r-k}^{\delta+r-k} q^{2(m+k)s} \\
    &= \kappa q^{-2k} \left( 1 - q^{-2} \right)^2 \sum_{i=-r}^{\delta+r} q^{2is}.
  \end{align*}
  Since $\sum_{k > 0} q^{-2k} = \frac{q^{-2}}{1-q^{-2}}$,
  we find that the total contribution across both
  the $n=0$ case and the $k > 0$ case is
  \begin{align*}
    &\phantom= \left( \left( 1 - \frac{q+1}{q^2} \right) \left( 1-q^{-2} \right)
      + q^{-2}(1-q^{-2})  \right) \kappa \sum_{i=-r}^{\delta+r} q^{2is} \\
    &= \left( 1-q\inv \right) \left(1-q^{-2} \right)
      \kappa \sum_{i=-r}^{\delta+r} q^{2is} \\
    &= \sum_{i=-r}^{\delta+r} q^{2is}.
  \end{align*}
  This equals the claimed sum above.
  (We write it over $0 \le j \le \delta+2r$ for consistency with a later part.)
\end{proof}

\subsection{Region where $n > 0$ for odd $\ell$}
Again using $\Vol(t_1:-v(t_1)=m) = q^{2m} (1-q^{-2})$,
summing all the cases gives
\begin{align*}
  I_{n > 0}^{\text{odd}} &\coloneqq
    \kappa \int_{t, t_1 \in E} \mathbf{1}(n > 0) \mathbf{1}(\gamma,t,m) \\
  % -----------------------------------------------------------
  &= \kappa \sum_{n=1}^{r}
    \sum_{m=n-r}^{\left\lceil \frac{n-r}{2} \right\rceil+\delta+r-1}
    q^{-n} \left( 1 - q^{-2} \right)
      \cdot \Big( (-1)^n q^{s(2m-n)} q^{2n-2m} \Big) \Big( q^{2m}(1-q^{-2}) \Big) \\
  &\qquad+ \kappa \sum_{n=r+1}^{\ell+r}
    \sum_{m=n-r}^{\left\lceil \frac{n-r}{2} \right\rceil+\delta+r-1}
    q^{-n - \left\lceil \frac{n-r}{2} \right\rceil} \left( 1 - q\inv \right)
      \cdot \Big( (-1)^n q^{s(2m-n)} q^{2n-2m} \Big) \Big( q^{2m}(1-q^{-2}) \Big) \\
  &\qquad+ \kappa \sum_{n=1}^{r}
    \sum_{m=\max\left(n-r, \left\lceil \frac{n-r}{2} \right\rceil+\delta+r\right)}^{\delta+r}
    q^{-n} \left( 1 - q^{-2} \right)
      \cdot \Big( (-1)^n q^{s(2m-n)} q^{2n-2m} \Big) \Big( q^{2m}(1-q^{-2}) \Big) \\
    \\
  &\qquad+ \kappa \sum_{n=1}^{\ell+r}
    \sum_{m=\max\left(n-r, \left\lceil \frac{n-r}{2} \right\rceil+\delta+r, \delta+r+1 \right)}^{\min(n,\ell)+\delta+r}
    q^{-n - (m-\delta-r)} \left( 1 - q\inv \right)
      \\ &\qquad\qquad
      \cdot \Big( (-1)^n q^{s(2m-n)} q^{2n-2m} \Big) \Big( q^{2m}(1-q^{-2}) \Big) \\
  % -----------------------------------------------------------
  &= \sum_{n=1}^{r}
    \sum_{m=n-r}^{\left\lceil \frac{n-r}{2} \right\rceil+\delta+r-1}
    q^{n} \left( 1 + q\inv \right)
      \cdot (-1)^n q^{s(2m-n)} \\
  &\qquad+ \sum_{n=r+1}^{\ell+r}
    \sum_{m=n-r}^{\left\lceil \frac{n-r}{2} \right\rceil+\delta+r-1}
    q^{\left\lfloor \frac{n+r}{2} \right\rfloor}
      \cdot (-1)^n q^{s(2m-n)} \\
  &\qquad+ \sum_{n=1}^{r}
    \sum_{m=\max\left(n-r, \left\lceil \frac{n-r}{2} \right\rceil+\delta+r\right)}^{\delta+r}
    q^{n} \left( 1 + q\inv \right)
      \cdot (-1)^n q^{s(2m-n)} \\
  &\qquad+ \sum_{n=1}^{\ell+r}
    \sum_{m=\max\left(n-r, \left\lceil \frac{n-r}{2} \right\rceil+\delta+r, \delta+r+1 \right)}^{\min(n,\ell)+\delta+r}
    q^{n - (m-\delta-r)}
      \cdot (-1)^n q^{s(2m-n)}.
\end{align*}
To simplify the expressions, we replace the summation variable $m$ with
\[ j \coloneqq (n + \delta + r) - m \geq 0. \]
In that case,
\[ 2m-n = 2(\delta+n+r-j)-n = n + 2\delta + 2r - 2j. \]
Then the expression rewrites as
\begin{align*}
  I_{n > 0}^{\text{odd}}
  % -----------------------------------------------------------
  &= \sum_{n=1}^{r}
    \sum_{j = \left\lfloor \frac{n+r}{2} \right\rfloor+ 1}^{\delta + 2r}
    q^{n} \left( 1 + q\inv \right) \cdot (-1)^n q^{s(n+2\delta+2r-2j)} \\
  &\qquad+ \sum_{n=r+1}^{\ell+r}
    \sum_{j = \left\lfloor \frac{n+r}{2} \right\rfloor+ 1}^{\delta + 2r}
    q^{\left\lfloor \frac{n+r}{2} \right\rfloor} \cdot (-1)^n q^{s(n+2\delta+2r-2j)} \\
  &\qquad+ \sum_{n=1}^{r}
    \sum_{j=n}^{\min\left( \delta+2r, \left\lfloor \frac{n+r}{2} \right\rfloor \right)}
    q^{n} \left( 1 + q\inv \right) \cdot (-1)^n q^{s(n+2\delta+2r-2j)} \\
  &\qquad+ \sum_{n=1}^{\ell+r}
    \sum_{j=\max(0,n-\ell)}^{\min(\delta+2r, \left\lfloor \frac{n+r}{2} \right\rfloor, n-1)}
    q^{j} \cdot (-1)^n q^{s(n+2\delta+2r-2j)}.
\end{align*}

We interchange the order of summation so that it is first over $j$ and then $n$.
There are four double sums to interchange.

\begin{itemize}
  \ii The first double sum runs from $j=\left\lfloor \frac{r+1}{2} \right\rfloor+1$ to $j=\delta+2r$.
  In addition to $1 \le n \le r$,
  we need $\left\lfloor \frac{n+r}{2} \right\rfloor + 1 \leq j$,
  which solves to $\frac{n+r}{2} \leq j-\half$ or $n \leq 2j-1-r$.
  Thus the condition on $n$ is
  \[ 1 \leq n \leq \min(2j-1-r, r). \]

  \ii The second double sum runs from $j=r+1$ to $\delta+2r$.
  We also need $r+1 \le n \le \ell+r$ and $n \le 2j-1-r$.
  Hence, the desired condition on $n$ is
  \[ r+1 \leq n \leq \min(2j-1-r, \ell+r). \]

  \ii The third double runs from $j=1$ to $j=r$.
  Meanwhile, the values of $n$ need to satisfy $1 \le n \le r$, $n \leq j$
  and $j \leq \left\lfloor \frac{n+r}{2} \right\rfloor \implies n \geq 2j-r$,
  consequently we just obtain
  \[ \max(1, 2j-r) \leq n \leq j. \]

  \ii The fourth double sum runs $j=0$ to
  \[ j=\min\left( \delta+2r, \left\lfloor \frac{\ell}{2} \right\rfloor + r, \ell+r-1 \right)
    = \left\lfloor \frac{\ell}{2} \right\rfloor + r \]
  again because of \Cref{lem:wtfell}.
  Meanwhile, we require $1 \le n \le \ell+r$, $j \ge n-\ell$, $j \le n-1$,
  as well as $j \le \left\lfloor \frac{n+r}{2} \right\rfloor
  \iff n \ge 2j-r$.
  Putting these four conditions together gives
  \[ \max(j+1, 2j-r) \le n \le \ell+\min(j,r). \]
\end{itemize}
Hence we get
\begin{align*}
  I_{n > 0}^{\text{odd}}
  &= \sum_{j = \left\lfloor \frac{r+1}{2} \right\rfloor+ 1}^{\delta+2r}
    \sum_{n=1}^{\min(2j-1-r, r)}
    q^{n} \left( 1 + q\inv \right) \cdot (-1)^n q^{s(n+2\delta+2r-2j)} \\
  &\qquad+ \sum_{j = r+1}^{\delta + 2r}
    \sum_{n=r+1}^{\min(2j-1-r, \ell+r)}
    q^{\left\lfloor \frac{n+r}{2} \right\rfloor} \cdot (-1)^n q^{s(n+2\delta+2r-2j)} \\
  &\qquad+ \sum_{j=1}^{r}
    \sum_{n=\max(1,2j-r)}^{j}
    q^{n} \left( 1 + q\inv \right) \cdot (-1)^n q^{s(n+2\delta+2r-2j)} \\
  &\qquad+ \sum_{j=0}^{\left\lfloor \frac{\ell}{2} \right\rfloor + r}
    \sum_{n=\max(j+1, 2j-r)}^{\ell+\min(j,r)}
    q^{j} \cdot (-1)^n q^{s(n+2\delta+2r-2j)}.
\end{align*}

At this point, we can unify the sum over $j$ by noting that for $j$ outside of the
summation range, the inner sum is empty anyway.
Specifically, note that:
\begin{itemize}
  \ii In the first and second double sum,
  the inner sum over $n$ is empty anyway when $j < r$.
  \ii In the third double sum, adding $j=0$ does not introduce new terms.
  Moreover, when $j > r$ the inner sum over $n$ is also empty anyway.
  \ii In the fourth double sum, if $j > \left\lfloor \frac{\ell}{2} \right\rfloor + r$,
  the inner double sum vanishes since $2j-r > \ell + \min(j,r)$ in that case.
\end{itemize}
So we can unify all four double sums to run over $0 \le j \le \delta + 2r$,
simplifying the expression to just

\begin{align*}
  I_{n > 0}^{\text{odd}}
  = q^{2(\delta+r)s}
  \sum_{j = 0}^{\delta + 2r} \Bigg(
    & \sum_{n=1}^{\min(2j-1-r, r)}
      q^{n} \left( 1 + q\inv \right) \cdot (-1)^n q^{s(n-2j)} \\
    & + \sum_{n=r+1}^{\min(2j-1-r, \ell+r)}
      q^{\left\lfloor \frac{n+r}{2} \right\rfloor} \cdot (-1)^n q^{s(n-2j)} \\
    &+ \sum_{n=\max(1,2j-r)}^{j}
      q^{n} \left( 1 + q\inv \right) \cdot (-1)^n q^{s(n-2j)} \\
    &+ \sum_{n=\max(j+1, 2j-r)}^{\ell+\min(j,r)} q^{j} \cdot (-1)^n q^{s(n-2j)} \Bigg).
\end{align*}

\subsection{Completed case when $\ell$ is odd}
Combining the previous two results gives
\begin{align*}
  I_{n \le 0} + I_{n > 0}^{\text{odd}}
  = q^{2(\delta+r)s}
  \sum_{j = 0}^{\delta + 2r} \Bigg(
    q^{-2js}
    &+ \sum_{n=1}^{\min(2j-1-r, r)}
      q^{n} \left( 1 + q\inv \right) \cdot (-1)^n q^{s(n-2j)} \\
    &+ \sum_{n=r+1}^{\min(2j-1-r, \ell+r)}
      q^{\left\lfloor \frac{n+r}{2} \right\rfloor} \cdot (-1)^n q^{s(n-2j)} \\
    &+ \sum_{n=\max(1,2j-r)}^{j}
      q^{n} \left( 1 + q\inv \right) \cdot (-1)^n q^{s(n-2j)} \\
    &+ \sum_{n=\max(j+1, 2j-r)}^{\ell+\min(j,r)} q^{j} \cdot (-1)^n q^{s(n-2j)} \Bigg).
\end{align*}

\subsection{Region where $n > 0$ for even $\ell$}
