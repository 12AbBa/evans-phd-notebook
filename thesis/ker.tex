\chapter{Large and small kernels}
\label{ch:ker}

In this chapter:
\begin{itemize}
  \ii For the orbital integral on $S_3(F)$,
  we prove \Cref{thm:large_kernel_group_full} which implies \Cref{thm:large_kernel_group}.
  \ii For the orbital integral on $S_2(F) \times V'_2(F)$,
  we use \Cref{cor:semi_lie_combo} to prove
  both \Cref{thm:semi_lie_ker_trivial} and
  \Cref{thm:semi_lie_finite_codim_full} (which implies \Cref{thm:semi_lie_ker_huge}).
\end{itemize}

\section{In the group AFL, the kernel still has finite codimension for $n=3$}
The main result is the following:
\begin{theorem}
  \label{thm:large_kernel_group_full}
  For any $r \ge 3$ we always have
  \[ \left. \pdv{}{s} \right\rvert_{s=0}
    \Orb(\gamma, \mathbf{1}_{K'_{S, r}} + 2q \mathbf{1}_{K'_{S, r-1}}
    + q^2 \mathbf{1}_{K'_{S, r-2}}) = (2q+2) \log q. \]
\end{theorem}

\subsection{Proof of \Cref{thm:large_kernel_group}}
\Cref{thm:large_kernel_group_full} already implies the codimension of the kernel is at most $3$.
In order to show it is exactly $3$,\todo{prove it}.

We now turn to showing that the kernel is not contained in any maximal ideal.
\todo{okay i'm not actually sure this is true}
This requires us to invoke the explicit results from \Cref{ch:satake}.
Consider the composed isomorphisms
\[ \HH(S_3(F)) \xrightarrow{\BC_S} \HH(\U(\VV_3^+)) \xrightarrow{\Sat} \QQ[Y + Y^{-1}]. \]
Let $K =  \GL_n(\OO_E) \cap \U(\VV_3^+)$ and note for any $r \ge 2$ we have
\begin{align*}
  \mathbf{1}_{K\varpi^{(r,0,-r)}K}
  &\xmapsto{\BC_S^{-1}}
  \mathbf{1}_{K'_{S, r}} + 2q \mathbf{1}_{K'_{S, r-1}} + 2q^2 \mathbf{1}_{K'_{S, r-2}} + 2q^3 \mathbf{1}_{K'_{S, r-3}} + \dots \\
  \implies
  \mathbf{1}_{K\varpi^{(r,0,-r)}K} - q^2 \mathbf{1}_{K\varpi^{(r-2,0,-(r-2))}K}
  &\xmapsto{\BC_S^{-1}}
  \mathbf{1}_{K'_{S, r}} + 2q \mathbf{1}_{K'_{S, r-1}} + q^2 \mathbf{1}_{K'_{S, r-2}}.
\end{align*}
Hence for $r \ge 3$ if we define
\begin{align*}
  P_r(Y) &\coloneqq \Sat\left(\BC_S(\mathbf{1}_{K'_{S, r}}
    + 2q \mathbf{1}_{K'_{S, r-1}} + q^2 \mathbf{1}_{K'_{S, r-2}})\right) \\
  &= \Sat\left( \mathbf{1}_{K\varpi^{(r,0,-r)}K} - q^2 \mathbf{1}_{K\varpi^{(r-2,0,-(r-2))}K} \right) \\
  &= \Sat\Big(
    \mathbf{1}_{\varpi^{-r} \Mat_3(\OO_E) \cap \U(\VV_3^+)}
    - \mathbf{1}_{\varpi^{-(r-1)} \Mat_3(\OO_E) \cap \U(\VV_3^+)} \\
    &\qquad- q^2 \mathbf{1}_{\varpi^{-(r-2)} \Mat_3(\OO_E) \cap \U(\VV_3^+)}
    + q^2 \mathbf{1}_{\varpi^{-(r-3)} \Mat_3(\OO_E) \cap \U(\VV_3^+)}
    \Big) \\
  &= \left( q^{2r} \sum_{j=-r}^r Y^j + q^{2r-1} \sum_{j=-(r-1)}^{r-1} Y^j \right)
  - \left( q^{2r-2} \sum_{j=-(r-1)}^{r-1} Y^j + q^{2r-3} \sum_{j=-(r-2)}^{r-2} Y^j \right) \\
  &\qquad- \left( q^{2r-2} \sum_{j=-(r-2)}^{r-2} Y^j + q^{2r-3} \sum_{j=-(r-3)}^{r-3} Y^j \right)
  + \left( q^{2r-4} \sum_{j=-(r-3)}^{r-3} Y^j + q^{2r-5} \sum_{j=-(r-4)}^{r-4} Y^j \right)
\end{align*}
then it follows that $P_r(Y) - P_3(Y)$ is contained in the kernel for any $r \ge 3$.

To show this kernel generates the entire ring, it would be sufficient to prove
there is no $Y \in \CC^\times$ such that $P_3(Y) = P_4(Y) = P_5(Y) = P_6(Y) = \dotsb$.
However, using the explicit formula for $q$ above,
a direct calculation gives the following two identities:
\begin{align*}
  P_5(Y) - \frac{q^2}{Y} P_4(Y) - q^2 Y P_4(Y) - \frac{q^2}{Y} P_3(Y) &= -q^5 \\
  P_6(Y) - \frac{q^2}{Y} P_5(Y) - q^2 Y P_5(Y) - \frac{q^2}{Y} P_4(Y) &= 0.
\end{align*}
So such a common root $Y$ cannot exist.

\section{In the semi-Lie case, the kernel is trivial if we allow $v(e)$ to vary, even if we fix $\gamma$}
We prove \Cref{thm:semi_lie_ker_trivial} in this section.

\begin{lemma}
  Fix any $\gamma$ such that $v(b) = 1$, $v(c) = 0$, $v(d-a) = 0$,
  and let $N \ge 0$ be a nonnegative integer
  We define an $(N+2) \times (N+1)$ matrix $M$ as follows:
  for $0 \le i \le N+1$ and $0 \le r \le N$,
  the $i$\ts{th} row and $r$\ts{j} column takes the value
  \[
    M_{i,r} \coloneqq
    \frac{(-1)^r}{\log q}
    \left. \pdv{}{s} \right\rvert_{s=0}
      \Orb\left( \left(\gamma, \begin{pmatrix} 0 \\ 1 \end{pmatrix},
      \begin{pmatrix} 0 & \varpi^i \end{pmatrix} \right),
      \varphi \otimes \oneV, s\right).
  \]
  Then $M$ has full rank.
\end{lemma}
\begin{proof}
  We perform row operations as follows:
  \begin{itemize}
    \ii For each $i=N,N-1,\dots,0$, subtract the $i$\ts{th} row of $M$
    from the $(i+1)$\ts{th} row of $M$.
    Denote the new matrix as $M'$.

    \ii For each $i=N-1,N-2,\dots,0$, subtract the $i$\ts{th} row of $M'$
    from the $(i+2)$\ts{nd} row of $M'$.
    Denote the new matrix as $M''$.
  \end{itemize}
  For example, for $N = 5$, we have
  \[
    M =
    \begin{pmatrix}
    1 & 2 & 3 & 4 & 5 \\
    1 & q + 3 & 2 \, q + 4 & 3 \, q + 5 & 4 \, q + 6 \\
    2 & q + 4 & q^{2} + 3 \, q + 5 & 2 \, q^{2} + 4 \, q + 6 & 3 \, q^{2} + 5 \, q + 7 \\
    2 & 2 \, q + 5 & q^{2} + 4 \, q + 6 & q^{3} + 3 \, q^{2} + 5 \, q + 7 & 2 \, q^{3} + 4 \, q^{2} + 6 \, q + 8 \\
    3 & 2 \, q + 6 & 2 \, q^{2} + 5 \, q + 7 & q^{3} + 4 \, q^{2} + 6 \, q + 8 & q^{4} + 3 \, q^{3} + 5 \, q^{2} + 7 \, q + 9 \\
    3 & 3 \, q + 7 & 2 \, q^{2} + 6 \, q + 8 & 2 \, q^{3} + 5 \, q^{2} + 7 \, q + 9 & q^{4} + 4 \, q^{3} + 6 \, q^{2} + 8 \, q + 10
    \end{pmatrix}
  \]
  hence
  \[ M'=
    \begin{pmatrix}
    1 & 2 & 3 & 4 & 5 \\
    0 & q + 1 & 2 \, q + 1 & 3 \, q + 1 & 4 \, q + 1 \\
    1 & 1 & q^{2} + q + 1 & 2 \, q^{2} + q + 1 & 3 \, q^{2} + q + 1 \\
    0 & q + 1 & q + 1 & q^{3} + q^{2} + q + 1 & 2 \, q^{3} + q^{2} + q + 1 \\
    1 & 1 & q^{2} + q + 1 & q^{2} + q + 1 & q^{4} + q^{3} + q^{2} + q + 1 \\
    0 & q + 1 & q + 1 & q^{3} + q^{2} + q + 1 & q^{3} + q^{2} + q + 1
    \end{pmatrix}
  \]
  and finally
  \[ M'' =
    \begin{pmatrix}
    1 & 2 & 3 & 4 & 5 \\
    0 & q + 1 & 2 \, q + 1 & 3 \, q + 1 & 4 \, q + 1 \\
    0 & -1 & q^{2} + q - 2 & 2 \, q^{2} + q - 3 & 3 \, q^{2} + q - 4 \\
    0 & 0 & -q & q^{3} + q^{2} - 2 \, q & 2 \, q^{3} + q^{2} - 3 \, q \\
    0 & 0 & 0 & -q^{2} & q^{4} + q^{3} - 2 \, q^{2} \\
    0 & 0 & 0 & 0 & -q^{3}
    \end{pmatrix}.
  \]
  In order to prove $M$ has full rank, it suffices to prove $M''$ has full rank.
  However, as the examples suggest, $M''$ is almost upper triangular.

  We now show this.
  In this region in \Cref{thm:semi_lie_derivative_single}, if $i > r$
  the ``extra'' coefficient on $q^r$ is given by
  \begin{itemize}
    \ii When $i \equiv r \pmod 2$ we get $-\frac{\varkappa}{2} = - \frac{i-r}{2}$;
    \ii When $i \equiv r+1 \pmod 2$ we get $\frac{\varkappa}{2} - (i + \half - r) = -\frac{i-r+1}{2}$
  \end{itemize}
  and so we can write
  \[
    M_{i,r}
    = - \max\left(0, \left\lceil \frac{i-r}{2} \right\rceil \right) q^{r}
    + \sum_{j=0}^{\min(i,r)} \left( i + 1 + r - 2j \right) q^j.
  \]
  Hence
  \begin{align*}
    M'_{i,r}
    &= M_{i,r} - M_{i-1,r} \\
    &= - \mathbf{1}_{i \ge r, i \not\equiv r \bmod 2} q^r
    + \mathbf{1}_{i \le r} (i+1-r) q^i
    + \sum_{j=0}^{\min(i-1,r)} q^j
  \end{align*}
  Then for any $i > r > 0$ it follows that
  \begin{align*}
    M''_{i,r}
    &= M'_{i,r} - M'_{i-2,r} \\
    &= \begin{cases}
      -q^{r-1} & \text{if } i \ge r+1, r \ge 1 \\
      0 & \text{if } i \ge r+2.
    \end{cases}
  \end{align*}
  Moreover, since $M'_{0,r} = \mathbf{1}_{r \equiv 0 \bmod 2}$
  we deduce
  $M''_{0,r} = M'_{0,r} - M'_{0,r-2} = 0$
  for any $r \ge 2$, and $M''_{0,0} = 1$.
  Hence the pattern suggested by $M''$ holds in general.

  Finally, delete the 2nd row of $M''$ to get a square matrix
  with $N+1$ rows and $N+1$ columns which is upper triangular,
  and whose determinant is $(-1)^N q^{1+2+\dots+(N-1)} \neq 0$.
  Hence $M''$ has full rank.
\end{proof}

\subsection{Proof of \Cref{thm:semi_lie_ker_trivial}}
Suppose we are given some function
\[ \phi = \sum_{r=0}^N (-1)^r c_r \mathbf{1}_{K', \le r} \in \HH(S_2(F)). \]
Letting $M$ be the matrix given in the above proposition, we are supposed to have
\[
  M \begin{pmatrix} c_0 \\ c_1 \\ \vdots \\ c_N \end{pmatrix}
  = \mathbf{0} \in \CC^{N+2}.
\]
Since $M$ has full rank, it follows that $c_0 = \dots = c_N = 0$.

\section{In the semi-Lie case, the kernel has finite codimension if $v(e)=0$}
For this section, we define the following indicator function for $r \ge 3$:
\[ \phi_r \coloneqq \mathbf{1}_{K', \le r} + \mathbf{1}_{K', \le (r-1)}
   - q^2 (\mathbf{1}_{K', \le (r-2)} + \mathbf{1}_{K', \le (r-3)}). \]
The main assertion is the following theorem.
\begin{theorem}
  \label{thm:semi_lie_finite_codim_full}
  Suppose $\guv \in (S_2(F) \times V_2'(F))\rs$
  pairs with an element of $(\U(\VV_2^-) \times \VV_2^-)\rs$.
  Then
  \[
    \left. \pdv{}{s} \right\rvert_{s=0}
    \Orb \left( \guv, (\phi_r + (q+1)\phi_{r-1} + q\phi_{r-2}) \otimes \oneV, s \right) = 0
  \]
  holds for all $r \ge 5$ with at most three exceptions,
  namely those $r$ with
  \[ v(e) - \min\left(\frac{v(b)+v(c)-1}{2}, v(d-a)\right) + 2
    \le r \le v(e) - \min\left(\frac{v(b)+v(c)-1}{2}, v(d-a)\right) + 4. \]
\end{theorem}
\begin{proof}
  For brevity define $\theta \coloneqq \min\left( v(b)+v(c), 2v(d-a) \right)$
  as we did in \Cref{ch:orbitalFJ1}.
  Consider \Cref{cor:semi_lie_combo}, and let $N$, $C$, $C'$ be as in the statement.
  Let $N^{\flat\flat}$, $C^{\flat\flat}$, $(C')^{\flat\flat}$
  be the changes to those constants when one replaces $r$ by $r-2$.
  Then one can record the changes to these parameters explicitly, see \Cref{tab:semi_lie_change_by_two}.

  \begin{table}
    \begin{tabular}{lll}
      \toprule
      Assumptions & Parameters for $r$ & Parameters for $r-2$ \\
      \toprule
      $r \ge v(e) - \left\lfloor \tfrac{\theta}{2} \right\rfloor + 3$
        & $\begin{aligned} N &= v(e) \\ C &= C' = 0 \end{aligned}$
        & $\begin{aligned} N^{\flat\flat} &= v(e) \\ C^{\flat\flat} &= (C')^{\flat\flat} = 0 \end{aligned}$ \\
      \midrule
      $\begin{aligned} r &= v(e) - \left\lfloor \tfrac{\theta}{2} \right\rfloor + 2 \\ \theta &= 2v(d-a) \\ &\text{(exceptional)} \end{aligned}$
        & $\begin{aligned} N &= v(e) \\ C &= C' = 0 \end{aligned}$
        & $\begin{aligned} N^{\flat\flat} &= (r-2) + \left\lfloor \tfrac{\theta}{2} \right\rfloor = v(e) \\
          C^{\flat\flat} &= \tfrac{-1 + (v(b)+v(c)-2v(d-a))}{2} \\
          (C')^{\flat\flat} &= C^{\flat\flat}+1 \end{aligned}$ \\
      \midrule
      $\begin{aligned} r &= v(e) - \left\lfloor \tfrac{\theta}{2} \right\rfloor + 1 \\ \theta &= 2v(d-a) \end{aligned}$
        & $\begin{aligned} N &= v(e) \\ C &= C' = 0 \end{aligned}$
        & $\begin{aligned} N^{\flat\flat} &= (r-2) + \left\lfloor \tfrac{\theta}{2} \right\rfloor =v(e)-1 \\
          C^{\flat\flat} &= 0 \\
          (C')^{\flat\flat} &= 1 \end{aligned}$ \\
      \midrule
      $\begin{aligned} r &\le v(e) - \left\lfloor \tfrac{\theta}{2} \right\rfloor \\ \theta &= 2v(d-a) \\ \varkappa &\equiv 0 \pmod 2 \end{aligned}$
        & $\begin{aligned} N &= r + \left\lfloor \tfrac{\theta}{2} \right\rfloor \\
          C &= \tfrac{\varkappa-1 + (v(b)+v(c)-2v(d-a))}{2} \\
          C' &= C+1 \end{aligned}$
        & $\begin{aligned} N^{\flat\flat} &= (r-2) + \left\lfloor \tfrac{\theta}{2} \right\rfloor \\
          C^{\flat\flat} &= \tfrac{(\varkappa-2)-1 + (v(b)+v(c)-2v(d-a))}{2} \\
          (C')^{\flat\flat} &= C^{\flat\flat}+1 \end{aligned}$ \\
      \midrule
      $\begin{aligned} r &\le v(e) - \left\lfloor \tfrac{\theta}{2} \right\rfloor \\ \theta &= 2v(d-a) \\ \varkappa &\equiv 1 \pmod 2 \end{aligned}$
        & $\begin{aligned} N &= r + \left\lfloor \tfrac{\theta}{2} \right\rfloor \\
          C &= \tfrac{\varkappa-1}{2} \\
          C' &= C+1 \end{aligned}$
        & $\begin{aligned} N^{\flat\flat} &= (r-2) + \left\lfloor \tfrac{\theta}{2} \right\rfloor \\
          C^{\flat\flat} &= \tfrac{(\varkappa-2)-1}{2} \\
          (C')^{\flat\flat} &= C^{\flat\flat}+1 \end{aligned}$ \\
      \midrule
      $\begin{aligned} r &\le v(e) - \left\lfloor \tfrac{\theta}{2} \right\rfloor \\ \theta &= v(b)+v(c) \end{aligned}$
        & $\begin{aligned} N &= r + \left\lfloor \tfrac{\theta}{2} \right\rfloor \\
          C &= v(e) - \left\lfloor \tfrac{\theta}{2} \right\rfloor + r \\
          C' = 0 \end{aligned}$
        & $\begin{aligned} N^{\flat\flat} &= (r-2) + \left\lfloor \tfrac{\theta}{2} \right\rfloor \\
          C^{\flat\flat} &= v(e) - \left\lfloor \tfrac{\theta}{2} \right\rfloor + (r-2) \\
          (C')^{\flat\flat} &= 0 \end{aligned}$ \\
      \bottomrule
    \end{tabular}
    \caption{Comparison of $N$ to $N^{\flat\flat}$, etc.,
      needed to carry out the proof of \Cref{thm:semi_lie_finite_codim_full}.
      Note the exceptional case $r = v(e) - \left\lfloor \frac{\theta}{2} \right\rfloor + 2$
      differs from all the others because $C-C^{\flat\flat}$ can be large.}
    \label{tab:semi_lie_change_by_two}
  \end{table}
  Note in particular except for the single exceptional value
  $r = v(e) - \left\lfloor \frac{\theta}{2} \right\rfloor + 2$
  we should always have $(N^{\flat\flat}+2)-N \in \{0,1,2\}$,
  $C - C^{\flat\flat} \in \{0,1,2\}$, $(C') - (C')^{\flat\flat} \in \{0,1\}$.
  More explicitly, we have the following result from \Cref{tab:semi_lie_change_by_two}
  for every $r \ge 3$:
  \begin{align*}
    &\frac{(-1)^{r+v(c)}}{\log q}
    \left. \pdv{}{s} \right\rvert_{s=0}
    \Orb \left( \guv, \phi_r \otimes \oneV, s \right) \\
    &=
    \begin{cases}
      -q^{r+\left\lfloor \frac{\theta}{2} \right\rfloor} -q^{r+\left\lfloor \frac{\theta}{2} \right\rfloor - 1} + q + 1
        & \text{if } r \le v(e) - \left\lfloor \frac{\theta}{2} \right\rfloor + 1 \text{ and } \theta = v(b)+v(c) \\
      -2q^{r+\left\lfloor \frac{\theta}{2} \right\rfloor} + q + 1 & \text{if } r \le v(e) - \left\lfloor \frac{\theta}{2} \right\rfloor + 1 \text{ and } \theta = 2v(d-a) \\
      -q^{v(e)+2} - q^{v(e)+1} + q + 1  & \text{if } r \ge v(e) - \left\lfloor \frac{\theta}{2} \right\rfloor + 3.
    \end{cases}
  \end{align*}
  It follows that for $r \ge v(e) - \left\lfloor \frac{\theta}{2} \right\rfloor + 4$ we have
  \begin{equation}
    \frac{(-1)^{r+v(c)}}{\log q}
    \left. \pdv{}{s} \right\rvert_{s=0}
    \Orb \left( \guv, (\phi_r + \phi_{r-1}) \otimes \oneV, s \right)
    = 0
    \label{eq:semi_lie_finite_codim_large_r}
  \end{equation}
  while when $r \le v(e) - \left\lfloor \frac{\theta}{2} \right\rfloor + 1$ we have
  \begin{equation}
    \frac{(-1)^{r+v(c)}}{\log q}
    \left. \pdv{}{s} \right\rvert_{s=0}
    \Orb \left( \guv, (\phi_r + q\phi_{r-1}) \otimes \oneV, s \right)
    = 1-q^2.
    \label{eq:semi_lie_finite_codim_small_r}
  \end{equation}
  Then \Cref{thm:semi_lie_finite_codim_full} follows directly
  from \eqref{eq:semi_lie_finite_codim_large_r} and \eqref{eq:semi_lie_finite_codim_small_r}.
\end{proof}

\subsection{Proof of \Cref{thm:semi_lie_ker_huge}}
The first part of \Cref{thm:semi_lie_ker_huge} now follows directly.

It remains to show the kernel is not contained in any maximal ideal.
Consider the composed isomorphism from \Cref{ch:satake}
given by
\[ \HH(S_2(F)) \xrightarrow{\BC^\eta_S} \HH(\U(\VV_2^+)) \xrightarrow{\Sat} \QQ[Y + Y^{-1}]. \]
By combining \cite[Equation (7.1.9)]{ref:AFLspherical}
(which is also \Cref{lem:finale_base_change} later)
and \cite[Equation (7.1.4)]{ref:AFLspherical}
we find that
\begin{align*}
  \Sat(\BC^\eta_S(\mathbf{1}_{K', \le r} + \mathbf{1}_{K', \le (r-1)}))
  &= (-1)^r \Sat(\mathbf{1}_{\varpi^{-r} \Mat_2(\OO_E) \cap \VV_n^+}) \\
  &= (-1)^r \left( q^r \sum_{j=-r}^r Y^j - q^{r-1} \sum_{j=-(r-1)}^{r-1} Y^j \right).
\end{align*}
Hence
\begin{align*}
  (-1)^r \Sat(\BC^\eta_S(\phi_r))
  &= \left( q^r \sum_{j=-r}^r Y^j - q^{r-1} \sum_{j=-(r-1)}^{r-1} Y^j \right) \\
  &+ \left( q^{r-2} \sum_{j=-(r-2)}^{r-2} Y^j - q^{r-3} \sum_{j=-(r-3)}^{r-3} Y^j \right).
\end{align*}
Define the polynomials
\[ P_r(Y) \coloneqq (-1)^r \Sat(\BC^\eta_S(\phi_r + (q+1) \phi_{r-1} + q \phi_{r-2})). \]
Then with at most three exceptions described in \Cref{thm:semi_lie_finite_codim_full},
all of the polynomials $P_r(Y)$ for $r \ge 5$ are contained inside the kernel.
In particular, at least two of $P_5(Y)$, $P_8(Y)$, $P_{11}(Y)$ lie in the kernel.
So it would be sufficient to show that $P_5(Y)$, $P_8(Y)$ and $P_{11}(Y)$
have no common zeroes in $\CC^\times$.
