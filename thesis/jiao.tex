\chapter{Intersection numbers for $\Int((g,u), f)$ for $n = 2$}
This chapter is dedicated to computing intersection numbers
for the semi-Lie version of AFL in the special case $n = 2$.

\section{Background on quaternion division algebra}
Through this section we let $\DD$ be a quaternion division algebra over $F$,
with a fixed maximal order $\OO_\DD$.
We will make $\DD$ explicit in the following way for our calculations to follow.

\subsection{Structure as a noncommutative algebra}
As $F$-vector spaces we will write
\[ \DD = E \oplus E \Pi \]
where $\Pi$ is selected so that $\Pi^2 = \varpi$.
We endow $\DD$ with a noncommutative multiplication according to
\[ \Pi t = \bar t \Pi \qquad \text{ for all } t \in E \]
where $\ol{t}$ is the image of $t \in E$ under the nontrivial element of $\Gal(E/F)$.

\subsection{Conjugation of elements of $\DD$}
In general, suppose $x \in \DD$ is any element
decomposed as $x = a + b \Pi$ for $a,b \in E$.
Then we denote by $x^\ast \in \DD$ the conjugate in $\DD$ defined by
\[ x^\ast \coloneqq \ol{a} - b \]
where, again, $a$ is the image of $a \in E$ under the nontrivial element of $\Gal(E/F)$.
It is an anti-involution, meaning that $(x^\ast)^\ast = x$ and $(xy)^\ast = y^\ast x^\ast$.

This allows us to define the (reduced) norm and trace in $\DD$.
The reduced trace is given by
\[ \tr x \coloneqq x + x^\ast = \Tr{E/F}(a) = 2x_0. \]
This coincides with half the trace of the
$F$-linear multiplication map $u \cdot - \colon \DD \to \DD$.
We may thus define
\[ \DT \coloneqq \left\{ u \in \DD \mid \tr u = 0 \right\} \]
which has codimension $1$ inside $\DD$ (i.e.\ is three-dimensional as an $F$-vector space).
Since $\tr(a+b\Pi) = \Tr_{E/F}(a)$, we could also write
\[ \DT = \{ a+b\Pi \mid a,b \in E \text{ and } \Tr_{E/F}(a) = 0 \}. \]

The reduced norm is similarly defined by
\begin{align*}
  \Nm x &= x x^\ast = (a + b \Pi)(\bar a - b \Pi) \\
  &= a \bar a + b \Pi \bar a - a b \Pi - b \Pi b \Pi \\
  &= a \bar a - b \bar b \varpi \\
  &= \Norm_{E/F}(a) - \Norm_{E/F}(b) \varpi .
\end{align*}
This coincides with a square root of
the determinant of the $F$-linear map $u \cdot - \colon \DD \to \DD$.

\subsection{Inner form}
We equip $\DD$ with a symmetric $F$-bilinear inner form
$\left\langle \bullet, \bullet \right\rangle \colon \DD \times \DD \to F$ defined by
\[ \left\langle x,y \right\rangle = \tr(xy^\ast) = xy^\ast + yx^\ast. \]
It is easy to check that $\{1, \sqrt{\eps}, \Pi, \sqrt{\eps}\Pi\}$ is an orthogonal basis,
and hence that we have a orthogonal decomposition
\[ \DD = F \oplus F\sqrt\eps \oplus F \Pi \oplus F\sqrt\eps\Pi. \]

It will be convenient to introduce the following notation:
\begin{definition}
  For $x \in \DD$, we introduce the notation $x_0$ and $x_-$ to mean
  \begin{itemize}
    \ii $x_0$ is the projection into the first component $F$; and
    \ii $x_- = x - x_0$ is the projection into
    $\DT = F\sqrt\eps \oplus F \Pi \oplus F\sqrt\eps\Pi$.
  \end{itemize}
\end{definition}
In particular, the formula for conjugation then reads as the simpler
\[ x^\ast = x_0 - x_-. \]

\subsection{Identification of $\VV_n^-$ with $\DD$}
We continue using the notation $(\EE, \iota_\EE, \lambda_\EE)$ as the triple over $\FF$
whose Rosati involution has signature $(1,0)$.

Moreover, we will take the identification
\[ \End(\EE) \simeq \OO_\DD \]
see \cite[Remark 2.5]{ref:KR},
and hence the corresponding identification
\[ \VV_n^- \simeq \DD. \]
Under this identification
the Hermitian form on $\VV_n^-$ then corresponds to the
symmetric form on $\DD$ in the obvious way:
\[ \left\langle u_1, u_2 \right\rangle_{\VV_n^-}
  = \left\langle u_1, u_2^\ast \right\rangle_{\DD}. \]

\section{Setup for $\guv$ and $(g,u)$, and the invariants for the matching}
\subsection{The invariants for the orbit of $\guv$}
From \Cref{ch:orbitalFJ0}, recall that we considered
\[
  (\gamma, \uu, \vv^\top)
  =
  \left( \begin{bmatrix} a & b \\ c & d \end{bmatrix}
    \begin{bmatrix} 0 \\ 1 \end{bmatrix}, \begin{bmatrix} 0 & e \end{bmatrix} \right)
\]
subject to the conditions
\begin{align*}
  \bar b c = b \bar c &= 1 - a \bar a = 1 - d \bar d \\
  \text{and } d &= - \bar a c / \bar c = -\bar a b / \bar b.
\end{align*}
It will again be enough to consider the situation in which $\det \gamma = 1$.
The invariants in this case as described in \Cref{def:matching_semi_lie} are:
\begin{itemize}
  \ii $\Tr \gamma = a + d$
  \ii $\det \gamma = 1$
  \ii $\vv^\top \uu = e$
  \ii $\vv^\top \gamma \uu = \begin{bmatrix} 0 & e \end{bmatrix}
  \begin{bmatrix} a & b \\ c & d \end{bmatrix} \begin{bmatrix} 0 \\ 1 \end{bmatrix} = de$.
\end{itemize}
Note that the parameters $b$ and $c$ are absent; but we have
\[ v(b) + v(c) = v(1 - a \bar a). \]

\subsection{The invariants for the orbit of $(g,u)$}
We specialize to the situation where $u \in \OO_\DD$, and we have
\[ g \in \SU(\VV_n^-) = \left\{
    \begin{bmatrix} \alpha & \beta \\ \varpi\bar\beta & \bar\alpha \end{bmatrix}
    \mid \alpha, \beta \in E \right\}. \]
\todo{what is the correspondence here?}
By abuse of notation we will write $g$ by simply an element of $\OO_\DD$ as well:
\[ g = \alpha + \beta \Pi \in \OO_\DD \qquad \alpha, \beta \in E. \]
we also impose coordinates for $u$ according to
\[ u = s + t \Pi \in \OO_\DD \qquad s, t \in E. \]
Hence the four corresponding invariants of \Cref{def:matching_semi_lie} are:
\begin{itemize}
  \ii $\tr g = \alpha + \bar\alpha$
  \ii $\det g = \alpha \bar \alpha - \beta \bar\beta \varpi = 1$
  \ii The quantity
  \[ \left\langle u,u \right\rangle = 2 \Nm u = 2(s \bar s - t \bar t \varpi) \]
  \ii The quantity
  \begin{align*}
    \left\langle gu, u \right\rangle
    &= \left\langle (\alpha + \beta \Pi)(s + t \Pi), s + t \Pi \right\rangle \\
    &= \left\langle (\alpha s + \beta \bar t \varpi) + (\alpha t + \beta \bar s) \Pi,
      s + t \Pi \right\rangle \\
    &= \tr [((\alpha s + \beta \bar t \varpi) + (\alpha t + \beta \bar s) \Pi) (\bar s - t \Pi)] \\
    &= \tr\left[
      (\alpha s \bar s + \beta \bar s \bar t \varpi
      - (\alpha t \bar t + \beta \bar s \bar t) \varpi)
      + (-\alpha s t - \beta t \bar t + \alpha s t + \beta s \bar s) \Pi
    \right] \\
    &= \tr\left[
      \alpha (s \bar s - t \bar t \varpi)
      + \beta(s \bar s - t \bar t) \Pi
    \right] \\
    &= (\alpha + \bar\alpha) (s \bar s - t \bar t \varpi) \\
    &= 2\alpha_0 \Nm u.
  \end{align*}
  Here we consider $\alpha \in E$ as $\alpha + 0 \Pi \in \DD$ in the obvious way,
  so that we may use the notation $\alpha_0$.
\end{itemize}
\section{Background on special divisors for $n = 2$}
\subsection{The Rapoport-Zink space $\RZ_2$}
For integers $r \ge 0$, if we consider the functions
\[ f_r \coloneqq \mathbf{1}_{\varpi^{-r} \Mat_2(\OO_E) \cap \U(\VV_n^+)} \in \HH(\U(\VV_n^+)) \]
then these functions produce a basis for the Hecke algebra $\HH(\U(\VV_n^+))$.
Let us abbreviate
\[ \mathcal{T}_r \coloneqq \mathcal{T}_{\mathbf{1}_K \otimes f_r} \]
moving forward.
Then as described in the previous section we have a diagram
\begin{center}
\begin{tikzcd}
  & \ar[ld] \mathcal{T}_r \ar[rd] & \\
  \RZ_{2} && \RZ_{2}.
\end{tikzcd}
\end{center}

\subsection{The Lubin-Tate space $\MM_2$ and the divisor $\ZO4$ on $\MM_2 \times \MM_2$}
We introduce the notation $\MM_2$ for the \emph{Lubin-Tate space} for $n = 2$.
It's parametrized by tuples $(Y, \rho)$
where $Y$ is a one-dimensional strict formal $\OO_F$-module of height $2$,
and $\rho$ is a framing of a fixed Lubin-Tate module $\mathbb{Y}$.\todo{should this be $\EE$?}

\begin{proposition}
  [{\cite[Example 5.5.6]{ref:AFLspherical}}]
  The Serre tensor construction produces an identification
  \[ \Serre \colon \RZ_2 \xrightarrow{\sim} \MM_2. \]
  By abuse of notation we will also use the same symbol for the map
  \[ \Serre \colon \RZ_{2,2} \xrightarrow{\sim} \MM_2 \times \MM_2. \]
\end{proposition}

Now we define the special orthogonal divisor $\ZO4(u)$
on $\MM_2 \times \MM_2$ as follows.
\begin{definition}
  Let $u \in \OO_\DD$.
  Then we define the divisor $\ZO4(u)$ to be
  the pairs $(X, X') \in \MM_2 \times \MM_2$
  for which we have a diagram\todo{Is there a better term than ``diagram'' here?}
  \begin{center}
  \begin{tikzcd}
    X \ar[r, "\varphi"] \ar[d, dash] & X' \ar[d, dash] \\
    \EE \ar[r, "u"] & \EE.
  \end{tikzcd}
  \end{center}
\end{definition}
\begin{conjecture}
  The Serre tensor construction gives an isomorphism
  \[ \mathcal{T}_r \simeq \ZO4(\varpi^r) \]
  such that we get an analogous diagram
  \begin{center}
  \begin{tikzcd}
    & \ar[ld] \ZO4(\varpi^r) \ar[rd] & \\
    \MM_{2} && \MM_{2}.
  \end{tikzcd}
  \end{center}
\end{conjecture}

\subsection{The divisor $\ZO3$ on $\MM_2$}
Turning to $\MM_2 \times \MM_2$, we will henceforth always identify $\MM_2$
with its image under the diagonal map
\begin{center}
\begin{tikzcd}
  \ZO4(1) \ar[r, "\sim"] & \MM_2 \ar[r, hook, "\Delta_{\MM_2}"] & \MM_2 \times \MM_2.
\end{tikzcd}
\end{center}

\begin{definition}
  Suppose now $u \in \DT$.
  Then we define the divisor $\ZO3(u)$ to be those $X \in \MM_2$
  for which we have a diagram
  \begin{center}
  \begin{tikzcd}
    X \ar[r, "\varphi"] \ar[d, dash] & X \ar[d, dash] \\
    \EE \ar[r, "u"] & \EE.
  \end{tikzcd}
  \end{center}
  Note that basically by definition, for $u \in \OO_\DD$ and $\Tr u = 0$ we have
  \[ \ZO3(u) \simeq \ZO4(u) \cap \ZO4(1) \]
  when we identify $\MM_2$ with its image in $\MM_2 \times \MM_2$.
\end{definition}

\section{Comparison of the unitary and orthogonal special divisors}
We now relate $\ZD(u)$ to $\ZO3(u)$ through our
isomorphism $\RZ_{2,2} \xrightarrow{\sim} \MM_2 \times \MM_2$.
Recall that we have the notation
\[ \ZD(u)^\circ \coloneqq \ZD(u) - \ZD\left( \frac{u}{\varpi} \right). \]
Define $\ZO4(u)^\circ$ and $\ZO3(u)^\circ$ similarly.

\begin{conjecture}
  Let $u \in \VV_n^-$, and consider it as an element $u \in \DD$.
  Then pullback along the Serre tensor construction identifies
  \[ \Serre^\ast \ZD(u)^\circ \simeq \ZO3(u^\ast \sqrt{\eps} u)^\circ. \]
\end{conjecture}

\section{The intersection number as a triple product}
We return to the intersection number
\[ \chi_{\RZ_{n,n}} \left(
      \Sheaf_{\TT_{\mathbf{1} \otimes f_r}(\Delta_{\ZD(u)})}
      \jiao_{\Sheaf_{\RZ_{n,n}}} \SO_{\Gamma_g} \right) \]
which we will rewrite more succinctly using angle brackets as
\[ \Big\langle (1,g) \cdot \mathcal{T}_r, \; \Delta(\ZD(u)) \Big\rangle_{\RZ_{2,2}} \]
in analogy to \cite[\S6.1]{ref:AFLspherical}.
(Note that $\Delta$ here is the diagonal map $\RZ_2 \to \RZ_{2,2}$.)
For this calculation, it would be sufficient to split
\[ \ZD(u) = \sum_{i \ge 0} \ZD(u/\varpi^i)^\circ. \]
So, we proceed to compute
\begin{align*}
  \Big\langle (1,g) \cdot \mathcal{T}_r, \; \Delta(\ZD(u)^\circ) \Big\rangle_{\RZ_{2,2}}
  &= \left< \ZO4(\varpi^r g), \; \Delta(\Serre^\ast(\ZD(u))^\circ) \right>_{\MM_2 \times \MM_2} \\
  &= \left< \ZO4(\varpi^r g), \; \ZO3(u^\ast \sqrt{\eps} u)^\circ \right>_{\MM_2 \times \MM_2} \\
  &= \left< \ZO4(\varpi^r g), \; \ZO4(1)^\circ, \; \ZO4(u^\ast \sqrt{\eps} u)^\circ \right>_{\MM_2 \times \MM_2} \\
  &= \left< \ZO4(\varpi^r g), \; \ZO4(1), \; \ZO4(u^\ast \sqrt{\eps} u)^\circ \right>_{\MM_2 \times \MM_2}.
\end{align*}
We know that
\[ \varpi^r g = \varpi^r \alpha + \varpi^r \beta \Pi. \]
We can also compute:
\begin{align*}
  u^\ast \sqrt{\eps} u
  &= (\ol s - t \Pi) \sqrt{\eps} (s + t \Pi) \\
  &= (\ol s - t \Pi) (s \sqrt{\eps} + t \sqrt{\eps} \Pi) \\
  &= s \ol s \sqrt{\eps} - t \ol{s\sqrt{\eps}} \Pi + \ol s t \sqrt{\eps} \Pi - t \ol{t \sqrt{\eps}} \varpi \\
  &= (s \ol s + t \ol t \varpi) \sqrt{\eps} + 2 \ol s t \sqrt{\eps} \Pi.
\end{align*}

\section{The formula of Gross-Keating}
\begin{proposition}
  Let $x,y \in \OO_\DD$ and let
  \begin{align*}
    n_1 &= \min\left( v(\left\langle x,x \right\rangle), v(\left\langle x,y \right\rangle), v(\left\langle y,y \right\rangle) \right) \\
    n_2 &= v\left( \left\langle x,x \right\rangle \left\langle y,y \right\rangle - \left\langle x,y \right\rangle^2 \right)
  \end{align*}
  so that $0 \le n_1 \le n_2$.
  Then
  \begin{align*}
    &\left< \ZO4(1), \; \ZO4(x)^\circ, \; \ZO4(y)^\circ \right>_{\MM_2 \times \MM_2} \\
    &=
    \begin{cases}
      \sum_{j=0}^{\frac{n_1-1}{2}} (n_1+n_2-4j) p^j & \text{if } n_1 \equiv 1 \pmod 2 \\
      \frac{n_2-n_1+1}{2} p^{n_1/2} + \sum_{j=0}^{n_1/2-1} (n_1+n_2-4j) p^j & \text{if } n_1 \equiv 0 \pmod 2.
    \end{cases}
  \end{align*}
\end{proposition}
\begin{proof}
  This is a rewriting of \cite[Proposition 14.6]{ref:Kudla1997}
  which is itself a special case of \cite[Proposition 5.4]{ref:GK}.
\end{proof}
From now on, we use the notation
\begin{align*}
  x &\coloneqq u^\ast \sqrt{\eps} u = (s \bar s + t \bar t \varpi) \sqrt{\eps} + 2 \bar s t \sqrt{\eps} \Pi \in \OO_\DD \\
  y &\coloneqq \varpi^r g \in \OO_\DD.
\end{align*}
Then we can compute
\begin{align*}
  \left\langle x,x \right\rangle &= 2 \Nm x \\
  &= 2 (\Norm_{E/F}((s \bar s + t \bar t \varpi)\sqrt{\eps})
    - \Norm_{E/F}(2 \bar s t \sqrt{\eps}) \varpi) \\
  &= 2\left( -\eps(s \bar s + t \bar t \varpi)^2
    - (2\bar s t \sqrt{\eps})(-2s \bar t \sqrt{\eps}) \varpi \right) \\
  &= 2\left( -\eps(s \bar s + t \bar t \varpi)^2
    + 4s\bar s t \bar t \eps \varpi \right) \\
  &= -2\eps\left( (s \bar s - t \bar t \varpi)^2 \right) = -2\eps (\Nm u)^2. \\
  \left\langle x,y \right\rangle &= \tr(x y^\ast) \\
  &= \tr \left[
    \left( (s \bar s + t \bar t \varpi) \sqrt{\eps} + 2 \bar s t \sqrt{\eps} \Pi \right)
    \cdot \varpi^{r} (\bar\alpha - \beta \Pi)
  \right] \\
  &= \varpi^r \tr \left[
    \bar\alpha (s \bar s + t \bar t \varpi) \sqrt{\eps}
    + 2 \alpha \bar s t \sqrt{\eps} \Pi
    - \beta (s \bar s + t \bar t \varpi) \sqrt{\eps} \Pi
    - \bar\beta 2 \bar s t \varpi \sqrt{\eps}
  \right] \\
  &= \varpi^r \left(
    (\bar\alpha - \alpha)(s \bar s + t \bar t \varpi)
    + 2\varpi(\beta s \bar t - \bar\beta \bar s t)
  \right) \sqrt{\eps} \\
  \left\langle y,y \right\rangle &= 2 \Nm (\varpi^r g)
  = 2\varpi^{2r} (\alpha \bar\alpha - \beta\bar\beta \varpi).
\end{align*}
For the valuations of $\left\langle x,x \right\rangle$ and $\left\langle y,y \right\rangle$,
we are able to calculate these exactly:
\begin{align*}
  v(\left\langle x,x \right\rangle)
  &= 2v\left( s \bar s - t \bar t \varpi \right)
  = 2\min\left( 2v(s), 2v(t) +1 \right) \\
  v\left( \left\langle y,y \right\rangle \right)
  &= 2r + v\left( \alpha \bar \alpha - \beta \bar \beta \varpi \right)
  = 2r + \min\left( 2v(\alpha), 2v(\beta) + 1 \right).
\end{align*}

We now prove the following.
\begin{lemma}
  We always have
  \[
    v\left( \left\langle x,y \right\rangle \right) \ge
    \frac{v\left( \left\langle x,x \right\rangle \right)
      + v\left( \left\langle y,y \right\rangle \right)}{2}.
  \]
  Moreover, equality holds if and only if $v(\alpha) \le v(\beta)$.
\end{lemma}
\begin{proof}
  We use the estimate
  \begin{align*}
    v\left( \left\langle x,y \right\rangle  \right)
    &= r + v\left(
      (\bar\alpha - \alpha)(s \bar s + t \bar t \varpi)
      + 2\varpi(\beta s \bar t - \bar\beta \bar s t) \right) \\
    &\ge r + \min(
      v(\alpha) + \min(2v(s), 2v(t)+1),
      v(\beta) + v(s) + v(t) + 1
    ).
  \end{align*}
  Meanwhile,
  \begin{align*}
    \frac{v\left( \left\langle x,x \right\rangle \right) + v \left( \left\langle y,y \right\rangle \right)}{2}
    &= r + \min(2v(s), 2v(t)+1) + \half \min\left( 2v(\alpha), 2v(\beta) + 1 \right).
  \end{align*}
  Notice we obviously have the strict inequality
  \[ v(\beta) + v(s) + v(t) + 1 > \min(2v(s), 2v(t)+1)
    + \half \min(2v(\alpha), 2v(\beta)+1) \]
  while we
  \[ v(\alpha) + \min(2v(s), 2v(t)+1)
    \ge \min(2v(s), 2v(t)+1) + \half \min(2v(\alpha), 2v(\beta)+1) \]
  holds exactly for $v(\alpha) \le v(\beta)$, and is otherwise strict.
  Conversely, if $v(\alpha) \le v(\beta)$ then indeed
  \[ v(\alpha) + \min(2v(s), 2v(t)+1) < v(\beta) + v(s) + v(t) + 1. \]
  Hence the lemma is proved.
\end{proof}

\begin{lemma}
  We have
  \[ v( \left\langle x,x \right\rangle \left\langle y,y \right\rangle - \left\langle x,y \right\rangle^2)
    =
    2r + 2\min\left( 2v(s), 2v(t) +1 \right)
    +
    \begin{cases}
      \min\left( 2v(\alpha), 2v(\beta) + 1 \right).
      & \text{if } v(\alpha) < v(\beta) \\
      2v\left( \alpha_0 \right) & \text{otherwise}
    \end{cases}
  \]
  I hope.
\end{lemma}
\begin{proof}
  If $v(\alpha) > v(\beta)$
  then the preceding lemma implies that
  $ v( \left\langle x,x \right\rangle \left\langle y,y \right\rangle - \left\langle x,y \right\rangle^2)
  = v\left( \left\langle x,x \right\rangle \right) + v\left( \left\langle y,y \right\rangle \right)$
  and we're done.

  If $v(\alpha) \le v(\beta)$, we calculate the determinant
  \begin{align*}
    \left\langle x,x \right\rangle \left\langle y,y \right\rangle
    - \left\langle x,y \right\rangle^2
    &= -2\eps\left( (s \bar s - t \bar t \varpi)^2 \right)
      \cdot 2\varpi^{2r} (\alpha \bar\alpha - \beta\bar\beta \varpi) \\
    &\qquad- \varpi^{2r} \eps \left(
      (\bar\alpha - \alpha)(s \bar s + t \bar t \varpi)
      + 2\varpi(\beta s \bar t - \bar\beta \bar s t) \right)^2 \\
    &= -\varpi^{2r}\eps \Big[
      4 (s \bar s - t \bar t \varpi)^2 (\alpha \bar \alpha - \beta \bar\beta \varpi) \\
      &\qquad+ \left( (\bar\alpha - \alpha)(s \bar s + t \bar t \varpi)
      + 2\varpi(\beta s \bar t - \bar\beta \bar s t) \right)^2 \Big].
  \end{align*}
  The conclusion is equivalent to proving the bracketed term is nonzero modulo
  \[ \varpi^{v(\left\langle x,x \right\rangle) + v(\left\langle y,y \right\rangle) - 2r}
    = \varpi^{2v(\alpha)+2\min(2v(s), 2v(t)+1)+1}. \]
  Reducing the bracketed term modulo this power of $\varpi$ leaves just
  \[ 4 (s \bar s - t \bar t \varpi)^2 \alpha \bar \alpha
      + \left( (\bar\alpha - \alpha)(s \bar s + t \bar t \varpi) \right)^2 \]
\end{proof}
