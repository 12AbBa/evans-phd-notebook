\chapter{Intersection numbers for $\Int((g,u), f)$ for $n = 2$}
This chapter is dedicated to computing intersection numbers
for the semi-Lie version of AFL in the special case $n = 2$.

\section{Background on quaternion division algebra}
Through this section we let $\DD$ be a quaternion division algebra over $F$,
with a fixed maximal order $\OO_\DD$.
We will make $\DD$ explicit in the following way for our calculations to follow.

\subsection{Structure as a noncommutative algebra}
As $F$-vector spaces we will write
\[ \DD = E \oplus E \Pi \]
where $\Pi$ is selected so that $\Pi^2 = \varpi$.
We endow $\DD$ with a noncommutative multiplication according to
\[ \Pi t = \bar t \Pi \qquad \text{ for all } t \in E \]
where $\ol{t}$ is the image of $t \in E$ under the nontrivial element of $\Gal(E/F)$.

\subsection{Conjugation of elements of $\DD$}
In general, suppose $x \in \DD$ is any element
decomposed as $x = a + b \Pi$ for $a,b \in E$.
Then we denote by $x^\ast \in \DD$ the conjugate in $\DD$ defined by
\[ x^\ast \coloneqq \ol{a} - b \]
where, again, $a$ is the image of $a \in E$ under the nontrivial element of $\Gal(E/F)$.
It is an anti-involution, meaning that $(x^\ast)^\ast = x$ and $(xy)^\ast = y^\ast x^\ast$.

This allows us to define the reduced norm and trace in $\DD$.
The reduced trace is given by
\[ \tr x \coloneqq x + x^\ast = \Tr{E/F}(a) = 2x_0. \]
This coincides with half the trace of the
$F$-linear multiplication map $u \cdot - \colon \DD \to \DD$.
We may thus define
\[ \DT \coloneqq \left\{ u \in \DD \mid \tr u = 0 \right\} \]
which has codimension $1$ inside $\DD$ (i.e.\ is three-dimensional as an $F$-vector space).
Since $\tr(a+b\Pi) = \Tr_{E/F}(a)$, we could also write
\[ \DT = \{ a+b\Pi \mid a,b \in E \text{ and } \Tr_{E/F}(a) = 0 \}. \]

The reduced norm is similarly defined by
\begin{align*}
  \Nm x &= x x^\ast = (a + b \Pi)(\bar a - b \Pi) \\
  &= a \bar a + b \Pi \bar a - a b \Pi - b \Pi b \Pi \\
  &= a \bar a - b \bar b \varpi \\
  &= \Norm_{E/F}(a) - \Norm_{E/F}(b) \varpi .
\end{align*}
This coincides with a square root of
the determinant of the $F$-linear map $u \cdot - \colon \DD \to \DD$.

As an $F$-vector space, $\DD$ has a basis given by
$\{1, \sqrt{\eps}, \Pi, \sqrt{\eps}\Pi\}$, that is
\[ \DD = F \oplus F\sqrt\eps \oplus F \Pi \oplus F\sqrt\eps\Pi. \]
It will be convenient to introduce the following notation:
\begin{definition}
  For $x \in \DD$, we introduce the notation $x_0$ and $x_-$ to mean
  \begin{itemize}
    \ii $x_0$ is the projection into the first component $F$; and
    \ii $x_- = x - x_0$ is the projection into
    $\DT = F\sqrt\eps \oplus F \Pi \oplus F\sqrt\eps\Pi$.
  \end{itemize}
\end{definition}
In particular, the formula for conjugation then reads as the simpler
\[ x^\ast = x_0 - x_-. \]

\subsection{Identification of $\VV_n^-$ with $\DD$}
We continue using the notation $(\EE, \iota_\EE, \lambda_\EE)$ as the triple over $\FF$
whose Rosati involution has signature $(1,0)$.

Moreover, we will take the identification
\[ \End(\EE) \simeq \OO_\DD \]
see \cite[Remark 2.5]{ref:KR},
and hence the corresponding identification
\[ \VV_n^- \simeq \DD \]
where we  now equip $\DD$ with a $E/F$-Hermitian form
$\left\langle \bullet, \bullet \right\rangle \colon \DD \times \DD \to E$
defined by
\[ \left\langle x,y \right\rangle = \half \Tr_{\DD/E}(xy^\ast) \]
i.e.\. the projection of $xy^\ast \in \DD = E \oplus E\Pi$ onto the first component.
In particular, note that
\[ \left\langle x,x \right\rangle  = x x^\ast = \Nm x. \]

\section{Setup for $\guv$ and $(g,u)$, and the invariants for the matching}
\subsection{The invariants for the orbit of $\guv$}
From \Cref{ch:orbitalFJ0}, recall that we considered
\[
  (\gamma, \uu, \vv^\top)
  =
  \left( \begin{bmatrix} a & b \\ c & d \end{bmatrix}
    \begin{bmatrix} 0 \\ 1 \end{bmatrix}, \begin{bmatrix} 0 & e \end{bmatrix} \right)
\]
subject to the conditions
\begin{align*}
  \bar b c = b \bar c &= 1 - a \bar a = 1 - d \bar d \\
  \text{and } d &= - \bar a c / \bar c = -\bar a b / \bar b.
\end{align*}
It will again be enough to consider the situation in which $\det \gamma = 1$.
The invariants in this case as described in \Cref{def:matching_semi_lie} are:
\begin{itemize}
  \ii $\Tr \gamma = a + d$
  \ii $\det \gamma = 1$
  \ii $\vv^\top \uu = e$
  \ii $\vv^\top \gamma \uu = \begin{bmatrix} 0 & e \end{bmatrix}
  \begin{bmatrix} a & b \\ c & d \end{bmatrix} \begin{bmatrix} 0 \\ 1 \end{bmatrix} = de$.
\end{itemize}
Note that the parameters $b$ and $c$ are absent; but we have
\[ v(b) + v(c) = v(1 - a \bar a). \]

\subsection{The invariants for the orbit of $(g,u)$}
We specialize to the situation where $u \in \OO_\DD$, and we have
\[ g \in \SU(\VV_n^-) = \left\{
    \begin{bmatrix} \alpha & \beta \\ \varpi\bar\beta & \bar\alpha \end{bmatrix}
    \mid \alpha, \beta \in E \right\}. \]
\todo{what is the correspondence here?}
By abuse of notation we will write $g$ by simply an element of $\OO_\DD$ as well:
\[ g = \alpha + \beta \Pi \in \OO_\DD \qquad \alpha, \beta \in E. \]
we also impose coordinates for $u$ according to
\[ u = s + t \Pi \in \OO_\DD \qquad s, t \in E. \]
Hence the four corresponding invariants of \Cref{def:matching_semi_lie} are:
\begin{itemize}
  \ii $\tr g = \alpha + \bar\alpha$
  \ii $\det g = \alpha \bar \alpha - \beta \bar\beta \varpi = 1$
  \ii The quantity
  \[ \left\langle u,u \right\rangle = 2 \Nm u = 2(s \bar s - t \bar t \varpi) \]
  \ii The quantity
  \begin{align*}
    \left\langle gu, u \right\rangle
    &= \left\langle (\alpha + \beta \Pi)(s + t \Pi), s + t \Pi \right\rangle \\
    &= \left\langle (\alpha s + \beta \bar t \varpi) + (\alpha t + \beta \bar s) \Pi,
      s + t \Pi \right\rangle \\
    &= \half \Tr_{\DD/E} [((\alpha s + \beta \bar t \varpi) + (\alpha t + \beta \bar s) \Pi) (\bar s - t \Pi)] \\
    &= \half \Tr_{\DD/E} \left[
      (\alpha s \bar s + \beta \bar s \bar t \varpi
      - (\alpha t \bar t + \beta \bar s \bar t) \varpi)
      + (-\alpha s t - \beta t \bar t \varpi + \alpha s t + \beta s \bar s) \Pi
    \right] \\
    &= \half \Tr_{\DD/E} \left[
      \alpha (s \bar s - t \bar t \varpi)
      + \beta(s \bar s - t \bar t) \Pi \right] \\
    &= \alpha (s \bar s - t \bar t \varpi) \\
    &= \alpha \left\langle u,u \right\rangle.
  \end{align*}
\end{itemize}

For simplicity, we are going to make the following assumption on $u$,
although it will not be used until we use the Gross-Keating formula.
\begin{assume}
  We have $u \in E$ or $u \in E \Pi$.
  That is, either $s = 0$ or $t = 0$.
  \label{assume:st_zero}
\end{assume}

This assumption can be made without loss of generality because
the invariants above and the intersection only depend
on the $\SU(2)$-orbit of the pair $(g,u)$,
and any element $u \in \DD^\times$ can be mapped under an element of $\SU(2)$
into a pair for which $u \in E$ or $u \in E \Pi$.

\section{Background on special divisors for $n = 2$}
\subsection{The Rapoport-Zink space $\RZ_2$}
For integers $r \ge 0$, if we consider the functions
\[ f_r \coloneqq \mathbf{1}_{\varpi^{-r} \Mat_2(\OO_E) \cap \U(\VV_n^+)} \in \HH(\U(\VV_n^+)) \]
then these functions produce a basis for the Hecke algebra $\HH(\U(\VV_n^+))$.
Let us abbreviate
\[ \mathcal{T}_r \coloneqq \mathcal{T}_{\mathbf{1}_K \otimes f_r} \]
moving forward.
Then as described in the previous section we have a diagram
\begin{center}
\begin{tikzcd}
  & \ar[ld] \mathcal{T}_r \ar[rd] & \\
  \RZ_{2} && \RZ_{2}.
\end{tikzcd}
\end{center}

\subsection{The Lubin-Tate space $\MM_2$ and the divisor $\ZO4$ on $\MM_2 \times \MM_2$}
We introduce the notation $\MM_2$ for the \emph{Lubin-Tate space} for $n = 2$.
It's parametrized by tuples $(Y, \rho)$
where $Y$ is a one-dimensional strict formal $\OO_F$-module of height $2$,
and $\rho$ is a framing of a fixed Lubin-Tate module $\mathbb{Y}$.\todo{should this be $\EE$?}

\begin{proposition}
  [{\cite[Example 5.5.6]{ref:AFLspherical}}]
  The Serre tensor construction produces an identification
  \[ \Serre \colon \RZ_2 \xrightarrow{\sim} \MM_2. \]
  By abuse of notation we will also use the same symbol for the map
  \[ \Serre \colon \RZ_{2,2} \xrightarrow{\sim} \MM_2 \times \MM_2. \]
\end{proposition}

Now we define the special orthogonal divisor $\ZO4(u)$
on $\MM_2 \times \MM_2$ as follows.
\begin{definition}
  Let $u \in \OO_\DD$.
  Then we define the divisor $\ZO4(u)$ to be
  the pairs $(X, X') \in \MM_2 \times \MM_2$
  for which we have a diagram\todo{Is there a better term than ``diagram'' here?}
  \begin{center}
  \begin{tikzcd}
    X \ar[r, "\varphi"] \ar[d, dash] & X' \ar[d, dash] \\
    \EE \ar[r, "u"] & \EE.
  \end{tikzcd}
  \end{center}
\end{definition}
\begin{conjecture}
  The Serre tensor construction gives an isomorphism
  \[ \mathcal{T}_r \simeq \ZO4(\varpi^r) \]
  such that we get an analogous diagram
  \begin{center}
  \begin{tikzcd}
    & \ar[ld] \ZO4(\varpi^r) \ar[rd] & \\
    \MM_{2} && \MM_{2}.
  \end{tikzcd}
  \end{center}
\end{conjecture}

\subsection{The divisor $\ZO3$ on $\MM_2$}
Turning to $\MM_2 \times \MM_2$, we will henceforth always identify $\MM_2$
with its image under the diagonal map
\begin{center}
\begin{tikzcd}
  \ZO4(1) \ar[r, "\sim"] & \MM_2 \ar[r, hook, "\Delta_{\MM_2}"] & \MM_2 \times \MM_2.
\end{tikzcd}
\end{center}

\begin{definition}
  Suppose now $u \in \DT$.
  Then we define the divisor $\ZO3(u)$ to be those $X \in \MM_2$
  for which we have a diagram
  \begin{center}
  \begin{tikzcd}
    X \ar[r, "\varphi"] \ar[d, dash] & X \ar[d, dash] \\
    \EE \ar[r, "u"] & \EE.
  \end{tikzcd}
  \end{center}
  Note that basically by definition, for $u \in \OO_\DD$ and $\Tr u = 0$ we have
  \[ \ZO3(u) \simeq \ZO4(u) \cap \ZO4(1) \]
  when we identify $\MM_2$ with its image in $\MM_2 \times \MM_2$.
\end{definition}

\section{Comparison of the unitary and orthogonal special divisors}
We now relate $\ZD(u)$ to $\ZO3(u)$ through our
isomorphism $\RZ_{2,2} \xrightarrow{\sim} \MM_2 \times \MM_2$.
Recall that we have the notation
\[ \ZD(u)^\circ \coloneqq \ZD(u) - \ZD\left( \frac{u}{\varpi} \right). \]
Define $\ZO4(u)^\circ$ and $\ZO3(u)^\circ$ similarly.

\begin{conjecture}
  Let $u \in \VV_n^-$, and consider it as an element $u \in \DD$.
  Then pullback along the Serre tensor construction identifies
  \[ \Serre^\ast \ZD(u)^\circ \simeq \ZO3(u^\ast \sqrt{\eps} u)^\circ. \]
\end{conjecture}

\section{The intersection number as a triple product}
We return to the intersection number
\[ \chi_{\RZ_{n,n}} \left(
      \Sheaf_{\TT_{\mathbf{1} \otimes f_r}(\Delta_{\ZD(u)})}
      \jiao_{\Sheaf_{\RZ_{n,n}}} \SO_{\Gamma_g} \right) \]
which we will rewrite more succinctly using angle brackets as
\[ \Big\langle (1,g) \cdot \mathcal{T}_r, \; \Delta(\ZD(u)) \Big\rangle_{\RZ_{2,2}} \]
in analogy to \cite[\S6.1]{ref:AFLspherical}.
(Note that $\Delta$ here is the diagonal map $\RZ_2 \to \RZ_{2,2}$.)
For this calculation, it would be sufficient to split
\[ \ZD(u) = \sum_{i \ge 0} \ZD(u/\varpi^i)^\circ. \]
So, we proceed to compute
\begin{align*}
  \Big\langle (1,g) \cdot \mathcal{T}_r, \; \Delta(\ZD(u)^\circ) \Big\rangle_{\RZ_{2,2}}
  &= \left< \ZO4(\varpi^r g), \; \Delta(\Serre^\ast(\ZD(u))^\circ) \right>_{\MM_2 \times \MM_2} \\
  &= \left< \ZO4(\varpi^r g), \; \ZO3(u^\ast \sqrt{\eps} u)^\circ \right>_{\MM_2 \times \MM_2} \\
  &= \left< \ZO4(\varpi^r g), \; \ZO4(1)^\circ, \; \ZO4(u^\ast \sqrt{\eps} u)^\circ \right>_{\MM_2 \times \MM_2} \\
  &= \left< \ZO4(\varpi^r g), \; \ZO4(1), \; \ZO4(u^\ast \sqrt{\eps} u)^\circ \right>_{\MM_2 \times \MM_2}.
\end{align*}
We know that
\[ \varpi^r g = \varpi^r \alpha + \varpi^r \beta \Pi. \]
\section{The formula of Gross-Keating}
In what follows, we let
\[ \left\langle x, y \right\rangle _0
  = \frac{\left\langle x,y \right\rangle + \ol{\left\langle x,y \right\rangle}}{2} \]
denote half the $E/F$-trace of the $\left\langle x,y \right\rangle$.
Let $\ODT \coloneqq \OO_\DD \cap \DT$.

\begin{proposition}
  Let $x,y \in \ODT$ and let
  \begin{align*}
    n_1 &= \min\left( v(\left\langle x,x \right\rangle _0), v(\left\langle x,y \right\rangle _0), v(\left\langle y,y \right\rangle _0) \right) \\
    n_2 &= v\left( \left\langle x,x \right\rangle _0 \left\langle y,y \right\rangle _0 - \left\langle x,y \right\rangle^2_0 \right)
  \end{align*}
  so that $0 \le n_1 \le n_2$.
  Then
  \begin{align*}
    &\left< \ZO4(1), \; \ZO4(x)^\circ, \; \ZO4(y)^\circ \right>_{\MM_2 \times \MM_2} \\
    &=
    \begin{cases}
      \sum_{j=0}^{\frac{n_1-1}{2}} (n_1+n_2-4j) p^j & \text{if } n_1 \equiv 1 \pmod 2 \\
      \frac{n_2-n_1+1}{2} p^{n_1/2} + \sum_{j=0}^{n_1/2-1} (n_1+n_2-4j) p^j & \text{if } n_1 \equiv 0 \pmod 2.
    \end{cases}
  \end{align*}
\end{proposition}
\begin{proof}
  This is a rewriting of \cite[Proposition 14.6]{ref:Kudla1997}
  which is itself a special case of \cite[Proposition 5.4]{ref:GK}.
\end{proof}

We now compute all the quantities needed to invoke the Gross-Keating formula.
We start by writing
\begin{align*}
  u^\ast \sqrt{\eps} u
  &= (\ol s - t \Pi) \sqrt{\eps} (s + t \Pi) \\
  &= (\ol s - t \Pi) (s \sqrt{\eps} + t \sqrt{\eps} \Pi) \\
  &= s \ol s \sqrt{\eps} - t \ol{s\sqrt{\eps}} \Pi + \ol s t \sqrt{\eps} \Pi - t \ol{t \sqrt{\eps}} \varpi \\
  &= (s \ol s + t \ol t \varpi) \sqrt{\eps} + 2 \ol s t \sqrt{\eps} \Pi.
\end{align*}
We now invoke \Cref{assume:st_zero} for the first time to simplify this to just
\[ u^\ast \sqrt{\eps} u = (s \ol s + t \ol t \varpi) \sqrt{\eps}. \]
This assumption will also let us write
\[ (s \ol s + t \ol t \varpi)^2 = (s \ol s - t \ol t \varpi)^2 = (\Nm u)^2. \]

From now on, we will write
\[ \alpha = \alpha_0 + \alpha_1 \sqrt{\eps} \qquad \alpha_0, \alpha_1 \in F \]
and use the notation
\begin{align*}
  x &\coloneqq u^\ast \sqrt{\eps} u = (s \bar s + t \bar t \varpi) \sqrt{\eps} \in \ODT \\
  y &\coloneqq \varpi^r g_- = (\alpha_1\sqrt\eps + \beta \Pi) \in \ODT.
\end{align*}

Then we can compute
\begin{align*}
  \left\langle x,x \right\rangle _0 &= \Nm x \\
  &= \Norm_{E/F}((s \bar s + t \bar t \varpi)\sqrt{\eps}) \\
  &= -\eps(s \bar s + t \bar t \varpi)^2 = -\eps (\Nm u)^2 \\
  \left\langle y,y \right\rangle _0 &= \Nm (\varpi^r g_-) \\
  &= \varpi^{2r} (-\alpha_1^2 \eps - \beta\bar\beta \varpi) \\
  &= \varpi^{2r} (\alpha\bar\alpha - \beta\bar\beta \varpi - \alpha_0^2) \\
  &= \varpi^{2r}(\det g - \alpha_0^2) \\
  \left\langle x,y \right\rangle _0 &= (x y^\ast)_0 \\
  &= \left( \left( (s \bar s + t \bar t \varpi) \sqrt{\eps} \right)
    \cdot \varpi^{r} (-\alpha_1\sqrt{\eps} - \beta \Pi) \right)_0 \\
  &= \varpi^r \left( -\alpha_1 (s \bar s + t \bar t \varpi) \eps
    - \beta (s \bar s + t \bar t \varpi) \sqrt{\eps} \Pi \right)_0 \\
  &= - \varpi^r \alpha_1 \eps (s \bar s + t \bar t \varpi).
\end{align*}
This lets us compute the determinant
\begin{align*}
  \left\langle x,x \right\rangle _0 \left\langle y,y \right\rangle _0 - \left\langle x,y \right\rangle^2_0
  &= - \eps (\Nm u)^2\cdot \varpi^{2r} (\det g - \alpha_0^2)
  - (\varpi^r \alpha_1 \eps (s \bar s + t \bar t \varpi))^2 \\
  &= - \eps (\Nm u)^2\cdot \varpi^{2r} (\det g - \alpha_0^2)
  - (\varpi^r \alpha_1 \eps)^2 (\Nm u)^2 \\
  &= -\varpi^{2r} \eps (\Nm u)^2  \left( \det g - \alpha_0^2 + \eps \alpha_1^2 \right) \\
  &= -\varpi^{2r} \eps (\Nm u)^2  \left( \det g - \alpha \bar\alpha \right).
\end{align*}
