\chapter{Setup for the orbital integral for $S_3(F)$}
\label{ch:orbital1}

In this section we set up the framework of the orbital integral
based on the definitions in the previous section.
This involves rewriting the integral as an infinite discrete double sum
over two parameters $(n,m)$ that we will introduce later,
and determining the volume of the supports of the indicator function.

\section{Reparametrization in terms of valuations}
\subsection{Computation of value in indicator function}
We are integrating over $t_1 \in E$ and $t_2 \in E$.
Regarding $h' \in H'$ as an element of $\GL_3(E)$ as described before, we have
\[ h' = \begin{bmatrix}
  t_1 & t_2 & 0  \\
  \bar t_2 & \bar t_1 & 0 \\
  0 & 0 & 1
  \end{bmatrix}. \]
We therefore have
\[ \bar{h'}\inv = \begin{bmatrix}
  \frac{t_1}{t_1 \bar t_1 - t_2 \bar t_2} & \frac{-\bar t_2}{t_1 \bar t_1 - t_2 \bar t_2} & 0 \\
  \frac{-t_2}{t_1 \bar t_1 - t_2 \bar t_2} & \frac{\bar t_1}{t_1 \bar t_1 - t_2 \bar t_2} & 0 \\
  0 & 0 & 1 \end{bmatrix}. \]
Hence
\begin{align*}
  \bar{h'} \inv \gamma h'
  &=
  \begin{bmatrix}
  \frac{t_1}{t_1 \bar t_1 - t_2 \bar t_2} & \frac{-\bar t_2}{t_1 \bar t_1 - t_2 \bar t_2} & 0 \\
  \frac{-t_2}{t_1 \bar t_1 - t_2 \bar t_2} & \frac{\bar t_1}{t_1 \bar t_1 - t_2 \bar t_2} & 0 \\
  0 & 0 & 1 \end{bmatrix}
  \begin{bmatrix}
    a & 0 & 0 \\
    b & - \bar d & 1 \\
    c & 1 - d \bar d & d
  \end{bmatrix}
  \begin{bmatrix}
  t_1 & t_2 & 0  \\
  \bar t_2 & \bar t_1 & 0 \\
  0 & 0 & 1
  \end{bmatrix} \\
  &=
  \begin{bmatrix}
  \frac{t_1}{t_1 \bar t_1 - t_2 \bar t_2} & \frac{-\bar t_2}{t_1 \bar t_1 - t_2 \bar t_2} & 0 \\
  \frac{-t_2}{t_1 \bar t_1 - t_2 \bar t_2} & \frac{\bar t_1}{t_1 \bar t_1 - t_2 \bar t_2} & 0 \\
  0 & 0 & 1 \end{bmatrix}
  \begin{bmatrix}
    at_1 & at_2 & 0 \\
    bt_1 - \bar d \bar t_2 & b t_2 - \bar d \bar t_1 & 1 \\
    ct_1 + (1-d\bar d)\bar t_2 & ct_2 + (1-d \bar d) \bar t_1 & d
  \end{bmatrix}
  \\
  &=
  \begin{bmatrix}
    \dfrac{at_1^2 - bt_1 \bar t_2 + d \bar t_2^2}{t_1 \bar t_1 - t_2 \bar t_2}
    & \dfrac{at_1t_2 - bt_2 \bar t_2 + \bar d \bar t_1 \bar t_2}{t_1 \bar t_1 - t_2 \bar t_2}
    & \dfrac{-\bar t_2}{t_1 \bar t_1 - t_2 \bar t_2} \\[2ex]
    \dfrac{-at_1t_2+bt_1\bar t_1-\bar d \bar t_1 \bar t_2}{t_1 \bar t_1 - t_2 \bar t_2}
    & \dfrac{-at_2^2+b\bar t_1 t_2-d\bar t_1^2}{t_1 \bar t_1 - t_2 \bar t_2}
    & \dfrac{\bar t_1}{t_1 \bar t_1 - t_2 \bar t_2} \\[2ex]
    ct_1 + (1-d\bar d)\bar t_2 & ct_2 + (1-d \bar d) \bar t_1 & d
  \end{bmatrix}
\end{align*}
At this point, note that the entry $d$ appears by itself at the bottom-right.
Consequently, the orbital integral is zero if $v(d) < -r$.
This justifies \Cref{assume:vd_ge_minus_r} from before.

Let us define
\[ t = t_2 \bar t_1 \inv \iff t_2 = t \bar t_1. \]
This lets us rewrite everything in terms of the ratio $t$ and $t_1 \in E$:
\[
  \bar{h'} \inv \gamma h'
  =
  \begin{bmatrix}
    \dfrac{t_1^2(a-b\bar t+\bar d \bar t^2)}{t_1 \bar t_1(1-t \bar t)}
    & \dfrac{t_1 \bar t_1(at-bt\bar t+\bar d \bar t)}{t_1 \bar t_1(1-t \bar t)}
    & \dfrac{t_1 \cdot (-\bar t)}{t_1 \bar t_1 (1-t \bar t)} \\[2ex]
    \dfrac{t_1\bar t_1(-at+b-\bar d \bar t)}{t_1 \bar t_1(1-t \bar t)}
    & \dfrac{\bar t_1^2(-at^2+bt-\bar d)}{t_1 \bar t_1(1-t \bar t)}
    & \dfrac{-\bar t_1}{t_1 \bar t_1(1-t \bar t)} \\[2ex]
    t_1(c + (1-d\bar d)\bar t) & \bar t_1(ct + (1-d \bar d)) & d
  \end{bmatrix}
\]
This new parametrization is better because $t_1$ only plays the role of
a scale factor on the outside, with ``interesting'' terms only involving $t$.
To make this further explicit, we write
\[ t_1 = \varpi^{-m} \epsilon \]
for $m \in \ZZ$ and $\epsilon \in \OO_E^\times$.
Then
\begin{align*}
  &\phantom=
  \begin{bmatrix} \bar\epsilon \\ & \epsilon \\ & & 1 \end{bmatrix}
  \bar{h'} \inv \gamma h'
  \begin{bmatrix} \epsilon\inv \\ & \bar\epsilon\inv \\ & & 1 \end{bmatrix} \\
  &=
  \begin{bmatrix}
  \dfrac{a-b\bar t+\bar d \bar t^2}{1-t \bar t}
  & \dfrac{at-bt\bar t+\bar d \bar t}{1-t \bar t}
  & \dfrac{-\varpi^m \bar t}{1-t \bar t} \\[2ex]
  \dfrac{-at+b-\bar d \bar t}{1-t \bar t}
  & \dfrac{-at^2+bt-\bar d}{1-t \bar t}
  & \dfrac{-\varpi^m}{1-t \bar t} \\[2ex]
  \dfrac{c + (1-d\bar d)\bar t}{\varpi^m} & \dfrac{ct + (1-d \bar d)}{\varpi^m} & d
  \end{bmatrix}.
\end{align*}
For brevity, we will let $\Gamma(\gamma, t, m)$ denote the right-hand matrix.
The conjugation by
$\left[ \begin{smallmatrix} \epsilon\inv \\ & \bar\epsilon\inv \\ & & 1 \end{smallmatrix} \right]$
has no effect on any of the $K'_{S, \le r}$, so that we can simply use
\[ \mathbf{1}_{K'_{S, \le r}}(\bar{h'}\inv \gamma h') = \mathbf{1}_{K'_{S, \le r}}(\Gamma(\gamma, t, m)) \]
in the work that follows.
For brevity, we abbreviate
\[ \mathbf{1}_{\le r}(\gamma, t, m) \coloneqq \mathbf{1}_{K'_{S, \le r}}(\Gamma(\gamma, t, m)). \]

\subsection{Reparametrizing the integral in terms of $t$ and $m$}
From now on, following \cite[\S4]{ref:AFL} we always fix the notation
\begin{align*}
  m &= m(t_1) \coloneqq -v(t_1) \\
  n &= n(t) \coloneqq v(1-t\bar t).
\end{align*}
(At the risk of stating the obvious, this $n$ is not the same $n$ in $\GL_n$, etc.)
We need to rewrite the integral, phrased originally via $\odif{h'}$,
in terms of the parameters $t$ (hence $n$), $m$, and $\gamma$.
We start by observing that
\[ \det h' = t_1 \bar t_1 - t_2 \bar t_2 = t_1 \bar t_1 (1 - t\bar t) \]
which means that
\[ v(\det h') = -2m + n \]
ergo
\begin{align*}
\left\lvert \det h' \right\rvert_F &= q^{-v(\det h')} = q^{2m-n} \\
\eta(h') &= (-1)^{v(\det h')} = (-1)^n.
\end{align*}
Meanwhile, from $t_2 = t \bar t_1$ we derive
\[ \odif t_2 = \left\lvert t_1 \right\rvert_E \odif t = q^{2m} \odif t. \]

Bringing this all into the orbital integral gives
\begin{align*}
  \Orb(\gamma, \mathbf{1}_{K'_{S, \le r}} s)
  &= \kappa \int_{t, t_1 \in E} \mathbf{1}_{\le r}(\gamma, t, m)
  (-1)^n \left( q^{2m-n} \right)^{s-2} \odif t_1 \cdot (q^{2m} \odif t) \\
  &= \kappa \int_{t, t_1 \in E} \mathbf{1}_{\le r}(\gamma, t, m)
  (-1)^n q^{s(2m-n)} \cdot q^{2n-2m} \odif t \odif t_1.
\end{align*}

\section{Description of the support of $\mathbf{1}_{\le r}$ when $n \le 0$}
\begin{proposition}
  Whenever $n = 0$ (this requires $v(t) \geq 0$),
  \[
    \mathbf{1}_{\le r}(\gamma, t, m) =
    \begin{cases}
      1 & \text{if } -r \le m \le \delta+r \\
      0 & \text{otherwise.}
    \end{cases}
  \]
\end{proposition}
\begin{proof}
  We have to consider the nine entries of $\Gamma(\gamma, t, m)$ in tandem.

  The upper $2 \times 2$ matrix is always in $\omega^{-r}\OO_E$,
  because $v(t) \geq 0$, $v(d) \geq -r$, $v(b) \geq -r$, and $v(a) = 0$ suffices.

  In the right column, since $v(t) \geq 0$ and $n = 0$, the condition is simply $m \ge -r$.

  In the bottom row, we need
  \begin{align*}
    v\left( c+(1-d\bar d) \bar t \right)-m &\geq -r, \\
    v\left( ct +(1-d\bar d) \right)-m &\geq -r.
  \end{align*}
  If $v(t) > 0$ this is equivalent to $m-r \leq \delta$.
  In the case where $v(t) = 0$ we instead use the observation that
  \begin{equation}
    \left[ c + (1-d \bar d) \bar t \right]
    - \bar t \left[ ct + (1-d \bar d) \right] = (1-t\bar t) c
    \label{eq:ctrick}
  \end{equation}
  which forces at least one of $ct + (1-d \bar d)$ and $c + (1-d \bar d) \bar t$ to
  have valuation $\delta$. So the claim follows now.
\end{proof}

\begin{proposition}
  Suppose $n = -2k < 0$, equivalently, $v(t) = -k < 0$, for some $k$.
  \[
    \mathbf{1}_{\le r}(\gamma, t, m) =
    \begin{cases}
      1 & \text{if } -r \le m+k \le \delta+r \\
      0 & \text{otherwise.}
    \end{cases}
  \]
\end{proposition}
\begin{proof}
  The proof is similar to the previous claim, but simpler.

  Since $k > 0$, the fraction $\frac{t^2}{1-t \bar t}$ has positive valuation,
  so the upper $2 \times 2$ of $\Gamma(\gamma, t, m)$ is always in $\varpi^{-r}\OO_E$.
  Turning to the right column, the condition reads exactly $m+k \geq -r$.
  Finally, in the bottom row, from $v(t) > 0$ and $v(c) = \delta$
  the condition is simply $-k+\delta-m \geq -r$.
\end{proof}

\section{Description of the support of $\mathbf{1}_{\le r}$ when $n > 0$}
In this situation we evaluate over $n > 0$ only.
In this case $t$ is automatically a unit.

\subsection{Volume lemma}
The following two lemmas will be useful.

\begin{lemma}
  Let $\xi \in \OO_E^\times$, $\rho \in \ZZ$, and $n \ge \max(\rho, 1)$ an integer.
  Then
  \begin{align*}
    &\Vol\left( \left\{ x \in E \mid v(1-x \bar x) = n,
      \; v(x-\xi) \ge \rho \right\} \right) \\
    &=
    \begin{cases}
      0 & \text{if } v(1-\xi\bar\xi) < \rho \\
      q^{-n}(1-q^{-2}) & \text{if } \rho \le 0 \\
      q^{-(n+\rho)}(1-q\inv) & \text{if } v(1-\xi\bar\xi) \ge \rho \ge 1.
    \end{cases}
  \end{align*}
  \label{lem:volume}
\end{lemma}
\begin{proof}
  The case $\rho > 0$ is proved in \cite[Lemma 4.4]{ref:AFL}.

  When $\rho \le 0$, the condition $v(x - \xi) \ge \rho$ is vacuously true,
  so we just are computing
  $\Vol\left( \left\{ x \in E \mid v(1-x \bar x) = n \right\} \right)$.
  Follows from summing the previous lemma over $\rho = 1$
  and $\xi \in \OO_E / \varpi$ (there are $q_E-1 = q^2-1$ choices for $\xi$).
  \todo{This doesn't actually check out. Check margin of page 235 of notebook.}
\end{proof}

We also comment on the well-known fact that in an ultrametric space,
any two disks are either disjoint or one is contained in the other.
(In other words, the Mastercard logo cannot be drawn. See \Cref{fig:no_mastercard}.)
\begin{proposition}
  Choose $\xi_1, \xi_2 \in E$ and $\rho_1 \geq \rho_2$.
  Consider the two disks:
  \begin{align*}
    D_1 &= \left\{ x \in E \mid v(x-\xi_1) \ge \rho_1 \right\} \\
    D_2 &= \left\{ x \in E \mid v(x-\xi_2) \ge \rho_2 \right\}.
  \end{align*}
  Then, if $v(\xi_1-\xi_2) \geq \rho_2$, we have $D_1 \subseteq D_2$.
  If not, instead $D_1 \cap D_2 = \varnothing$.
  \label{prop:no_mastercard}
\end{proposition}
\begin{proof}
  Because $E$ is an ultrametric space and $\Vol(D_1) \leq \Vol(D_2)$,
  we either have $D_1 \subseteq D_2$ or $D_1 \cap D_2 = \varnothing$.
  The latter condition checks which case we are in by testing if $\xi_1 \in D_2$,
  since $\xi_1 \in D_1$.
\end{proof}
\todo{is it $q$ or $q_E$}

\begin{figure}
\centering
\begin{asy}
  defaultpen(fontsize(12pt));
  size(7cm);
  pair O1 = 0.57*dir(-30);
  pair O2 = (0,0);
  real r1 = 0.4;
  real r2 = 1;
  filldraw(circle(O2, r2), rgb(0.9, 0.9, 0.9));
  filldraw(circle(O1, r1), rgb(0.8, 0.8, 0.9));
  pair P1 = O1+r1*dir(230);
  pair P2 = O2+r2*dir( 70);
  draw(O1--P1);
  draw(O2--P2);
  dot("$\xi_1$", O1, dir(90));
  dot("$\xi_2$", O2, dir(180));
  label("$q^{-\rho_1}$", midpoint(O1--P1), dir(P1-O1)*dir(90));
  label("$q^{-\rho_2}$", midpoint(O2--P2), dir(P2-O2)*dir(90));
\end{asy}
\caption{Figure corresponding to \Cref{prop:no_mastercard}.}
\label{fig:no_mastercard}
\end{figure}

We package both of these results together
lemma that will be used repeatedly.
\begin{lemma}
  \label{lem:quadruple_ineq}
  Let $\xi_1, \xi_2 \in \OO_E^\times$ and let $\rho_1 \ge \rho_2$ be integers.
  Also let $n \ge \max(\rho_1, 1)$ be an integer.
  Then the set of points $x \in E$ satisfying all of the equations
  \begin{align*}
    v(x - \xi_1) &\ge \rho_1 \\
    v(x - \xi_2) &\ge \rho_2 \\
    v(1 - x \ol x) &= n
  \end{align*}
  has positive volume if and only if
  \[ v(1 - \xi_1 \bar{\xi_1}) \ge \rho_1, \qquad \rho_2 \le v(\xi_1 - \xi_2). \]
  In that case, the volume is equal to
  \[
    \begin{cases}
      q^{-(n+\rho_1)}(1-q\inv) & \text{if } \rho_1 \ge 1 \\
      q^{-n}(1-q^{-2}) & \text{if } \rho_1 \le 0.
    \end{cases}
  \]
\end{lemma}
In the situation where $\xi_i \notin \OO_E^\times$,
the condition $v(x-\xi_i) = \min(0, v(\xi_i))$ becomes independent of the value of $x$,
and so \Cref{lem:quadruple_ineq} becomes unnecessary
(\Cref{lem:volume} will suffice).
We will deal with this situation when it arises.

\subsection{Setup}
Consider the upper $2 \times 2$ matrix of $\Gamma(\gamma, t, m)$.
Using the identities
\begin{align*}
  \dfrac{a-b\bar t+\bar d \bar t^2}{1-t \bar t}
    - \bar t \cdot \dfrac{at-bt\bar t+\bar d \bar t}{1-t \bar t}
    &= a-b\bar t \in \varpi^{-r} \OO_E \\[2ex]
  \dfrac{a-b\bar t+\bar d \bar t^2}{1-t \bar t}
    + \bar t \cdot \dfrac{-at+b-\bar d \bar t}{1-t \bar t}
    &= a \in \varpi^{-r} \OO_E \\[2ex]
  \dfrac{-at+b-\bar d \bar t}{1-t \bar t}
    - \bar t \cdot \dfrac{-at^2+bt-\bar d}{1-t \bar t}
    &= -a+b \in \varpi^{-r} \OO_E,
\end{align*}
it follows that as soon as one entry is in $\varpi^{-r} \OO_E$, they all are.
Meanwhile, the requirements on the other entries amount to
\begin{align}
  m & \geq n - r \\
  v\left( c+(1-d \bar d) \bar t \right) &\geq m-r \label{eq:cddtop} \\
  v\left( ct+(1-d \bar d) \right) &\geq m-r \label{eq:cddbot}
\end{align}
According to the earlier identity \eqref{eq:ctrick},
if \eqref{eq:cddtop} is assumed true,
then \eqref{eq:cddbot} is equivalent to
\[ \delta + v(1-t \bar t) \ge m-r. \]
Meanwhile, since $v(c+(1-d \bar d) \bar t) = v(\bar c + (1-d \bar d)t)$,
\eqref{eq:cddtop} is itself equivalent to
\[ v(t+u) + \delta \geq m-r \]
by reading the definition of \eqref{eq:u}.

Finally, we use a tricky substitution
\[ (2at-b)^2 - (b^2-4a\bar d) = -4a(-at^2+bt-\bar d) \]
to rewrite $v(-at^2+bt-\bar d) \geq n-r$
as $v\left( (2at-b)^2 - (b^2-4a\bar d) \right) \geq n-r$.

In summary:
\begin{proposition}
  Assume $t$ is such that $n = v(1-t \bar t) > 0$.
  Then $\mathbf{1}_{\le r}(\gamma, t, m) = 1$ if and only if
  \[ n - r \leq m \leq n + \delta + r \]
  and $t$ lies in the set specified by
  \begin{align*}
    v\left( (2at-b)^2 - (b^2-4a\bar d) \right) &\geq n-r \\
    v(t+u) &\ge m-\delta-r.
  \end{align*}
\end{proposition}

\section{Rewriting the quadratic constraint on the valuation of $t$ in the $n > 0$ situation}
We now analyze the inequality
\begin{equation}
  v\left( (2at-b)^2 - (b^2-4a\bar d) \right) \geq n-r
  \label{eq:2atb_dos}
\end{equation}
and divide it into several (disjoint) possibilities.
Recalling that $\ell = b^2 - 4 a \bar d$, there are three possibilities:
\begin{itemize}
  \ii If $\ell \ge n-r$, then \eqref{eq:2atb_dos} is equvialent to
  \[ 2v(2at-b) \ge n-r
    \iff v\left( t - \frac{b}{2a} \right) \ge \left\lceil \frac{n-r}{2} \right\rceil. \]
  We will further subdivide this into two cases.
  \begin{itemize}
    \ii \textbf{Case 1} is the situation where $\left\lceil \frac{n-r}{2} \right\rceil \ge m - \delta - r$.
    \ii \textbf{Case 2} is the situation where $\left\lceil \frac{n-r}{2} \right\rceil < m - \delta - r$.
  \end{itemize}

  \ii If $\ell < n-r$, then \eqref{eq:2atb_dos} could only hold if $v(2at-b) = \frac{\ell}{2}$.
  Note that in particular, this requires $\ell$ to be even.
  If this happens, then $b^2 - 4 a \bar d$ must be a square and we denote it $\tau^2$.
  Thus, \eqref{eq:2atb_dos} then reads
  \[ v(2at-b+\tau) + v(2at-b-\tau) \ge n-r. \]
  Since we are assuming $n > \ell + r$,
  it must be the case that one of the two factors
  $v(2at-b\mp\tau)$ is equal to $v(\tau) = \ell / 2$ exactly.

  Suppose $v(2at-b+\tau) = \frac{\ell}{2}$, so we need
  \[ v\left( t - \frac{b+\tau}{2a} \right) = v(2at-b-\tau) \ge n - \frac{\ell}{2} - r. \]
  We further subdivide this into two cases:
  \begin{itemize}
    \ii \textbf{Case 3\ts+} is the situation where $n - \frac{\ell}{2} - r > m - \delta - r$.
    \ii \textbf{Case 4\ts+} is the situation where $n - \frac{\ell}{2} - r \le m - \delta - r$.
  \end{itemize}
  Replacing $\tau$ with $-\tau$ above gives us two additional cases
  which we denote \textbf{Case 3\ts-} and \textbf{Case 4\ts-}.
\end{itemize}

This gives us six cases, with each $t \in E$ satisfying at most one of them.
(If $\ell$ is odd, only \textbf{Case 1} and \textbf{Case 2} are used.)
In each case, for a given pair $(n,m)$ we are interested in the volume of $t$
such that two disk inequalities hold together with the assumption $n = v(1-t \bar t)$.

We rewrite these six cases in the format specified by \Cref{lem:quadruple_ineq},
noting that each possibility will actually split into two sub-cases
(although the lemma will only apply in the cases where the centers
$\xi_i$ are actually in $\OO_E^\times$;
this which will be true in the main case $v(b) = v(d) = 0$).
This gives \Cref{tab:orbital_cases}.

\begin{table}[ht]
  \centering
  \begin{tabular}{ll cc}
    \toprule
    & Assume & $\xi_1$ and $\xi_2$ & $\rho_1$ and $\rho_2$ \\\midrule
    \textbf{1}
      & $n \le \ell+r$
      & $\begin{aligned}
        \xi_1 &= \tfrac{b}{2a} \\
        \xi_2 &= -u \\
        v(\xi_1 - \xi_2) &= v(au - \bar d \bar u) \\
        v(1-\xi_1 \bar{\xi_1}) &= v(4-b\bar{b})
        \end{aligned}$
      & $\begin{aligned}
        &\phantom{\ge} \left\lceil \tfrac{n-r}{2} \right\rceil \\
        &\ge m-\delta-r
        \end{aligned}$
        \\\hline
    \textbf{2}
      & $n \le \ell+r$
      & $\begin{aligned}
        \xi_1 &= -u \\
        \xi_2 &= \tfrac{b}{2a} \\
        v(\xi_1-\xi_2) &= v(au- \bar d \bar u) \\
        v(1-\xi_1 \bar{\xi_1}) &= \lambda
      \end{aligned}$
      & $\begin{aligned}
        &\phantom> m-\delta-r \\
        &> \left\lceil \tfrac{n-r}{2} \right\rceil
      \end{aligned}$ \\\hline
    \textbf{3\ts+}
      & $n > \ell + r$
      & $\begin{aligned}
        \xi_1 &= \tfrac{b+\tau}{2a} \\
        \xi_2 &= -u \\
        v(\xi_1-\xi_2) &= v(au - \bar d \bar u + \tau) \\
        v(1 - \xi_1 \bar{\xi_1}) &= v(1-\tfrac{\Norm(b+\tau)}{4})
      \end{aligned}$
      & $\begin{aligned}
        &\phantom> n-\frac{\ell}{2}-r \\
        &> m-\delta-r
      \end{aligned}$ \\\hline
    \textbf{3\ts-}
      & $n > \ell + r$
      & $\begin{aligned}
        \xi_1 &= \tfrac{b-\tau}{2a} \\
        \xi_2 &= -u \\
        v(\xi_1-\xi_2) &= v(au-\bar d \bar u-\tau) \\
        v(1 - \xi_1 \bar{\xi_1}) &= v(1-\tfrac{\Norm(b-\tau)}{4})
      \end{aligned}$
      & $\begin{aligned}
        &\phantom> n-\frac{\ell}{2}-r \\
        &> m-\delta-r
      \end{aligned}$ \\\hline
    \textbf{4\ts+}
      & $n > \ell + r$
      & $\begin{aligned}
        \xi_1 &= -u \\
        \xi_2 &= \tfrac{b+\tau}{2a} \\
        v(\xi_1-\xi_2) &= v(au-\bar d \bar u+\tau) \\
        v(1 - \xi_1 \bar{\xi_1}) &= \lambda
        \end{aligned}$
      & $\begin{aligned}
        &\phantom\ge m-\delta-r \\
        &\ge n-\frac{\ell}{2}-r
        \end{aligned}$ \\\hline
    \textbf{4\ts-}
      & $n > \ell + r$
      & $\begin{aligned}
        \xi_1 &= -u \\
        \xi_2 &= \tfrac{b-\tau}{2a} \\
        v(\xi_1-\xi_2) &= v(au-\bar d \bar u-\tau) \\
        v(1 - \xi_1 \bar{\xi_1}) &= \lambda
        \end{aligned}$
      & $\begin{aligned}
        &\phantom\ge m-\delta-r \\
        &\ge n-\frac{\ell}{2}-r
      \end{aligned}$ \\\bottomrule
  \end{tabular}

  \caption{The six cases for calculating the orbital integral.}
  \label{tab:orbital_cases}
\end{table}
Note that in generating this table, we did the calculations
\begin{align*}
  v\left( u + \frac{b}{2a} \right)
  &= v\left( \frac{au-\bar d \bar u}{2a} \right)
  = v(au - \bar d \bar u) \\
  v\left( u + \frac{b \pm \tau}{2} \right)
  &= v(au - \bar d \bar u \pm \tau).
\end{align*}
to populate the entries for $v(\xi_1 - \xi_2)$,
as well as the identity
\[ 1 - \frac{b \pm \tau}{2a} \cdot \frac{\bar b \pm \bar \tau}{2\bar a}
= \frac{4 - \Norm(b \pm \tau)}{4} \]
to calculate $v(1-\xi_1\bar{\xi_1})$ entries in the latter four cases.

\subsection{Analysis of Case 1 and 2 assuming $n > 0$ and $v(b) = v(d) = 0$.}
We analyze Case 1 and 2 assuming $v(b) = v(d) = 0$.

Considering $n > 0$ and $n-r \le m \le n+\delta+r$ as fixed,
we compute the volume of the set of $t$
for which $n = v(1-t\bar t)$ and $\mathbf{1}_{\le r}(\gamma,t,m) = 1$.

In addition to the constraint $n \le \ell + r$,
we see that the two cases have the following additional requirements:
\begin{description}
  \ii[Case 1] If $m < \left\lceil \frac{n-r}{2} \right\rceil + \delta + r$ then we need
  \begin{align}
    v(4-b\bar b) &\ge \left\lceil \frac{n-r}{2} \right\rceil \label{eq:odd_ineq1} \\
    v(au - \bar d \bar u) &\ge m - \delta - r \label{eq:odd_ineq2}.
  \end{align}

  \ii[Case 2] If $m \geq \left\lceil \frac{n-r}{2} \right\rceil + \delta + r$ then we need
  \begin{align}
    \lambda = v(1-u \bar u) &\ge m-\delta-r \label{eq:odd_ineq3} \\
    v(au - \bar d \bar u) &\ge \left\lceil \frac{n-r}{2} \right\rceil \label{eq:odd_ineq4}.
  \end{align}
\end{description}

We will now show that some of these inequalities are redundant and can be ignored.

\begin{proposition}
  \eqref{eq:odd_ineq2} and \eqref{eq:odd_ineq4} are redundant
  i.e.\ they are automatically true for $0 < n \le \ell + r$.
\end{proposition}
\begin{proof}
  First, assume that $\ell$ is odd.
  Then \eqref{eq:dos} together with $v(b) = v(d) = 0$ gives
  \begin{equation}
    \lambda = \ell = v(1-u \bar u) < 2v(au - \bar d \bar u).
    \label{eq:odd_center_distance}
  \end{equation}
  On the other hand, if $\ell$ is even, then we have instead
  \begin{equation}
    \ell = 2v(au - \bar d \bar u) < v(1-u\bar u) = \lambda
    \label{eq:even_center_distance_case12}
  \end{equation}
  Thus, regardless of the parity of $\ell$, we always have
  \[ v(au - \bar d \bar u) \ge \frac{\ell}{2} \ge \frac{n-r}{2}. \qedhere \]
\end{proof}

\begin{proposition}
  \eqref{eq:odd_ineq1} is redundant.
\end{proposition}
\begin{proof}
  The equation
  \[ (4-b \bar b) = -4au(1-d\bar d) - \bar b(b^2-4a\bar d) \]
  implies
  \begin{equation}
    v(4-b\bar b) \ge \min(\ell,\delta) \text{ with equality if } \ell \neq \delta.
    \label{eq:bb_odd}
  \end{equation}
  Hence, a priori \eqref{eq:bb_odd} suggests that we have a condition
  $n \le r + 2 \delta$ in addition to $n \le r + \ell$.
  However, by \Cref{prop:parameter_constraints}, we always have $\ell \le 2 \delta$,
  and consequently \eqref{eq:odd_ineq1} is redundant as well.
\end{proof}

Putting all of this together, we find that the valid pairs $(n,m)$ come in two cases.

\begin{description}
\item[Double sum for Case 1]
We sum over $(m,n)$ such that
\begin{equation}
  \begin{aligned}
    1 &\leq n \leq \ell + r, \\
    n-r &\leq m \leq \left\lceil \frac{n-r}{2} \right\rceil+\delta+r - 1
  \end{aligned}
  \label{eq:odd_range1}
\end{equation}
where each $(m,n)$ gives a volume contribution of
\[
  \begin{cases}
    q^{-n - \left\lceil \frac{n-r}{2} \right\rceil} \left( 1 - q\inv \right)
      & \text{if $n > r$} \\
    q^{-n} \left( 1 - q^{-2} \right)
      & \text{if $n \leq r$}.
  \end{cases}
\]

\item[Double sum for Case 2]
We sum over $(m,n)$ such that
\begin{equation}
  \begin{aligned}
    1 &\leq n \leq \ell + r, \\
    \max\left(n-r, \left\lceil \frac{n-r}{2} \right\rceil+\delta+r \right)
    &\leq m \leq \min(n,\lambda)+\delta+r.
  \end{aligned}
  \label{eq:odd_range2}
\end{equation}
where each $(m,n)$ gives a volume contribution of
\[
  \begin{cases}
    q^{-n - (m-\delta-r)} \left( 1 - q\inv \right)
      & \text{if $m > \delta + r$} \\
    q^{-n} \left( 1 - q^{-2} \right)
      & \text{if $m \le \delta + r$}.
  \end{cases}
\]
Notice that $m \leq \delta + r$ could only occur when $n \leq r$.
\end{description}

\subsection{Analysis of Case 3 and 4 assuming $n > 0$ and $v(b) = v(d) = 0$.}
Suppose $\ell \geq 0$ is even.
Using the identity
\[ (au-\bar d \bar u)^2 - \tau^2 = 4a\bar d(1- u\bar u) \]
we agree now to fix the choice of the square root of $\tau$ such that
\begin{equation}
  v(au-\bar d \bar u + \tau) = \lambda - \half \ell \quad\text{and}\quad
  v(au-\bar d \bar u - \tau) = \half \ell.
  \label{eq:tau_choice}
\end{equation}

As before we consider $n > 0$ and $n-r \le m \le n+\delta+r$ as fixed,
and seek to compute the volume of the set of $t$
for which $n = v(1-t\bar t)$ and $\mathbf{1}_{\le r}(\gamma,t,m) = 0$.

From $v(b) = v(d) = 0$ and \eqref{eq:dos}, we have
\[ \ell = 2v(\tau) = 2v(au - \bar d \bar u) < \lambda. \]
This lets us invoke \cite[Lemma 4.7]{ref:AFL} to evaluate $v(4-\Norm(b \pm \tau))$:
we have the calculation
\begin{align*}
  v\left( 4 - \Norm(b+\tau) \right) &= \lambda + \delta - \ell \\
  v\left( 4 - \Norm(b-\tau) \right) &= \delta.
\end{align*}

\begin{description}
\ii[Double sum for Case 3\ts+]
Suppose $n > \ell + r$,
$m < n - \frac{\ell}{2} + \delta$, and we choose $\frac{b+\tau}{2a}$.
Then \Cref{lem:quadruple_ineq} gives a nonzero contribution if and only if
\begin{align*}
  \lambda + \delta - \ell = v(4-\Norm(b+\tau)) &\geq n - \frac{\ell}{2} - r \\
  \lambda - \frac{\ell}{2} = v(au-\bar d \bar u + \tau) & \geq m - \delta - r.
\end{align*}
Compiling all seven constraints gives that the valid pairs $(m,n)$ are those for which
\begin{align*}
  \max(1, \ell+r+1) &\leq n \leq -\frac{\ell}{2} + \delta + \lambda + r, \\
  n-r &\leq m \leq \min\left( n+\delta+r, n - \frac{\ell}{2}+\delta - 1,
    \lambda-\frac{\ell}{2}+\delta+r \right)
\end{align*}
which from $\ell, \delta, r \ge 0$ can be simplified to just
\begin{equation}
  \begin{aligned}
    \ell+r+1 &\leq n \leq  -\frac{\ell}{2} + \delta + \lambda + r, \\
    n-r &\leq m \leq \min(n-1, \lambda-r) - \frac{\ell}{2} + \delta
  \end{aligned}
  \label{eq:even_case3_plus}
\end{equation}
Each $(m,n)$ gives a volume contribution of
\[ q^{-n - (n - \frac{\ell}{2} - r)} \left( 1 - q\inv \right). \]

\ii[Double sum for Case 3\ts-]
Suppose $n > \ell + r$,
$m < n - \frac{\ell}{2} + \delta$, and we choose $\frac{b-\tau}{2a}$.
Then \Cref{lem:quadruple_ineq} gives a nonzero contribution if and only if
\begin{align*}
  \delta = v(4-\Norm(b-\tau)) &\geq n - \frac{\ell}{2} - r \\
  \frac{\ell}{2} = v(au-\bar d \bar u - \tau) & \geq m - \delta - r.
\end{align*}
Compiling all seven constraints gives that the valid pairs $(m,n)$ are those for which
\begin{align*}
  \ell + r + 1 &\leq n \leq \frac{\ell}{2}+\delta+r, \\
  n-r &\leq m \leq \min\left( n - \frac{\ell}{2}+\delta - 1,
    \frac{\ell}{2} + \delta + r, n + \delta + r \right)
\end{align*}
This simplifies to
\begin{equation}
  \begin{aligned}
    \ell+r+1 &\leq n \leq \frac{\ell}{2}+\delta+r, \\
    n-r &\leq m \leq \frac{\ell}{2} + \delta + r.
  \end{aligned}
  \label{eq:even_case3_minus}
\end{equation}
As in the previous case, $(m,n)$ gives a volume contribution of
\[ q^{-n - (n - \frac{\ell}{2} - r)} \left( 1 - q\inv \right). \]

\ii[Double sum for Case 4\ts+]
Suppose $n > \ell + r$,
$m \ge n - \frac{\ell}{2} + \delta$
(which implies $m \ge n-r$ since $r \ge 0$ and $0 \le \ell \le 2 \delta$),
and we choose $\frac{b+\tau}{2a}$.
Then \Cref{lem:quadruple_ineq} gives a nonzero contribution if and only if
\begin{align*}
  \lambda &\geq m - \delta - r \\
  \lambda - \frac{\ell}{2} = v(au-\bar d \bar u + \tau) & \geq n - \frac{\ell}{2} - r.
\end{align*}
Rearranging gives that the valid pairs $(m,n)$ are those for which
\begin{equation}
  \begin{aligned}
    \ell + r + 1 &\leq n \leq \lambda + r \\
    n - \frac{\ell}{2} + \delta &\leq m \leq \min(n, \lambda) + \delta + r.
  \end{aligned}
  \label{eq:even_case4_plus}
\end{equation}
Here, each $(m,n)$ gives a volume contribution of
\[ q^{-n - (m - \delta - r)} \left( 1 - q\inv \right). \]

\ii[Double sum for Case 4\ts-]
Suppose $n > \ell + r$,
$m \ge n - \frac{\ell}{2} + \delta$, and we choose $\frac{b-\tau}{2a}$.
Then \Cref{lem:quadruple_ineq} gives a nonzero contribution if and only if
\begin{align*}
  \lambda &\geq m - \delta - r \\
  \frac{\ell}{2} = v(au-\bar d \bar u - \tau) & \geq n - \frac{\ell}{2} - r.
\end{align*}
The latter inequality contradicts the assumption that $n > \ell + r$,
so in fact this case can never occur.
\end{description}
