\chapter{Introduction}
Throughout this whole paper, $p > 2$ is a prime,
$F$ is a finite extension of $\QQ_p$,
and $E/F$ is an unramified quadratic field extension.

\section{Brief history and motivation for the arithmetic fundamental lemma}
The primary motivation for this paper arises from
the study of conjectured variants of the arithmetic fundamental lemma
for spherical Hecke algebras proposed in \cite{ref:AFLspherical}.
This section briefly provides an overview of the historical context
that led to the formulation of these conjectures.
This history is also summarized in \Cref{fig:history}.

Because this subsection is meant for motivation only, in this survey we do not give
complete definitions or statements, being content to outline a brief gist.
A more detailed account can be found in \cite{ref:survey}.

\begin{figure}[ht]
  \centering
  \begin{tikzcd}
      \text{\cite{ref:waldspurger}} \ar[d] \\
      \text{\cite{ref:GP1,ref:GP2}} \ar[d] \\
    \text{GGP \cite{ref:GGP}}
      \ar[d, dotted, leftrightarrow, "\text{analog}"]
      & \ar[l, Rightarrow, "\text{used to prove}"] \text{FL \cite{ref:JR}}
        \ar[d, dotted, leftrightarrow, "\text{analog}"] \ar[r]
      & \text{\cite{ref:leslie}}
        \ar[d, dotted, leftrightarrow, "\text{analog}"] \\
    \text{Arith.\ GGP \cite{ref:GGP}}
      & \ar[l, Rightarrow, "\text{used to prove}"] \text{AFL \cite{ref:AFL}} \ar[r]
      & \text{\cite{ref:AFLspherical}} \\
    \text{\cite{ref:GZshimura}} \ar[u] \\
    \text{\cite{ref:gross_zagier}} \ar[u]
  \end{tikzcd}
  \caption{The history behind the fundamental lemma and its arithmetic counterpart.
    Unlabeled arrows denote generalizations.}
  \label{fig:history}
\end{figure}

\subsection{The GGP conjectures, and the fundamental lemma of Jacquet-Rallis}
In modern arithmetic geometry, a common theme is that there are deep connections
between geometric data with the values of related $L$-functions.

This story begins with a result of
Waldspurger \cite{ref:waldspurger} which showed a formula
relating the nonvanishing of an automorphic period integral
to the central value of the same $L$-functions.
Later, a conjecture that generalizes Waldspurger's formula
was proposed by Gross-Prasad in \cite{ref:GP1,ref:GP2}.
This was further generalized to a series of conjectures
now known as the Gan-Gross-Prasad (GGP) conjectures,
which were proposed in 2012 in \cite{ref:GGP};
they generalize the Gross-Prasad conjecture to different classical groups.
Specifically, the GGP conjecture predict the nonvanishing of a period integral
based on the values of the $L$-function of a certain cuspidal automorphic representation.

In 2011, Jacquet-Rallis \cite{ref:JR} proposed an approach to the Gross-Prasad conjectures
for unitary groups via a relative trace formula (RTF).
The idea is to compare a RTF for the general linear group to one for a unitary group.
This approach relies on a so-called \emph{fundamental lemma},
which links values of certain orbital integrals
over two reductive groups over a non-Archimedean local field.

Let's be a bit more precise about what this fundamental lemma says.
Let $\VV_n^+$ denote the split $E/F$-Hermitian space of dimension $n$ (unique up to isomorphism),
fix a unit vector $w_0$ in it,
and let $(\VV_n^+)^\flat$ be the orthogonal complement of the span of $w_0$.
Let $G'^\flat \coloneqq \GL_{n-1}(E)$, $G' \coloneqq \GL_n(E)$,
$G^\flat \coloneqq \U((\VV_n^+)^\flat)(F)$ and $G \coloneqq \U(\VV_n^+)(F)$.
For certain
\[ \gamma \in G'^\flat \times G', \qquad g \in G^\flat \times G \]
the Jacquet-Rallis fundamental lemma proposes a relation between two orbital integrals.
Specifically, it supplies a relation between
\begin{itemize}
\item the orbital integral of $\gamma$ with respect to
  the indicator function $\mathbf{1}_{K'^\flat \times K'}$
  of the natural hyperspecial compact subgroup
  \[ K'^\flat \times K' \subset G'^\flat \times G' = \GL_{n-1}(E) \times \GL_n(E); \]
  and
\item the orbital integral of $g$ with respect to
  the indicator function $\mathbf{1}_{K^\flat \times K}$
  of the natural hyperspecial compact subgroup
  \[ K^\flat \times K \subset G^\flat \times G = \U((\VV_n^+)^\flat)(F) \times \U(\VV_n^+)(F). \]
\end{itemize}
In other words, it states that
\begin{equation}
  \Orb(\gamma, \mathbf{1}_{K'^\flat \times K'}) = \omega(\gamma) \Orb(g, \mathbf{1}_{K^\flat \times K})
  \label{eq:old_FL}
\end{equation}
where $\omega(\gamma)$ is a suitable \emph{transfer factor}.
The fundamental lemma has since been proved completely;
a local proof was given by Beuzart-Plessis \cite{ref:BeuzartPlessis}
while a global proof was given for large characteristic by W.\ Zhang \cite{ref:Wei2021}.

\subsection{The arithmetic GGP conjectures, and the arithmetic fundamental lemma.}
At around the same time Waldspurger's formula was published,
Gross-Zagier \cite{ref:gross_zagier} proved a formula
relating the height of Heegner points
on certain modular curves to the derivative at $s=1$ of certain $L$-functions.
The Gross-Zagier formula was then generalized over several decades,
culminating in \cite{ref:GZshimura} where the formula is established
for Shimura curves over arbitrary totally real fields.

An arithmetic analogue of the original Gan-Gross-Prasad conjectures,
which we henceforth refer to as \emph{arithmetic GGP} \cite{ref:GGP},
can then be formulated, further generalizing Gross-Zagier's formula.
Here the modular curves in Gross-Zagier
are replaced with higher dimensional Shimura varieties.
Rather than the period integrals considered previously,
one instead takes intersection numbers of cycles on some Shimura varieties.
Specifically, if one considers the Shimura variety associated to a classical group,
the arithmetic GGP conjecture predicts a relation between intersection numbers
on this Simura variety with the central derivative of automorphic $L$-functions.

By analogy to the work Jacquet-Rallis \cite{ref:JR},
the arithmetic GGP conjectures should have a corresponding
\emph{arithmetic fundamental lemma} (henceforth AFL),
which was proposed by W.\ Zhang \cite[Conjecture 2.9]{ref:AFL}.
The arithmetic fundamental lemma then relates the derivative
of the weighted orbital integral with respect to the indicator function
$\mathbf{1}_{K'^\flat \times K'} \in \HH(G'^\flat \times G, K'^\flat \times K')$, that is
\[ \left. \pdv{}{s} \right\rvert_{s=0} \Orb(\gamma, \mathbf{1}_{K'^\flat \times K'}, s) \]
for $\gamma \in G'^\flat \times G'$,
to arithmetic intersection numbers on a certain Rapoport-Zink formal moduli space.
The AFL in \cite{ref:AFL} has since been proven over $p$-adic fields for any prime $p$ in
Mihatsch-Zhang \cite{ref:MZ2021}, W.\ Zhang \cite{ref:Wei2021}, Z.\ Zhang \cite{ref:Zhiyu}.

\subsection{The semi-Lie version of the AFL proposed by Liu}
There is another different version of the AFL, proposed by Yifeng Liu in
\cite[Conjecture 1.12]{ref:liuFJ},
which is often referred to as the \emph{semi-Lie version} of the AFL.
Its statement has been shown to be equivalent to AFL,
\cite[Remark 1.13]{ref:liuFJ} (and is thus now proven).
In contrast, the original AFL proposed by Zhang in \cite[Conjecture 2.9]{ref:AFL}
is sometimes referred to as the \emph{group version}.

A more detailed account of this equivalence is described in \cite[\S1.4]{ref:liuFJ}.

\subsection{Generalizations of FL and AFL to the full spherical Hecke algebra}
Recently it was shown by Leslie \cite{ref:leslie} that in fact
\eqref{eq:old_FL} holds in greater generality where the indicator function
$\mathbf{1}_{K^\flat \times K}$ can be replaced by any element in the spherical
Hecke algebra $\varphi \in \HH(G'^\flat \times G', K'^\flat \times K')$.
In that case, $\mathbf{1}_{K'^\flat \times K}$ needs to be replaced
by the corresponding element $\varphi'$ under a certain base change homomorphism
\begin{align*}
  \HH(G'^\flat \times G', K'^\flat \times K') &\to \HH(G^\flat \times G, K^\flat \times K) \\
  \varphi' &\mapsto \varphi
\end{align*}

In that case, the identity \eqref{eq:old_FL} still hold as
\begin{equation}
  \Orb(\gamma, \varphi') = \omega(\gamma) \Orb(g, \varphi).
  \label{eq:eq:leslie_FL}
\end{equation}
To complete the analogy illustrated in \Cref{fig:history},
there should thus be a generalization of the AFL in which
$\mathbf{1}_{K'^\flat \times K}$ is replaced by any element of the Hecke algebra
$\HH(G'^\flat \times G, K'^\flat \times K)$.
This formula is proposed by \cite{ref:AFLspherical},
and is the primary focus of this paper; we discuss it in the next section.

\section{The inhomogeneous version of the arithmetic fundamental lemma for spherical Hecke algebras}
In contrast to the vague motivational cheerleading in the previous section,
starting in this section we will give more precise statements,
even though we will necessarily need to reference definitions appearing in later sections.

Retain the notation $G' \coloneqq \GL_n(E)$, and $G \coloneqq \U(\VV_n^+)(F)$,
with $K' \subset G'$ and $K \subset G$ the natural hyperspecial compact subgroups.
Also, let $q$ denote the residue characteristic of $F$.
Moreover, define the symmetric space
\[ S_n(F) \coloneqq \left\{ g \in \GL_n(E) \mid g \bar{g} = \id_n \right\}. \]
Finally, let $\VV_n^-$ be the non-split Hermitian space of dimension $n$
(unique up to isomorphism),
and let $\VV_n^+$ be the split one (again unique up to isomorphism).
Denote by $\U(\VV_n^-)$ the corresponding unitary groups.

For concreteness, we focus on the inhomogeneous version
of the arithmetic fundamental lemma, which is \cite[Conjecture 6.2.1]{ref:AFLspherical}.
This allows us to deal with just $G'$ instead of $G'^\flat \times G'$, etc.,
so that the Hecke algebra $\HH(G'^\flat \times G', K'^\flat \times K')$
can be replaced by the simpler one $\HH(\GL_n(E)) \coloneqq \HH(G', K')$.
Similarly, $\HH(G^\flat \times G, K^\flat \times K)$
can be replaced by the simpler $\HH(\U(\VV_n^+)) \coloneqq \HH(G, K)$.

The AFL conjecture provides a bridge between a geometric left-hand side
(given by an intersection number)
and an analytic right-hand side (given by an weighted orbital integral).
Stating it requires several pieces of data.
We only mention these pieces by name here, with definitions given later:
\begin{itemize}
  \ii On the geometric side, we have an intersection number.
  It uses the following ingredients.
  \begin{itemize}
    \ii We choose a regular semisimple element $g \in \U(\VV_n^-)\rs$.
    (The notation $\U(\VV_n^-)\rs$ denotes the regular semisimple elements of $\U(\VV_n^-)$, etc.
    The notion of regular semisimple is defined in \Cref{def:regular}.)
    \ii We choose a function $f \in \HH(\GL_n(E))$ from the spherical Hecke algebra,
    defined in \Cref{ch:background}.
    \ii We define a certain \emph{intersection number} $\Int((g,u), f)$
    in \Cref{def:intersection_number_inhomog}.
    These intersection numbers take place in a Rapoport-Zink space
    described in \Cref{ch:geo}.
  \end{itemize}

  \ii On the analytic side, we have an weighted orbital integral.
  It uses the following ingredients.
  \begin{itemize}
    \ii We choose a regular semisimple element $\gamma \in S_n(F)\rs$.
    \ii We choose a test function $\phi$ which comes
    from a certain $\HH(\GL_n(E))$-module that we will denote $\HH(S_n(F))$.
    This module $\HH(S_n(F))$ is defined in \Cref{ch:background}.
    \ii The weighted orbital integral $\Orb(\gamma, \phi, s)$
    is itself defined in \Cref{def:orbital0}.
    (It is connected to an unweighted orbital integral on the unitary group
    according to \Cref{thm:rel_fundamental_lemma}.)
    \ii There is also an extra transfer factor $\omega \in \{\pm1\}$
    which we define in \Cref{ch:transf}.
  \end{itemize}

  \ii We need a way to connect the inputs between the two parts of our conjecture.
  Specifically, $f$ and $\phi$ need to be linked, and $g$ and $\gamma$ need to be linked.
  This is done as follows.
  \begin{itemize}
    \ii Once the regular semisimple element $g \in \U(\VV_n^-)\rs$ is chosen,
    we require $\gamma \in S_n(F)\rs$ to be a \emph{matching} element.
    This matching is defined in \Cref{def:matching_inhomog}.
    (Alternatively, one could imagine picking $\gamma \in S_n(F)\rs$ first
    and finding corresponding $g$;
    it turns out $\gamma$ will match an element of $\U(\VV_n^\pm)\rs$ is general,
    and the conjecture is only formulated in the case where $g \in \U(\VV_n^-)$).

    \ii Once $f \in \HH(\U(\VV_n^+))$ is chosen, we select
    \[ \phi = (\BC_{S_n}^{\eta^{n-1}})^{-1}(f) \]
    to be the image of $f$ under a \emph{base change}.
    This base change is defined and then calculated explicitly for $n = 3$ in \Cref{ch:satake}.
  \end{itemize}
\end{itemize}
With all our protagonists now having names and references,
we can now state the conjecture proposed in \cite{ref:AFLspherical}.
\begin{conjecture}
  [Inhomogeneous version of the AFL for the full spherical Hecke algebra,
  {\cite[Conjecture 6.2.1]{ref:AFLspherical}}]
  \label{conj:inhomog}
  Let $f \in \HH(\U(\VV_n^+))$ be any element of the Hecke algebra,
  and let $\phi = (\BC_{S_n}^{\eta^{n-1}})^{-1}(f) \in \HH(S_n(F))$ be its image
  under base change as defined in \Cref{ch:satake}.
  Then for matching (as defined in \Cref{def:matching_inhomog}) regular semisimple elements
  \[ g \in \U(\VV_n^-)\rs \longleftrightarrow \gamma \in S_n(F)\rs \]
  we have
  \begin{equation}
    \Int\left( (1,g), \mathbf{1}_{K'^\flat} \otimes f \right) \log q
    = -\omega(\gamma) \left. \pdv{}{s} \right\rvert_{s=0} \Orb(\gamma, \phi, s)
    \label{eq:inhomog}
  \end{equation}
  where the weighted orbital integral $\Orb(\dots)$ is defined in \Cref{def:orbital0},
  the transfer factor $\omega$ is defined in \Cref{ch:transf},
  and the intersection number $\Int(\dots)$ is defined in \Cref{ch:geo}.
\end{conjecture}

At present, the (inhomogeneous) AFL is the case where $f = \mathbf{1}_K$,
and is thus proven.
Note that in the case of interest where $\gamma \in S_n(F)\rs$
matches an element of $\U(\VV_n^-)\rs$ (rather than $\U(\VV_n^+)\rs$),
the actual value of $\Orb(\gamma, \phi, s)$ at $s = 0$ is always zero
by \Cref{thm:rel_fundamental_lemma};
so the conjecture instead looks at the first derivative at $s = 0$.

The generalized conjecture is also proved in full for
$n = 2$ in \cite[Theorem 1.0.1]{ref:AFLspherical}
(in that reference, our $n$ denotes the $n+1$ in \emph{loc.\ cit.}).
The part of the calculation involving weighted orbital integral has two parts:
\begin{itemize}
  \ii The calculation makes $\BC_{S_{n}}^{\eta^{n-1}}$
  completely explicit in a natural basis for $n = 2$.
  The result is \cite[Lemma 7.1.1]{ref:AFLspherical}.

  \ii The calculation makes explicit the value of the weighted orbital integral
  \[ \Orb(\gamma, \phi, s) \]
  for any $\gamma \in S_n(F)\rs$ and $\phi \in \HH(S_n(F))$,
  in terms of invariants of $\gamma$ and a decomposition of $\phi$ in a natural basis.
  The result is \cite[Proposition 7.3.2]{ref:AFLspherical}.
\end{itemize}
Combining these two (hence obtaining the right-hand side of \eqref{eq:inhomog})
with a calculation of intersection numbers in \cite[Corollary 7.4.3]{ref:AFLspherical}
(which is the left-hand side of \eqref{eq:inhomog})
shows that \Cref{conj:inhomog} holds for $n = 2$,
cf.\ \cite[Theorem 7.5.1]{ref:AFLspherical}.

\section{The arithmetic fundamental lemma for spherical Hecke algebras
  in the semi-Lie case}

We propose an analogous conjecture to \Cref{conj:inhomog}
for the semi-Lie version (also called the Fourier-Jacobi case).
It serves to complete the analogy given in \Cref{tab:semi_lie_analogy}.

\begin{table}[ht]
  \centering
  \begin{tabular}{lll}
    \toprule
    Version & AFL for $\mathbf{1}$ (now proven) & Full spherical Hecke \\
    \midrule
    Group & \cite[Conjecture 2.9]{ref:AFL} & \cite[Conjecture 6.2.1]{ref:AFLspherical} \\
    Semi-Lie & \cite[Conjecture 1.12]{ref:liuFJ} & \Cref{conj:semi_lie_spherical} \\
    \bottomrule
  \end{tabular}
  \caption{Table showing the analogy between the proposed
    \Cref{conj:semi_lie_spherical} and the existing conjectures.}
  \label{tab:semi_lie_analogy}
\end{table}

In this variation, as in \cite{ref:liuFJ},
rather than matching $g \in \U(\VV_n^-)\rs$ to $\gamma \in S_n(F)\rs$,
we consider an augmented space larger than $\U(\VV_n^-)$ and $S_n(F)$.
Specifically, one considers a matching between tuples of regular semisimple elements
\[ (g, u) \in (\U(\VV_n^-) \times \VV_n^-)\rs
  \longleftrightarrow (\gamma, \uu, \vv^\top) \in (S_n(F) \times V'_n(F))\rs \]
where $V'_n(F)$ (defined in \Cref{def:matching_semi_lie})
consists of pairs of column vectors and row vectors of length $n$,
and the space $\VV_n^-$ is defined in \Cref{def:VV_n_nonsplit}.
The notion of \emph{matching} is defined in \Cref{def:matching_semi_lie} as well.
Meanwhile, we still use the same test functions $f$ and $\phi$,
as we did for \cite[Conjecture 6.2.1]{ref:AFLspherical}.
Finally, we also update the definition of intersection number
to accommodate the new term $u$ in \Cref{def:intersection_number_semi_lie_spherical}.

\begin{conjecture}
  [Semi-Lie version of the AFL for the full spherical Hecke algebra]
  Let $f \in \HH(\U(\VV_n^+))$ be any element of the Hecke algebra,
  and let $\phi = (\BC_{S_n}^{\eta^{n-1}})^{-1}(f) \in \HH(S_n(F))$ be its image
  under base change defined in \Cref{ch:satake}.
  Then for matching (as defined in \Cref{def:matching_semi_lie}) regular semisimple elements
  \[ (g, u) \in (\U(\VV_n^-) \times \VV_n^-)\rs \longleftrightarrow
    \guv \in (S_n(F) \times V'_n(F))\rs \]
  we have
  \begin{equation}
    \Int\left( (g,u), f \right) \log q \\
    = -\omega\guv \left. \pdv{}{s} \right\rvert_{s=0}
    \Orb(\guv, \phi \otimes \oneV, s)
  \end{equation}
  where the orbital integral $\Orb(\dots)$ is defined in \Cref{def:orbitalFJ},
  the transfer factor is defined in \Cref{ch:transf},
  and the intersection number $\Int(\dots)$ is defined in \Cref{ch:geo}.
  \label{conj:semi_lie_spherical}
\end{conjecture}
Note that in this version the new orbital integral $\Orb(\guv, \phi \otimes \oneV, s)$
is defined similarly, but no analog of \Cref{thm:rel_fundamental_lemma}
(linking it to an orbital integral on the unitary side) appears in the literature.
We record the corresponding statement as \Cref{conj:rel_fundamental_lemma_semilie}.
Like before, \Cref{conj:rel_fundamental_lemma_semilie}
predicts that $\Orb(\guv, \phi \otimes \oneV, 0) = 0$ in the case of interest,
which in this case can be checked independently.

\begin{remark}
  For $n = 1$, the Hecke algebra $\HH(S_n(F))$ is trivial
  and therefore \Cref{conj:semi_lie_spherical}
  becomes a special case of the known \cite{ref:liuFJ}.
  Therefore $n=2$ is the first case of \Cref{conj:semi_lie_spherical} worth examining.
\end{remark}

\section{The kernel of test functions for which the orbital has identically vanishing derivative}
\label{sec:intro_large_kernel}

In \cite{ref:AFLspherical}, it was observed that for $n = 2$
there was a rather large space of $\phi \in \HH(S_2(F))$ such that
\[ \left. \pdv{}{s} \right\rvert_{s=0}
  \Orb \left(\gamma, \phi, s \right) = 0 \]
held identically across all $\gamma \in S_2(F)$.
In fact, the space of such $\phi$ has codimension $2$
as a vector subspace of $\HH(S_2(F))$ for $n = 2$.
They thus stated a conjecture the kernel was ``large'' for general $n$
as \cite[Conjecture 1.0.2]{ref:AFLspherical};
we give a special case of it here compatible with our specialization.
\begin{conjecture}
  \label{conj:large_kernel_group}
  Consider the map of vector spaces
  \begin{align*}
    \partial\Orb : \HH(\U(\VV_n^-))
    &\to C^\infty( \left\{ \text{elements of } S_n(F) \text{ matching } \U(\VV_n^-) \right\} ) \\
    \phi &\mapsto \left( \gamma \mapsto \left. \pdv{}{s} \right\rvert_{s=0} \Orb \left(\gamma, \phi, s \right) \right).
  \end{align*}
  Then this map has a large kernel,
  in the sense that it is not contained in any maximal ideal of $\HH(\U(\VV_n^-))$.
\end{conjecture}
We will later try to establish this conjecture for $n = 3$ as well.

It is therefore natural to ask whether a similar large kernel result
could hold for the analogous orbital integral in the semi-Lie case.
It turns out that in order to state the conjecture,
we will need to consider not just the entire $\guv$
but the two separate parts, which seem to behave quite differently from each other.
\begin{conjecture}
  \label{conj:kernel_semi_lie}
  Let $n \ge 2$.
  \begin{enumerate}
  \item[(a)]
  There exists $\gamma \in S_n(F)$ such that there are
  no nonzero functions $\phi \in \HH(S_n(F))$ for which
  \[ \left. \pdv{}{s} \right\rvert_{s=0}
    \Orb \left(\guv, \phi \otimes \oneV, s \right) = 0 \]
  holds for every $(\uu, \vv^\top) \in V'_n(F)$
  such that $\guv$ matches with an element of $(\U(\VV_n^-) \times \VV_n^-)\rs$.

  \item[(b)]
  Fix a choice of $(\uu, \vv^\top) \in V'_n(F)$.
  Consider all $\gamma \in S_n(F)$ for which $\guv$
  matches with an element of $(\U(\VV_n^-) \times \VV_n^-)\rs$.
  Then the vector subspace of functions $\phi \in \HH(S_n(F))$ such that
  \[
    \left. \pdv{}{s} \right\rvert_{s=0}
    \Orb \left( \guv, \phi \otimes \oneV, s \right) = 0
  \]
  holds for all such $\gamma$ is large,
  in the sense it is not contained in any maximal ideal of $\HH(S_n(F))$.
  \end{enumerate}
\end{conjecture}
This conjecture is motivated by our results for $n = 2$ in this direction,
namely \Cref{thm:semi_lie_ker_trivial} and \Cref{thm:semi_lie_ker_huge}.

\section{Results}
\subsection{Explicit formulas for orbital integrals}
One primary objective of this paper is to fully determine the weighted orbital integral
in the next situations for which the AFL for the full spherical Hecke algebra
was not previously known:
\begin{itemize}
  \ii The case $n = 3$ for the inhomogeneous group version of the AFL (\Cref{conj:inhomog});
  \ii The case $n = 2$ of semi-Lie version of the AFL (\Cref{conj:semi_lie_spherical}).
\end{itemize}
The first calculation corresponds directly to the earlier results
\cite[Lemma 7.1.1 and Proposition 7.3.2]{ref:AFLspherical}
which were the case $n = 2$ of the inhomogeneous group version of the AFL
(note what \cite{ref:AFLspherical} calls $n$ is $n+1$ in our notation).

The methods, which are local in nature,
are rather similar to those employed in \cite{ref:AFL},
which shows how to compute the weighted orbital integral for $n = 3$ when $f = \mathbf{1}_{K'}$.
We were able to successfully calculate this weighted orbital integral for all these cases.
The result is too involved to state in the introduction,
but we give the following summary.
\begin{theorem}
  \label{thm:summary}
  Let $\gamma \in S_3(F)\rs$ and $\phi \in \HH(S_3(F))$
  (resp.\ $\guv \in (S_2(F) \times V'_2(F))\rs$ and $\phi \in \HH(S_3(F))$).
  Assume that $\gamma$ (resp.\ $\guv$)
  matches an element in $\U(\VV_3^-)\rs$ (resp.\ $(\U(\VV_2^-) \times \VV_2^-)\rs$).
  Then the weighted orbital integral $\Orb(\gamma, \phi, s)$
  (resp.\ $\Orb(\guv, \phi \otimes \oneV, s)$) always takes the form
  \[ \sum_k P_k(q) (-q^s)^k \]
  for some polynomials $P_k(q) \in \ZZ[q]$, where
  \begin{itemize}
    \ii the summation variable $k$ is a some contiguous range of integers,

    \ii the polynomials $P_k \in \ZZ[q]$ are nonzero and satisfy the property
    that every coefficient of $P_k$ besides possibly the leading coefficient is $1$;

    \ii both $\deg P_k$ and leading coefficient of $P_k$ are the integer parts
    of piecewise linear functions in $k$ with slopes in $\{0, \pm\half, \pm 1\}$.
  \end{itemize}
  The range of the summation, and the aforementioned piecewise linear function(s),
  can be written explicitly in terms of a particular representative
  in the orbit of $\gamma$ (resp.\ $\guv$).
\end{theorem}
The full version of \Cref{thm:summary} is listed as follows:
\begin{itemize}
\ii For the weighted orbital integral $\Orb(\gamma, \phi, s)$
with $\gamma \in S_3(F)\rs$ and $\phi \in \HH(S_3(F))$,
the theorems \Cref{thm:full_orbital_ell_odd,thm:full_orbital_ell_even,thm:full_orbital_ell_neg}
together cover all the cases that can arise (and cover pairwise disjoint scenarios).
\ii For the weighted orbital integral $\Orb(\guv, \phi \otimes \oneV, s)$
with $\guv \in (S_2(F) \times V'_2(F))\rs$ and $\phi \in \HH(S_3(F))$
the derivative is the single theorem \Cref{thm:semi_lie_formula}.
\end{itemize}

\subsection{Large and small kernel}
Although we were initially motivated by
\Cref{conj:inhomog} and \Cref{conj:semi_lie_spherical},
the formulas alluded to in \Cref{thm:summary} also enable to prove the following results.
In the group AFL:
\begin{theorem}
  \label{thm:large_kernel_group}
  For $n = 3$, the kernel described in \Cref{conj:large_kernel_group}
  in fact has codimension exactly $3$.
  Moreover, \Cref{conj:large_kernel_group} holds for $n = 3$;
  that is, the kernel (as a $\QQ$-vector subspace of $\HH(S_3(F))$)
  is not contained in any maximal ideal.
\end{theorem}

As we mentioned, in the semi-Lie situation the result is more complicated.
Providing evidence for \Cref{conj:kernel_semi_lie},
we will prove the following two results.
\begin{theorem}
  \label{thm:semi_lie_ker_trivial}
  For certain choices of $\gamma \in S_2(F)$,
  there doesn't exist any nonzero functions $\phi \in \HH(S_2(F))$ such that
  \[ \left. \pdv{}{s} \right\rvert_{s=0}
    \Orb \left(
      \left( \gamma, \begin{pmatrix} 0 \\ 1 \end{pmatrix}, \begin{pmatrix} 0 & \varpi^i \end{pmatrix} \right),
      \phi \otimes \oneV, s
    \right) = 0 \]
  holds for every integer $i \ge 0$.
  Thus part (a) of \Cref{conj:kernel_semi_lie} holds for $n = 2$.
\end{theorem}

\begin{theorem}
  \label{thm:semi_lie_ker_huge}
  Fix a choice of $(\uu, \vv^\top) \in V_2'(F)$ with $\vv^\top \uu \neq 0$.
  Consider all $\gamma \in S_2(F)$ for which $\guv$
  matches with an element of $(\U(\VV_n^-) \times \VV_n^-)\rs$.
  Then the set of $\phi \in \HH(S_2(F))$ such that
  \[
    \left. \pdv{}{s} \right\rvert_{s=0}
    \Orb \left( \guv, \phi \otimes \oneV, s \right) = 0
  \]
  holds for all such $\gamma$ is a $\QQ$-vector subspace of $\HH(S_2(F))$
  whose codimension is at most $v(\uu \vv^\top) + 2$.
  Moreover, the set of such $\phi$ is not contained in any maximal ideal of $\HH(S_2(F))$.
\end{theorem}

\begin{remark}
  In each case the Hecke algebra is isomorphic as a $\QQ$-algebra to $\QQ[T]$
  for a single variable $T = Y+Y^{-1}$.
  So actually it's mildly surprising that we get a result on finite codimension.
  In general, a finite codimension vector subspace of $\QQ[T]$ could
  be contained in a maximal ideal,
  such as the codimension one subspace $T \mathbb Q[T] \subset \QQ[T]$.
  Conversely, a finite \emph{dimension} vector subspace such as
  the one-dimensional space $\QQ \subseteq \QQ[T]$ is not contained in any maximal ideal.

  Thus neither of being finite codimension and generating all of $\QQ[T]$ imply each other.
  However, the author's opinion is that being finite codimension should be more surprising,
  since even a finite-dimensional $\QQ$-vector subspace of $\QQ[T]$
  (indeed, any subspace containing $1$) could still generate the entire ring $\QQ[T]$.

  In particular, we do not currently have a reason to expect that for larger $n$
  the codimension of the kernel will still be finite in $\HH(S_n(F))$,
  i.e.\ an analogous finite-codimension conjecture
  to \Cref{conj:large_kernel_group} seems possibly too optimistic.
  Nonetheless, it might still be interesting to consider different ways
  of formalizing the notion of ``large kernel'' in \Cref{conj:large_kernel_group}
  and \Cref{conj:kernel_semi_lie}.
\end{remark}

\subsection{Arithmetic fundamental lemmas}
For the group AFL, we were also able to determine the
relevant base changes in \Cref{ch:satake}.
However, we did not complete the comparison on the geometric side in this situation.
Thus we do not claim a proof of $n = 3$ of \Cref{conj:inhomog},
although we imagine such a proof could be completed
once a method for determining the intersection numbers explicitly is devised.

For the semi-Lie AFL conjectured in \Cref{conj:semi_lie_spherical},
the intersection numbers are easier to work for a few reasons.
\begin{itemize}
\ii First, one can identify $\VV_2^-$ with an $E/F$-quaternion division algebra,
equipped with a compatible Hermitian form defined via quaternion multiplication.
This makes it possible to describe $\U(\VV_2^-)$ concretely as transformations obtained
via left multiplication by an element of $E$ and right multiplication by a quaternion.
\ii Secondly, it becomes possible to describe the so-called Rapoport-Zink spaces $\RZ_2$
used in the definition of the intersection number with a Lubin-Tate space $\MM_2$.
Thus the problem of computing the intersection number
$\Int\left( (g,u), f \right) \log q$
can be reduced to calculating the intersection of certain special
Kudla-Rapoport divisors on the space $\MM_2$.

However, on the Lubin-Tate space $\MM_2$,
there is a result known as the Gross-Keating formula \cite{ref:GK}
which allows one to make this intersection number fully explicit.
One can then match the resulting equation to the formulas described in
\Cref{thm:semi_lie_derivative_single}
and verify that, under the base change \Cref{ch:satake}
and the matching condition described in \Cref{ch:rs_matching},
the two obtained formulas are identical.
\end{itemize}

We can therefore prove the following conditional result where we assume
the aforementioned divisors are given by the specific forms
\Cref{conj:serre_pullback_space} and \Cref{conj:serre_pullback_divisor}.
Then applying Gross-Keating formula enables us to prove the following result.

\begin{theorem}
  \label{thm:semi_lie_n_equals_2}
  Assume \Cref{conj:serre_pullback_space} and \Cref{conj:serre_pullback_divisor}.
  Then our generalized AFL conjecture, \Cref{conj:semi_lie_spherical}, holds for $n = 2$.
\end{theorem}
The proof of \Cref{thm:semi_lie_n_equals_2} is built up gradually
throughout the paper, culminating in \Cref{ch:finale}.

\section{Roadmap}
The rest of the paper is organized as follows.

\begin{itemize}
  \ii The paper begins with some general background information.
  \begin{itemize}
    \ii In \Cref{ch:background} we provide some preliminary background
    on the spaces appearing in the overall paper and the Hecke modules that will be used.
    \ii Further background is stated in \Cref{ch:rs_matching},
    where we describe the matching of regular semisimple elements.
    \ii In \Cref{ch:satake} we provide reminders on the Satake transform.
    We also derive concrete formulas for base change when $n = 3$
    (in comparison, the analogous results for $n=2$ are
    \cite[Lemma 7.1.1]{ref:AFLspherical}),
    but these formulas are not used again later on.
  \end{itemize}

  \ii We then proceed to introduce the orbital integrals.
  \begin{itemize}
    \ii In \Cref{ch:orbital0} we introduce the weighted orbital integral
    for the group version of the AFL for full spherical Hecke algebra,
    and state the derivative explicitly for $n = 3$ in terms of a representative.
    In \Cref{ch:orbital1,ch:orbital2} we show the calculation of this formula.

    \ii In \Cref{ch:orbitalFJ0} we introduce the weighted orbital integral
    for the semi-Lie version of the AFL for full spherical Hecke algebra,
    and state the derivative explicitly for $n = 2$ in terms of a representative.
    The analogous calculation is in \Cref{ch:orbitalFJ1,ch:orbitalFJ2}.
  \end{itemize}
  A high-level overview of the results are summarized in \Cref{thm:summary}.
  The full formulas appear in \Cref{ch:orbital2} and \Cref{ch:orbitalFJ2} respectively.
  However, later on we only need to remember the derivative at $s = 0$,
  which is stated already in \Cref{ch:orbital0} and \Cref{ch:orbitalFJ0} respectively.

  \ii Having completely computed the orbital integrals in these cases,
  we take a side trip in \Cref{ch:ker} to prove the ``large kernel'' results.
  We establish \Cref{conj:kernel_semi_lie} for $n = 2$
  by proving the explicit results
  \Cref{thm:semi_lie_ker_trivial} and \Cref{thm:semi_lie_finite_codim_full}
  (the latter shows the kernel has codimension at most $8$).

  \ii We then turn our attention to the other parts of the two versions of the AFL.
  In addition to stating the relevant definitions,
  the subsequent chapters aim to prove \Cref{thm:semi_lie_n_equals_2}.
  \begin{itemize}
    \ii In \Cref{ch:transf} we define the transfer factors $\omega \in \{\pm1\}$.
    \ii In \Cref{ch:geo}, we describe the Rapoport-Zink spaces
    that the geometric side is based on, and define the intersection numbers
    on both sides of the AFL.
    \ii In \Cref{ch:jiao}, we specialize to the situation $n = 2$
    for the intersection numbers in the semi-Lie AFL only.
    The Rapoport-Zink spaces become replaced with Lubin-Tate ones,
    and we introduce the Gross-Keating formula
    that will be our primary tool for the calculation.
    \ii In \Cref{ch:finale} we tie everything together and establish
    \Cref{thm:semi_lie_n_equals_2}.
  \end{itemize}
\end{itemize}

An approximate dependency chart between the chapters is also given in Figure~\ref{fig:depchart}.

\begin{figure}[ht]
  \begin{center}
    \begin{tikzcd}
      \text{\ref{ch:background}. Background} \ar[rd, bend left = 10] \ar[dddd, bend left = 80] && \\
      \text{\ref{ch:satake}. Base change} \ar[rd, bend left = 10] \ar[rdddd, bend left]
      & \text{\ref{ch:rs_matching}. Matching} \ar[ld] \ar[rd] \ar[l] \ar[r]
      &  \text{\ref{ch:transf}. Transfer} \ar[ldddd, bend right] \\
      \text{\ref{ch:orbital0}. Group derivative} \ar[r] \ar[d]
        & \text{\ref{ch:ker}. Large kernel} &
        \text{\ref{ch:orbitalFJ0}. Semi-Lie derivative} \ar[l] \ar[d] \ar[lddd, bend right = 20]  \\
      \text{\ref{ch:orbital1}+\ref{ch:orbital2}. Group full orbital} &&
      \text{\ref{ch:orbitalFJ1}+\ref{ch:orbitalFJ2}. Semi-Lie full orbital} \\
      \text{\ref{ch:geo}. Int numbers} \ar[d] && \\
      \text{\ref{ch:jiao}. Gross-Keating} \ar[r] & \text{\ref{ch:finale}. Prove \Cref{thm:semi_lie_n_equals_2}}
    \end{tikzcd}
  \end{center}
  \caption{Dependency chart of the chapters in this paper,
    arranged to loosely resemble the Batman logo.}
  \label{fig:depchart}
\end{figure}
